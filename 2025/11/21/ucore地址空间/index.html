<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"0x822a5b87.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.26.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"stackoverflow-light","dark":"stackoverflow-light"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="åœ¨è¿™ä¸ªç« èŠ‚ï¼Œæˆ‘ä»¬ä¼šå®ç°è™šæ‹Ÿå†…å­˜æœºåˆ¶ã€‚  ç‰©ç†ç©ºé—´å’Œè™šæ‹Ÿç©ºé—´  è™šæ‹Ÿç©ºé—´è¿ç»­ï¼Œç‰©ç†ç©ºé—´ä¸ä¸€å®šè¿ç»­ï¼  flowchart LR     %% æ ·å¼å®šä¹‰ï¼ˆé¿å¼€å…³é”®å­—ï¼Œç”¨åˆæ³•è¯­æ³•ï¼‰     classDef structStyle fill:#f0f8ff,stroke:#2c3e50,stroke-width:2px,rounded:10px     classDef vaStyle fill:#f">
<meta property="og:type" content="article">
<meta property="og:title" content="uCoreåœ°å€ç©ºé—´">
<meta property="og:url" content="https://0x822a5b87.github.io/2025/11/21/ucore%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/index.html">
<meta property="og:site_name" content="0x822a5b87çš„åšå®¢">
<meta property="og:description" content="åœ¨è¿™ä¸ªç« èŠ‚ï¼Œæˆ‘ä»¬ä¼šå®ç°è™šæ‹Ÿå†…å­˜æœºåˆ¶ã€‚  ç‰©ç†ç©ºé—´å’Œè™šæ‹Ÿç©ºé—´  è™šæ‹Ÿç©ºé—´è¿ç»­ï¼Œç‰©ç†ç©ºé—´ä¸ä¸€å®šè¿ç»­ï¼  flowchart LR     %% æ ·å¼å®šä¹‰ï¼ˆé¿å¼€å…³é”®å­—ï¼Œç”¨åˆæ³•è¯­æ³•ï¼‰     classDef structStyle fill:#f0f8ff,stroke:#2c3e50,stroke-width:2px,rounded:10px     classDef vaStyle fill:#f">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/app-as-full.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/satp.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/memory.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/addresses.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/kernel-as-high.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/kernel-as-low.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/satp.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/sv39-va-pa.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/sv39-pte.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/linear-table.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/linear-table.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/trie-1.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/sv39-full.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/address-translation.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/simple-base-bound.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/segmentation.png">
<meta property="og:image" content="https://0x822a5b87.github.io/images/20251121/page-table.png">
<meta property="article:published_time" content="2025-11-21T09:11:09.000Z">
<meta property="article:modified_time" content="2026-01-22T03:59:57.117Z">
<meta property="article:author" content="2183814023">
<meta property="article:tag" content="memory">
<meta property="article:tag" content="os">
<meta property="article:tag" content="rust">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://0x822a5b87.github.io/images/20251121/app-as-full.png">


<link rel="canonical" href="https://0x822a5b87.github.io/2025/11/21/ucore%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://0x822a5b87.github.io/2025/11/21/ucore%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/","path":"2025/11/21/ucoreåœ°å€ç©ºé—´/","title":"uCoreåœ°å€ç©ºé—´"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>uCoreåœ°å€ç©ºé—´ | 0x822a5b87çš„åšå®¢</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.10.1/mermaid.min.js","integrity":"sha256-BmQmdWDS8X2OTbrwELWK366LV6escyWhHHe0XCTU/Hk="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"all","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js" defer></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">0x822a5b87çš„åšå®¢</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">åˆ°ç å¤´æ•´ç‚¹è–¯æ¡åƒ</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="æœç´¢" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%A9%E7%90%86%E7%A9%BA%E9%97%B4%E5%92%8C%E8%99%9A%E6%8B%9F%E7%A9%BA%E9%97%B4"><span class="nav-number">1.</span> <span class="nav-text">ç‰©ç†ç©ºé—´å’Œè™šæ‹Ÿç©ºé—´</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%A1%E7%90%86sv39%E5%A4%9A%E7%BA%A7%E9%A1%B5%E8%A1%A8"><span class="nav-number">2.</span> <span class="nav-text">ç®¡ç†SV39å¤šçº§é¡µè¡¨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%A9%E7%90%86%E9%A1%B5%E5%B8%A7%E7%AE%A1%E7%90%86"><span class="nav-number">2.1.</span> <span class="nav-text">ç‰©ç†é¡µå¸§ç®¡ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E7%94%A8%E7%89%A9%E7%90%86%E9%A1%B5%E7%9A%84%E5%88%86%E9%85%8D%E4%B8%8E%E5%9B%9E%E6%94%B6"><span class="nav-number">2.1.1.</span> <span class="nav-text">å¯ç”¨ç‰©ç†é¡µçš„åˆ†é…ä¸å›æ”¶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%85%8D%E5%9B%9E%E6%94%B6%E7%89%A9%E7%90%86%E9%A1%B5%E5%B8%A7%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="nav-number">2.1.2.</span> <span class="nav-text">åˆ†é…&#x2F;å›æ”¶ç‰©ç†é¡µå¸§çš„æ¥å£</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%BA%A7%E9%A1%B5%E8%A1%A8%E7%AE%A1%E7%90%86"><span class="nav-number">2.2.</span> <span class="nav-text">å¤šçº§é¡µè¡¨ç®¡ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%B5%E8%A1%A8%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E8%AE%BF%E9%97%AE%E6%8E%A5%E5%8F%A3"><span class="nav-number">2.2.1.</span> <span class="nav-text">é¡µè¡¨åŸºæœ¬æ•°æ®ç»“æ„ä¸è®¿é—®æ¥å£</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E4%B8%AD%E8%AE%BF%E9%97%AE%E7%89%A9%E7%90%86%E9%A1%B5%E5%B8%A7%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">2.2.2.</span> <span class="nav-text">å†…æ ¸ä¸­è®¿é—®ç‰©ç†é¡µå¸§çš„æ–¹æ³•</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E5%92%8C%E6%8B%86%E9%99%A4%E8%99%9A%E5%AE%9E%E5%9C%B0%E5%9D%80%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB"><span class="nav-number">2.2.3.</span> <span class="nav-text">å»ºç«‹å’Œæ‹†é™¤è™šå®åœ°å€æ˜ å°„å…³ç³»</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E4%B8%8E%E5%BA%94%E7%94%A8%E7%9A%84%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="nav-number">3.</span> <span class="nav-text">å†…æ ¸ä¸åº”ç”¨çš„åœ°å€ç©ºé—´</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E6%8A%BD%E8%B1%A1"><span class="nav-number">3.1.</span> <span class="nav-text">å®ç°åœ°å€ç©ºé—´æŠ½è±¡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E6%AE%B5%E4%B8%80%E6%AE%B5%E8%BF%9E%E7%BB%AD%E5%9C%B0%E5%9D%80%E7%9A%84%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98"><span class="nav-number">3.1.1.</span> <span class="nav-text">é€»è¾‘æ®µï¼šä¸€æ®µè¿ç»­åœ°å€çš„è™šæ‹Ÿå†…å­˜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E4%B8%80%E7%B3%BB%E5%88%97%E6%9C%89%E5%85%B3%E8%81%94%E7%9A%84%E9%80%BB%E8%BE%91%E6%AE%B5"><span class="nav-number">3.1.2.</span> <span class="nav-text">åœ°å€ç©ºé—´ï¼šä¸€ç³»åˆ—æœ‰å…³è”çš„é€»è¾‘æ®µ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="nav-number">3.1.3.</span> <span class="nav-text">å†…æ ¸åœ°å€ç©ºé—´</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="nav-number">3.2.</span> <span class="nav-text">åº”ç”¨åœ°å€ç©ºé—´</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-trampoline"><span class="nav-number">3.2.1.</span> <span class="nav-text">åˆå§‹åŒ– trampoline</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8Eelf%E5%88%9D%E5%A7%8B%E5%8C%96.text.rodata.data.bss"><span class="nav-number">3.2.2.</span> <span class="nav-text">ä»elfåˆå§‹åŒ–.text&#x2F;.rodata&#x2F;.data&#x2F;.bss</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E9%83%A8%E5%88%86%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">3.2.3.</span> <span class="nav-text">å…¶ä»–éƒ¨åˆ†åˆå§‹åŒ–</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E7%9A%84%E5%88%86%E6%97%B6%E5%A4%9A%E4%BB%BB%E5%8A%A1"><span class="nav-number">4.</span> <span class="nav-text">åŸºäºåœ°å€ç©ºé—´çš„åˆ†æ—¶å¤šä»»åŠ¡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E5%B9%B6%E5%BC%80%E5%90%AF%E5%9F%BA%E4%BA%8E%E5%88%86%E9%A1%B5%E6%A8%A1%E5%BC%8F%E7%9A%84%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="nav-number">4.1.</span> <span class="nav-text">å»ºç«‹å¹¶å¼€å¯åŸºäºåˆ†é¡µæ¨¡å¼çš„è™šæ‹Ÿåœ°å€ç©ºé—´</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%86%85%E6%A0%B8%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="nav-number">4.1.1.</span> <span class="nav-text">åˆ›å»ºå†…æ ¸åœ°å€ç©ºé—´</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#trampoline%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.2.</span> <span class="nav-text">trampolineçš„å®ç°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rcore-%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E6%8B%93%E5%B1%95%E5%AE%9E%E7%8E%B0"><span class="nav-number">5.</span> <span class="nav-text">rCore-åœ°å€ç©ºé—´æ‹“å±•å®ç°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sys_get_time"><span class="nav-number">5.1.</span> <span class="nav-text">sys_get_time</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#serialize_struct"><span class="nav-number">5.1.1.</span> <span class="nav-text">serialize_struct</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#serializetobytes"><span class="nav-number">5.1.2.</span> <span class="nav-text">SerializeToBytes</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sys_trace"><span class="nav-number">5.2.</span> <span class="nav-text">sys_trace</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#read"><span class="nav-number">5.2.1.</span> <span class="nav-text">read</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#write"><span class="nav-number">5.2.2.</span> <span class="nav-text">write</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#auth_check"><span class="nav-number">5.2.3.</span> <span class="nav-text">auth_check</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#translate_entries"><span class="nav-number">5.2.4.</span> <span class="nav-text">translate_entries</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mmap-%E5%92%8C-munmap"><span class="nav-number">5.3.</span> <span class="nav-text">mmap å’Œ munmap</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#insert_mapped_area"><span class="nav-number">5.3.1.</span> <span class="nav-text">insert_mapped_area</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#delete_mapped_area"><span class="nav-number">5.3.2.</span> <span class="nav-text">delete_mapped_area</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#qa"><span class="nav-number">6.</span> <span class="nav-text">QA</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#trapcontext%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">6.1.</span> <span class="nav-text">TrapContextçš„åˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sscratch"><span class="nav-number">6.2.</span> <span class="nav-text">sscratch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#restore_va"><span class="nav-number">6.3.</span> <span class="nav-text">restore_va</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#linker.ld"><span class="nav-number">6.4.</span> <span class="nav-text">linker.ld</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#m-%E6%A8%A1%E5%BC%8F%E5%90%AF%E5%8A%A8%E5%8A%A0%E8%BD%BD"><span class="nav-number">6.4.1.</span> <span class="nav-text">M æ¨¡å¼å¯åŠ¨åŠ è½½</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A0%86%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">6.5.</span> <span class="nav-text">å †çš„åˆå§‹åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89%E4%B8%AA%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="nav-number">6.5.1.</span> <span class="nav-text">ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#global_allocator"><span class="nav-number">6.5.2.</span> <span class="nav-text">#[global_allocator]</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#heap_space%E5%92%8Cheap_allocator"><span class="nav-number">6.5.3.</span> <span class="nav-text">HEAP_SPACEå’ŒHEAP_ALLOCATOR</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lazy_static"><span class="nav-number">6.6.</span> <span class="nav-text">lazy_static</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#elf%E6%96%87%E4%BB%B6%E7%9A%84va%E5%92%8Cpa"><span class="nav-number">6.7.</span> <span class="nav-text">elfæ–‡ä»¶çš„VAå’ŒPA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sbrk"><span class="nav-number">6.8.</span> <span class="nav-text">sbrk</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#trampoline"><span class="nav-number">6.9.</span> <span class="nav-text">trampoline</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%B6%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="nav-number">6.9.1.</span> <span class="nav-text">é›¶ã€ç³»ç»Ÿè°ƒç”¨çš„æµç¨‹</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BF%85%E9%A1%BB%E6%9C%89-trampoline"><span class="nav-number">6.9.2.</span> <span class="nav-text">ä¸€ã€ä¸ºä»€ä¹ˆå¿…é¡»æœ‰ trampolineï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E6%A0%88%E5%92%8C%E5%BA%94%E7%94%A8%E5%86%85%E6%A0%B8%E6%A0%88%E4%BB%A5%E5%8F%8A%E5%86%85%E6%A0%B8%E6%A0%88"><span class="nav-number">6.10.</span> <span class="nav-text">åº”ç”¨æ ˆå’Œåº”ç”¨å†…æ ¸æ ˆä»¥åŠå†…æ ¸æ ˆ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sv39%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="nav-number">6.11.</span> <span class="nav-text">SV39æ¨¡å¼ä¸‹çš„åœ°å€ç©ºé—´</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E5%88%B0%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98"><span class="nav-number">6.12.</span> <span class="nav-text">è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E6%80%81%E7%9A%84%E5%88%86%E9%A1%B5%E9%80%BB%E8%BE%91"><span class="nav-number">6.12.1.</span> <span class="nav-text">å†…æ ¸æ€çš„åˆ†é¡µé€»è¾‘</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E6%A0%B8%E6%80%81%E9%9C%80%E8%A6%81%E6%98%A0%E5%B0%84%E7%9A%84%E7%89%A9%E7%90%86%E9%A1%B5%E5%85%B7%E4%BD%93%E6%9C%89%E5%93%AA%E4%BA%9B"><span class="nav-number">6.12.2.</span> <span class="nav-text">å†…æ ¸æ€éœ€è¦æ˜ å°„çš„ç‰©ç†é¡µå…·ä½“æœ‰å“ªäº›</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%BB%BA%E7%AB%8B%E6%98%A0%E5%B0%84"><span class="nav-number">6.12.3.</span> <span class="nav-text">å¦‚ä½•å»ºç«‹æ˜ å°„</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#physpagenum%E5%92%8Cframetracker"><span class="nav-number">6.13.</span> <span class="nav-text">PhysPageNumå’ŒFrameTracker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%9A%84%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4%E5%92%8C%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4"><span class="nav-number">6.14.</span> <span class="nav-text">å†…å­˜çš„å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#from-%E5%92%8C-into"><span class="nav-number">6.15.</span> <span class="nav-text">from å’Œ into</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sv39%E5%A4%9A%E7%BA%A7%E9%A1%B5%E8%A1%A8%E7%9A%84%E7%A1%AC%E4%BB%B6%E5%9F%BA%E5%9D%80"><span class="nav-number">6.16.</span> <span class="nav-text">SV39å¤šçº§é¡µè¡¨çš„ç¡¬ä»¶åŸºå€</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%B0%E5%9D%80%E6%A0%BC%E5%BC%8F%E4%B8%8E%E7%BB%84%E6%88%90"><span class="nav-number">6.16.1.</span> <span class="nav-text">åœ°å€æ ¼å¼ä¸ç»„æˆ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%B5%E8%A1%A8%E9%A1%B9%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%8A%BD%E8%B1%A1%E4%B8%8E%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89"><span class="nav-number">6.16.2.</span> <span class="nav-text">é¡µè¡¨é¡¹çš„æ•°æ®ç»“æ„æŠ½è±¡ä¸ç±»å‹å®šä¹‰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98%E7%9A%84%E9%A1%B5%E7%BD%AE%E6%8D%A2%E7%AE%97%E6%B3%95"><span class="nav-number">6.17.</span> <span class="nav-text">å…¨å±€ç‰©ç†å†…å­˜çš„é¡µç½®æ¢ç®—æ³•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E9%A1%B5%E9%9D%A2%E6%8D%A2%E5%87%BA"><span class="nav-number">6.18.</span> <span class="nav-text">ä¼˜åŒ–é¡µé¢æ¢å‡º</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E9%A1%B5%E9%9D%A2%E7%BD%AE%E6%8D%A2"><span class="nav-number">6.18.1.</span> <span class="nav-text">ä¼˜åŒ–é¡µé¢ç½®æ¢</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0cow"><span class="nav-number">6.18.2.</span> <span class="nav-text">å®ç°COW</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%BA%A7%E9%A1%B5%E8%A1%A8"><span class="nav-number">6.19.</span> <span class="nav-text">å¤šçº§é¡µè¡¨</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E7%BA%A7%E9%A1%B5%E8%A1%A8%E7%BA%BF%E6%80%A7%E8%A1%A8"><span class="nav-number">6.19.1.</span> <span class="nav-text">å•çº§é¡µè¡¨&#x2F;çº¿æ€§è¡¨</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E5%85%B8%E6%A0%91"><span class="nav-number">6.19.2.</span> <span class="nav-text">å­—å…¸æ ‘</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%A7%E8%A1%A8"><span class="nav-number">6.20.</span> <span class="nav-text">å¤§è¡¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sv39%E8%BD%AC%E6%8D%A2%E8%BF%87%E7%A8%8B"><span class="nav-number">6.21.</span> <span class="nav-text">SV39è½¬æ¢è¿‡ç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E7%9A%84%E4%B8%80%E4%BA%9B%E7%A4%BA%E4%BE%8B"><span class="nav-number">6.22.</span> <span class="nav-text">å†…å­˜ç®¡ç†çš„ä¸€äº›ç¤ºä¾‹</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E6%AE%B5%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-number">6.22.1.</span> <span class="nav-text">åˆ†æ®µå†…å­˜ç®¡ç†</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="nav-number">6.22.2.</span> <span class="nav-text">åˆ†é¡µå†…å­˜ç®¡ç†</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E6%A6%82%E8%BF%B0"><span class="nav-number">6.23.</span> <span class="nav-text">ä»£ç æ¦‚è¿°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9"><span class="nav-number">6.24.</span> <span class="nav-text">ä»£ç ä¿®æ”¹</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">2183814023</p>
  <div class="site-description" itemprop="description">åˆ°ç å¤´æ•´ç‚¹è–¯æ¡åƒ</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">45</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">æ ‡ç­¾</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://0x822a5b87.github.io/2025/11/21/ucore%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="2183814023">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="0x822a5b87çš„åšå®¢">
      <meta itemprop="description" content="åˆ°ç å¤´æ•´ç‚¹è–¯æ¡åƒ">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="uCoreåœ°å€ç©ºé—´ | 0x822a5b87çš„åšå®¢">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          uCoreåœ°å€ç©ºé—´
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2025-11-21 17:11:09" itemprop="dateCreated datePublished" datetime="2025-11-21T17:11:09+08:00">2025-11-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">æ›´æ–°äº</span>
      <time title="ä¿®æ”¹æ—¶é—´ï¼š2026-01-22 11:59:57" itemprop="dateModified" datetime="2026-01-22T11:59:57+08:00">2026-01-22</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><blockquote>
<p>åœ¨è¿™ä¸ªç« èŠ‚ï¼Œæˆ‘ä»¬ä¼šå®ç°è™šæ‹Ÿå†…å­˜æœºåˆ¶ã€‚</p>
</blockquote>
<h2 id="ç‰©ç†ç©ºé—´å’Œè™šæ‹Ÿç©ºé—´">ç‰©ç†ç©ºé—´å’Œè™šæ‹Ÿç©ºé—´</h2>
<blockquote>
<p>è™šæ‹Ÿç©ºé—´è¿ç»­ï¼Œç‰©ç†ç©ºé—´ä¸ä¸€å®šè¿ç»­ï¼</p>
</blockquote>
<pre><code class="highlight mermaid">flowchart LR
    %% æ ·å¼å®šä¹‰ï¼ˆé¿å¼€å…³é”®å­—ï¼Œç”¨åˆæ³•è¯­æ³•ï¼‰
    classDef structStyle fill:#f0f8ff,stroke:#2c3e50,stroke-width:2px,rounded:10px
    classDef vaStyle fill:#fdf2f8,stroke:#9b59b6,stroke-width:2px,rounded:10px
    classDef vpnStyle fill:#fef7fb,stroke:#9b59b6,stroke-width:1px,rounded:8px,padding:10px
    classDef paStyle fill:#e8f4f8,stroke:#3498db,stroke-width:2px,rounded:10px
    classDef ppnStyle fill:#f0f8ff,stroke:#3498db,stroke-width:1px,rounded:8px,padding:10px
    classDef fieldStyle font-weight:bold,color:#2c3e50
    classDef connStyle stroke:#7f8c8d,stroke-width:1.5px,arrowheadStyle:fill:#7f8c8d

    %% ä¸Šå±‚ï¼šç»“æ„ä½“ï¼ˆè¿ç»­å­—æ®µï¼‰
    subgraph Struct[&quot;ğŸ“¦ TimeVal ç»“æ„ä½“ï¼ˆè¿ç»­è™šæ‹Ÿå†…å­˜è§†å›¾ï¼‰&quot;]
        direction TB
        sec[&quot;&lt;span class=&#x27;fieldStyle&#x27;&gt;sec&lt;/span&gt;&lt;br/&gt;usize (8å­—èŠ‚)&quot;]:::fieldStyle
        usec[&quot;&lt;span class=&#x27;fieldStyle&#x27;&gt;usec&lt;/span&gt;&lt;br/&gt;usize (8å­—èŠ‚)&quot;]:::fieldStyle
    end
    class Struct structStyle

    %% ä¸­å±‚ï¼šè™šæ‹Ÿåœ°å€ VAï¼ˆè¿ç»­ï¼Œè·¨2ä¸ªè™šæ‹Ÿé¡µï¼‰
    subgraph VA[&quot;ğŸŒ è™šæ‹Ÿåœ°å€ VAï¼ˆè¿ç»­ï¼‰&quot;]
        direction LR
        subgraph VPN0[&quot;VPN0ï¼ˆè™šæ‹Ÿé¡µ0ï¼‰&quot;]
            %% ä¿®æ­£ï¼šsec ä½äº VPN0 æœ«å°¾ï¼ŒVA = é¡µèµ·å§‹ + (4KB-8) = 0x40200000 + 0xFF8 = 0x40200FF8
            va_sec[&quot;0x40200FF8&lt;br/&gt;[é¡µå†…åç§»: 0xFF8 = 4KB-8]&quot;]
        end
        subgraph VPN1[&quot;VPN1ï¼ˆè™šæ‹Ÿé¡µ1ï¼‰&quot;]
            %% ä¿®æ­£ï¼šusec ä½äº VPN1 èµ·å§‹ï¼Œé¡µå†…åç§» 0x000
            va_usec[&quot;0x40201000&lt;br/&gt;[é¡µå†…åç§»: 0x000]&quot;]
        end
        note_va[&quot;é¡µå¤§å°ï¼š4KB (0x1000)&lt;br/&gt;VPN0èŒƒå›´ï¼š0x40200000~0x40200FFF&lt;br/&gt;VPN1èŒƒå›´ï¼š0x40201000~0x40201FFF&quot;]
        class note_va vaStyle
    end
    class VA vaStyle

    %% ä¸‹å±‚ï¼šç‰©ç†åœ°å€ PAï¼ˆç¦»æ•£ï¼‰
    subgraph PA[&quot;ğŸ’¾ ç‰©ç†åœ°å€ PAï¼ˆç¦»æ•£ï¼‰&quot;]
        subgraph PPN0[&quot;PPN0ï¼ˆç‰©ç†é¡µ0ï¼‰&quot;]
            %% ç‰©ç†é¡µ0èµ·å§‹ + åç§»0xFF8 = 0x8000 + 0xFF8 = 0x8FF8
            pa_sec[&quot;0x8FF8&lt;br/&gt;[é¡µå†…åç§»: 0xFF8]&quot;]
        end
        subgraph PPN1[&quot;PPN1ï¼ˆç‰©ç†é¡µ1ï¼‰&quot;]
            %% ç‰©ç†é¡µ1èµ·å§‹ + åç§»0x000 = 0x4000 + 0x000 = 0x4000
            pa_usec[&quot;0x4000&lt;br/&gt;[é¡µå†…åç§»: 0x000]&quot;]
        end
        note_pa[&quot;ç‰©ç†é¡µç‹¬ç«‹åˆ†é…ï¼Œåœ°å€ä¸è¿ç»­&lt;br/&gt;PPN0èŒƒå›´ï¼š0x8000~0x8FFF&lt;br/&gt;PPN1èŒƒå›´ï¼š0x4000~0x4FFF&quot;]
        class note_pa paStyle
    end
    class PA paStyle

    %% æ˜ å°„å…³ç³»ï¼ˆå­—æ®µ â†’ VA â†’ PAï¼‰
    sec -.-&gt;|å­—æ®µå¯¹åº”VA| va_sec:::connStyle
    usec -.-&gt;|å­—æ®µå¯¹åº”VA| VPN1:::connStyle
    va_sec -.-&gt;|é¡µè¡¨ç¿»è¯‘ï¼ˆVPN0â†’PPN0ï¼‰| pa_sec:::connStyle
    va_usec -.-&gt;|é¡µè¡¨ç¿»è¯‘ï¼ˆVPN1â†’PPN1ï¼‰| pa_usec:::connStyle

    %% æ ¸å¿ƒç»“è®ºæ ‡æ³¨ï¼ˆçªå‡ºé—®é¢˜ï¼‰
    conclusion[&quot;âš ï¸  æ ¸å¿ƒé—®é¢˜ï¼š&lt;br/&gt;ç»“æ„ä½“VAè¿ç»­ï¼ˆè·¨é¡µè¾¹ç•Œï¼‰ï¼Œä½†æ˜ å°„çš„PAç¦»æ•£&lt;br/&gt;å†…æ ¸éœ€æ‹†ä¸º2æ®µå†™å…¥ï¼š&lt;br/&gt;1. PPN0çš„0x8FF8~0x8FFFï¼ˆ6å­—èŠ‚ï¼Ÿä¸ï¼Œ8å­—èŠ‚åˆšå¥½ï¼‰&lt;br/&gt;2. PPN1çš„0x4000~0x4007&quot;]:::structStyle
    PA -.-&gt;|ä½“ç°| conclusion:::connStyle</code></pre>
<h2 id="ç®¡ç†sv39å¤šçº§é¡µè¡¨">ç®¡ç†SV39å¤šçº§é¡µè¡¨</h2>
<h3 id="ç‰©ç†é¡µå¸§ç®¡ç†">ç‰©ç†é¡µå¸§ç®¡ç†</h3>
<pre><code class="highlight mermaid">flowchart TD
    %% åˆå§‹åŒ–é˜¶æ®µï¼šå»¶è¿ŸåŠ è½½ï¼ˆé¦–æ¬¡è®¿é—®æ—¶è§¦å‘ï¼‰
    A[&quot;å†…æ ¸å¯åŠ¨å®Œæˆï¼Œè¿›å…¥è¿è¡Œé˜¶æ®µ&quot;] --&gt; B&#123;&quot;é¦–æ¬¡è°ƒç”¨ frame_alloc() / é¦–æ¬¡è®¿é—® FRAME_ALLOCATORï¼Ÿ&quot;&#125;
    B --&gt;|æ˜¯| C[&quot;lazy_static! è§¦å‘å»¶è¿Ÿåˆå§‹åŒ–&quot;]
    C --&gt; D[&quot;è°ƒç”¨ FrameAllocatorImpl::new() åˆ›å»ºåˆ†é…å™¨å®ä¾‹&quot;]
    D --&gt; E[&quot;è°ƒç”¨ init(l: PhysPageNum, r: PhysPageNum)&quot;]
    E --&gt; F[&quot;è®¾ç½®ç©ºé—²ç‰©ç†é¡µèŒƒå›´ï¼šcurrent=ekernelï¼ˆå†…æ ¸ç»“æŸé¡µï¼‰ï¼Œend=MEMORY_ENDï¼ˆç‰©ç†å†…å­˜ç»“æŸé¡µï¼‰&quot;]
    F --&gt; G[&quot;FRAME_ALLOCATOR åˆå§‹åŒ–å®Œæˆï¼ˆå­˜å…¥ UPSafeCell ä¸­ï¼‰&quot;]
    
    %% éé¦–æ¬¡è®¿é—®ï¼šç›´æ¥ä½¿ç”¨å·²åˆå§‹åŒ–çš„åˆ†é…å™¨
    B --&gt;|å¦| G[&quot;ç›´æ¥ä½¿ç”¨å·²åˆå§‹åŒ–çš„ FRAME_ALLOCATORï¼ˆä» UPSafeCell å–å‡ºï¼‰&quot;]

    %% åˆ†é…æµç¨‹ï¼šå†…æ ¸/ç”¨æˆ·ç”³è¯·ç‰©ç†å†…å­˜
    G --&gt; H[&quot;å†…æ ¸æ¨¡å—/ç”¨æˆ·è¿›ç¨‹è°ƒç”¨ frame_alloc()&quot;]
    H --&gt; I[&quot;é€šè¿‡ UPSafeCell è·å– FRAME_ALLOCATOR å¯å˜å¼•ç”¨ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰&quot;]
    I --&gt; J[&quot;è°ƒç”¨ FrameAllocatorImpl::alloc()&quot;]
    
    %% åˆ†é…é€»è¾‘åˆ†æ”¯ï¼šä¼˜å…ˆå›æ”¶æ± ï¼Œå†æ–°åˆ†é…
    J --&gt; K&#123;&quot;å›æ”¶æ±  recycled éç©ºï¼Ÿ&quot;&#125;
    K --&gt;|æ˜¯| L[&quot;å¼¹å‡ºå›æ”¶æ± ä¸­çš„ PhysPageNum&quot;]
    K --&gt;|å¦| M&#123;&quot;current &lt; endï¼Ÿ&quot;&#125;
    M --&gt;|æ˜¯| N[&quot;åˆ†é… current å¯¹åº”çš„ PhysPageNumï¼Œcurrent += 1&quot;]
    M --&gt;|å¦| O[&quot;åˆ†é…å¤±è´¥ï¼Œè¿”å› None&quot;]
    
    %% å°è£…ä¸º RAII å¥æŸ„
    L --&gt; P[&quot;å°† PhysPageNum å°è£…ä¸º FrameTrackerï¼ˆæŒæœ‰å”¯ä¸€æ‰€æœ‰æƒï¼‰&quot;]
    N --&gt; P
    P --&gt; Q[&quot;é‡Šæ”¾ UPSafeCell å¼•ç”¨ï¼Œè¿”å› FrameTracker ç»™è°ƒç”¨æ–¹&quot;]
    Q --&gt; R[&quot;è°ƒç”¨æ–¹ä½¿ç”¨ FrameTracker&quot;]
    R --&gt; S[&quot;é€šè¿‡ FrameTracker.ppn() è·å– PhysPageNum&quot;]
    S --&gt; T[&quot;å°† PhysPageNum è½¬ä¸º PhysAddrï¼Œç”¨äºé¡µè¡¨æ˜ å°„ï¼ˆVAâ†’PAï¼‰æˆ–ç›´æ¥æ“ä½œç‰©ç†å†…å­˜&quot;]

    %% è‡ªåŠ¨é‡Šæ”¾æµç¨‹ï¼šRAII æ ¸å¿ƒï¼ˆæ— éœ€æ‰‹åŠ¨è°ƒç”¨ï¼‰
    R --&gt; U[&quot;FrameTracker ç¦»å¼€ä½œç”¨åŸŸï¼ˆå¦‚å˜é‡å¤±æ•ˆã€å‡½æ•°è¿”å›ï¼‰&quot;]
    U --&gt; V[&quot;è§¦å‘ FrameTracker::Drop å®ç°&quot;]
    V --&gt; W[&quot;é€šè¿‡ UPSafeCell è·å– FRAME_ALLOCATOR å¯å˜å¼•ç”¨&quot;]
    W --&gt; X[&quot;è°ƒç”¨ FrameAllocatorImpl::dealloc(ppn)&quot;]
    X --&gt; Y[&quot;å°† PhysPageNum å­˜å…¥ recycled å›æ”¶æ± &quot;]
    Y --&gt; Z[&quot;é‡Šæ”¾ UPSafeCell å¼•ç”¨ï¼Œç‰©ç†é¡µå¸§å›å½’ç©ºé—²çŠ¶æ€&quot;]

    %% æ‰‹åŠ¨é‡Šæ”¾æµç¨‹ï¼ˆå¯é€‰åˆ†æ”¯ï¼‰
    R --&gt; AA&#123;&quot;è°ƒç”¨æ–¹ä¸»åŠ¨è°ƒç”¨ frame_dealloc(frame: FrameTracker)&quot;&#125;
    AA --&gt;|æ˜¯| AB[&quot;FrameTracker è½¬ç§»æ‰€æœ‰æƒåˆ°æ¨¡å—&quot;]
    %% å¤ç”¨è‡ªåŠ¨é‡Šæ”¾çš„åç»­é€»è¾‘
    AB --&gt; W[&quot;é€šè¿‡ UPSafeCell è·å– FRAME_ALLOCATOR å¯å˜å¼•ç”¨&quot;]
    AA --&gt;|å¦| U[&quot;ç­‰å¾…è‡ªåŠ¨é‡Šæ”¾&quot;]

    %% æ ·å¼ä¼˜åŒ–ï¼ˆå¢å¼ºå¯è¯»æ€§ï¼‰
    classDef lazy_init fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef alloc fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef free fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef error fill:#ffebee,stroke:#b71c1c,stroke-width:2px

    class A,B,C,D,E,F,G lazy_init
    class H,I,J,K,L,M,N,O,P,Q,R,S,T alloc
    class U,V,W,X,Y,Z,AA,AB free
    class O error</code></pre>
<p>ç‰©ç†é¡µå¸§å­˜æ”¾çš„æ•°æ®ä»å†…å®¹ä¸Šæ¥è¯´åˆ†ä¸ºä¸¤ç§ï¼š</p>
<ol type="1">
<li>åº”ç”¨/å†…æ ¸çš„æ•°æ®æˆ–è€…ä»£ç ï¼›</li>
<li>åº”ç”¨/å†…æ ¸çš„å¤šçº§é¡µè¡¨ï¼›</li>
</ol>
<p>æœ¬è´¨ä¸Šï¼Œç‰©ç†é¡µå¸§çš„æ ¸å¿ƒæ˜¯ â€œå­˜å‚¨å•å…ƒâ€â€”â€”
æ— è®ºå­˜æ”¾çš„æ˜¯ä»£ç ã€åº”ç”¨æ•°æ®ï¼Œè¿˜æ˜¯é¡µè¡¨æœ¬èº«ï¼Œåœ¨ç‰©ç†å†…å­˜å±‚é¢éƒ½æ˜¯
â€œäºŒè¿›åˆ¶æ•°æ®å—â€ï¼Œé¡µè¡¨åªæ˜¯ â€œå…·æœ‰ç‰¹æ®Šç”¨é€”çš„æ•°æ®â€ï¼ˆç”¨äºåœ°å€è½¬æ¢çš„
â€œæ˜ å°„è¡¨æ•°æ®â€ï¼‰</p>
<h4 id="å¯ç”¨ç‰©ç†é¡µçš„åˆ†é…ä¸å›æ”¶">å¯ç”¨ç‰©ç†é¡µçš„åˆ†é…ä¸å›æ”¶</h4>
<pre><code class="highlight mermaid">flowchart TB
%% æ ·å¼å®šä¹‰ï¼šåŒºåˆ†ç±»å‹ã€Traitã€å®ä¾‹ã€æ¨¡å—ã€å±‚çº§ï¼Œæå‡å¯è¯»æ€§
    classDef type fill:#e8f4f8, stroke:#2563eb, rounded:8px, font-weight:600, font-size:12px;
    classDef trait fill:#fdf2f8, stroke:#9f7aea, rounded:8px, font-weight:600, font-size:12px;
    classDef instance fill:#e8f5e8, stroke:#2e7d32, rounded:8px, font-weight:600, font-size:12px;
    classDef module fill:#f8fafc, stroke:#94a3b8, rounded:8px, font-size:12px;
    classDef layer fill:#fef2f8, stroke:#f43f5e, rounded:8px, font-size:12px;
    classDef arrow stroke:#64748b, stroke-width:1.5px, font-size:11px;
    classDef raii_arrow stroke:#e11d48, stroke-width:2px, font-style:italic, font-size:11px;

%% æ ¸å¿ƒåŸºç¡€ç±»å‹ï¼ˆåœ°å€/é¡µå·æŠ½è±¡ï¼‰
    PhysAddr[&quot;PhysAddr&lt;br/&gt;ç‰©ç†åœ°å€&quot;]:::type
    VirtAddr[&quot;VirtAddr&lt;br/&gt;è™šæ‹Ÿåœ°å€&quot;]:::type
    PhysPageNum[&quot;PhysPageNum&lt;br/&gt;ç‰©ç†é¡µå·&quot;]:::type
    VirtPageNum[&quot;VirtPageNum&lt;br/&gt;è™šæ‹Ÿé¡µå·&quot;]:::type

%% æ ¸å¿ƒç®¡ç†ç»„ä»¶ï¼ˆTrait + å®ç° + å…¨å±€å®ä¾‹ + RAIIå°è£…ï¼‰
    FrameAllocator[&quot;FrameAllocator&lt;br/&gt;ç‰©ç†é¡µå¸§åˆ†é…å™¨Trait&lt;br/&gt;&#123;alloc(), dealloc()&#125;&quot;]:::trait
    StackFrameAllocator[&quot;StackFrameAllocator&lt;br/&gt;FrameAllocatorå®ç°&quot;]:::type
    FRAME_ALLOCATOR[&quot;FRAME_ALLOCATOR&lt;br/&gt;å…¨å±€å”¯ä¸€å®ä¾‹&lt;br/&gt;(StackFrameAllocator)&quot;]:::instance
    FrameTracker[&quot;FrameTracker&lt;br/&gt;RAIIç‰©ç†é¡µæŒæœ‰è€…&quot;]:::type

%% æ¨¡å—ã€å±‚çº§ç»“æ„
    allocator[&quot;frame_allocator.rs&lt;br/&gt;æ¨¡å—&lt;br/&gt;&#123;frame_alloc(), frame_dealloc()&#125;&quot;]:::module

    subgraph é¡µè¡¨ç®¡ç†[PageTable é¡µè¡¨]
        direction LR
        root_ppn[&quot;root_ppn&lt;br/&gt;æ ¹é¡µå·&quot;]:::type
        subgraph é¡µè¡¨å¸§é›†åˆ[é¡µè¡¨å¸§é›†åˆ]
            direction LR
            FT0[&quot;FrameTracker0&quot;]:::type
            FT1[&quot;...&quot;]:::type
            FTn[&quot;FrameTracker511&quot;]:::type
        end
        root_ppn --&gt; é¡µè¡¨å¸§é›†åˆ
    end

    subgraph ç”¨æˆ·å±‚[ç”¨æˆ·åº”ç”¨]
        vm1[&quot;ç”¨æˆ·åº”ç”¨1&lt;br/&gt;è™šæ‹Ÿå†…å­˜ç©ºé—´&quot;]:::layer
        vm2[&quot;ç”¨æˆ·åº”ç”¨2&lt;br/&gt;è™šæ‹Ÿå†…å­˜ç©ºé—´&quot;]:::layer
    end

    subgraph ç¡¬ä»¶å±‚[PCç¡¬ä»¶]
        memory[&quot;ç¡¬ä»¶å†…å­˜&lt;br/&gt;ç‰©ç†åœ°å€ç©ºé—´&quot;]:::layer
    end

%% 1. åœ°å€â†’é¡µå·çš„åŸºç¡€è½¬æ¢ï¼ˆè½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼‰
    VirtAddr -.-&gt;|&quot;into() è½¬æ¢&quot;| VirtPageNum:::arrow
    PhysAddr -.-&gt;|&quot;into() è½¬æ¢&quot;| PhysPageNum:::arrow

%% 2. è™šæ‹Ÿåœ°å€ä¸åº”ç”¨/é¡µè¡¨çš„å…³è”
    vm1 --&gt;|&quot;ä½¿ç”¨&quot;| VirtAddr:::arrow
    vm2 --&gt;|&quot;ä½¿ç”¨&quot;| VirtAddr:::arrow
    VirtPageNum -.-&gt;|&quot;é€šè¿‡é¡µè¡¨æ˜ å°„&quot;| é¡µè¡¨ç®¡ç†:::arrow

%% 3. åˆ†é…å™¨Traitâ†’å®ç°â†’å…¨å±€å®ä¾‹çš„ä¾èµ–é“¾
    FrameAllocator --&gt;|&quot;è¢«å®ç°&quot;| StackFrameAllocator:::arrow
    StackFrameAllocator --&gt;|&quot;å»¶è¿ŸåŠ è½½åˆå§‹åŒ–&quot;| FRAME_ALLOCATOR:::arrow
    FRAME_ALLOCATOR --&gt;|&quot;å½’å±&quot;| allocator:::arrow

%% 4. æ ¸å¿ƒåˆ†é…æµç¨‹ï¼ˆçªå‡ºæ¨¡å—æ¥å£ + RAIIå°è£…ï¼‰
    allocator --&gt;|&quot;frame_alloc() å¯¹å¤–æ¥å£&quot;| FRAME_ALLOCATOR:::arrow
    FRAME_ALLOCATOR --&gt;|&quot;alloc() åˆ†é…ç‰©ç†é¡µå·&quot;| PhysPageNum:::arrow
    PhysPageNum --&gt;|&quot;wrap å°è£…ä¸ºRAIIæŒæœ‰è€…&quot;| FrameTracker:::arrow

%% 5. RAIIè‡ªåŠ¨å›æ”¶æµç¨‹ï¼ˆé«˜äº®æ ¸å¿ƒç‰¹æ€§ï¼‰
    FrameTracker -.-&gt;|&quot;drop() è‡ªåŠ¨è§¦å‘&quot;| allocator:::raii_arrow
    allocator -.-&gt;|&quot;frame_dealloc() å†…éƒ¨è°ƒç”¨&quot;| FRAME_ALLOCATOR:::raii_arrow
    FRAME_ALLOCATOR -.-&gt;|&quot;dealloc() å›æ”¶ç‰©ç†é¡µå·&quot;| PhysPageNum:::raii_arrow

%% 6. ç‰©ç†é¡µä¸ç¡¬ä»¶/é¡µè¡¨çš„ç»‘å®š
    FrameTracker --&gt;|&quot;æŒæœ‰å¹¶æ˜ å°„ä¸º&quot;| é¡µè¡¨å¸§é›†åˆ:::arrow
    PhysPageNum --&gt;|&quot;å¯¹åº”&quot;| PhysAddr:::arrow
    PhysAddr --&gt;|&quot;æ˜ å°„åˆ°&quot;| memory:::arrow
    é¡µè¡¨ç®¡ç† -.-&gt;|&quot;ç¿»è¯‘è™šæ‹Ÿåœ°å€å¾—åˆ°&quot;| PhysAddr:::arrow</code></pre>
<blockquote>
<p>åŒºåˆ†å†…æ ¸ç©ºé—´å’Œç‰©ç†ç©ºé—´å¯ä»¥å‚è€ƒ <a
href="#å†…å­˜çš„å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´">å†…å­˜çš„å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´</a></p>
</blockquote>
<p>ç‰©ç†é¡µçš„å®é™…å¤§å°ï¼Œç”±ä¸‰ä¸ªå‚æ•°å…±åŒå†³å®šã€‚ä»–ä»¬å¤§å°ä»ä¹Ÿæ˜¯
<code>virt memory</code> &lt; <code>ekernel</code> &lt;
<code>MEMORY_END</code>ã€‚<strong>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸‰ä¸ªå€¼éƒ½æ˜¯ç‰©ç†åœ°å€è€Œéè™šæ‹Ÿåœ°å€ã€‚</strong></p>
<ol type="1">
<li>qemuæ¨¡æ‹Ÿçš„ <code>virt</code> ç¡¬ä»¶å¹³å°ä¸Šçš„ç‰©ç†å†…å­˜çš„èµ·å§‹åœ°å€
<code>0x80000000</code>ï¼›</li>
<li><code>ekernel</code> åœ¨ <code>linker</code> ä¸­ï¼Œæˆ‘ä»¬åœ¨å®Œæˆ
<code>.bss</code> å¹¶ä¸”è¿›è¡Œå†…å­˜å¯¹é½ä¹‹åï¼ŒæŒ‡å®šäº† <code>ekernel</code>
è¿™ä¸ªå‚æ•°ï¼Œè¡¨ç¤ºå†…æ ¸ä»£ç çš„ç»“æŸä½ç½®ï¼›</li>
<li><code>MEMORY_END</code> åœ¨ <code>config.rs</code> ä¸­ç¡¬ç¼–ç çš„åœ°å€
<code>0x88000000</code>ã€‚</li>
</ol>
<p>éšåï¼Œæˆ‘ä»¬å®šä¹‰ï¼š</p>
<ol type="1">
<li><code>trait</code> <code>FrameAllocator</code>
ç”¨äºç®¡ç†æˆ‘ä»¬å…¨éƒ¨å¯ç”¨çš„ç‰©ç†å†…å­˜ï¼›</li>
<li><code>impl</code> <code>StackFrameAllocator</code>
æ˜¯åŸºäºVecçš„ä¸€ä¸ªç®€å•å®ç°ï¼›</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/mm/frame_allocator.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> <span class="title class_">FrameAllocator</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span>;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">alloc</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;PhysPageNum&gt;;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">dealloc</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, ppn: PhysPageNum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>StackFrameAllocator</code> çš„å®ç°é€»è¾‘ä¹Ÿéå¸¸ç®€å•ï¼š</p>
<ol type="1">
<li><code>current</code> å’Œ <code>end</code>
è¡¨ç¤ºç©ºé—²å†…å­˜çš„é¡µå·ï¼Œè¿™ä¸ªé¡µå·åˆå§‹ç”± <code>ekernel</code> å’Œ
<code>MEMORY_END</code> è¿›è¡Œå†…å­˜å¯¹é½åè®¡ç®—å¾—å‡ºï¼›</li>
<li><code>recycled</code> è¡¨ç¤º <code>alloc</code> å
<code>dealloc</code> çš„å†…å­˜ï¼Œæˆ‘ä»¬åˆ†é…æ—¶ä¹Ÿä¼˜å…ˆä»è¿™é‡Œå¼€å§‹åˆ†é…ï¼›</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/mm/frame_allocator.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">StackFrameAllocator</span> &#123;</span><br><span class="line">    current: <span class="type">usize</span>,  <span class="comment">//ç©ºé—²å†…å­˜çš„èµ·å§‹ç‰©ç†é¡µå·</span></span><br><span class="line">    end: <span class="type">usize</span>,      <span class="comment">//ç©ºé—²å†…å­˜çš„ç»“æŸç‰©ç†é¡µå·</span></span><br><span class="line">    recycled: <span class="type">Vec</span>&lt;<span class="type">usize</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// os/src/mm/frame_allocator.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">FrameAllocator</span> <span class="keyword">for</span> <span class="title class_">StackFrameAllocator</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">new</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            current: <span class="number">0</span>,</span><br><span class="line">            end: <span class="number">0</span>,</span><br><span class="line">            recycled: <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">alloc</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;PhysPageNum&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(ppn) = <span class="keyword">self</span>.recycled.<span class="title function_ invoke__">pop</span>() &#123;</span><br><span class="line">            <span class="title function_ invoke__">Some</span>(ppn.<span class="title function_ invoke__">into</span>())</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">self</span>.current == <span class="keyword">self</span>.end &#123;</span><br><span class="line">                <span class="literal">None</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">self</span>.current += <span class="number">1</span>;</span><br><span class="line">                <span class="title function_ invoke__">Some</span>((<span class="keyword">self</span>.current - <span class="number">1</span>).<span class="title function_ invoke__">into</span>())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">dealloc</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, ppn: PhysPageNum) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ppn</span> = ppn.<span class="number">0</span>;</span><br><span class="line">        <span class="comment">// validity check</span></span><br><span class="line">        <span class="keyword">if</span> ppn &gt;= <span class="keyword">self</span>.current || <span class="keyword">self</span>.recycled</span><br><span class="line">            .<span class="title function_ invoke__">iter</span>()</span><br><span class="line">            .<span class="title function_ invoke__">find</span>(|&amp;v| &#123;*v == ppn&#125;)</span><br><span class="line">            .<span class="title function_ invoke__">is_some</span>() &#123;</span><br><span class="line">            <span class="built_in">panic!</span>(<span class="string">&quot;Frame ppn=&#123;:#x&#125; has not been allocated!&quot;</span>, ppn);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// recycle</span></span><br><span class="line">        <span class="keyword">self</span>.recycled.<span class="title function_ invoke__">push</span>(ppn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">StackFrameAllocator</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">init</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, l: PhysPageNum, r: PhysPageNum) &#123;</span><br><span class="line">        <span class="keyword">self</span>.current = l.<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">self</span>.end = r.<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éšååˆå§‹åŒ–ä¸€ä¸ªå…¨å±€çš„
<code>FRAME_ALLOCATOR</code>ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬è¦æŠŠç‰©ç†åœ°å€
<code>ekernel</code> å’Œ <code>MEMORY_END</code> è½¬æ¢ä¸ºå¯¹åº”çš„é¡µå·ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">FrameAllocatorImpl</span> = StackFrameAllocator;</span><br><span class="line"></span><br><span class="line">lazy_static! &#123;</span><br><span class="line">    <span class="comment">/// frame allocator instance through lazy_static!</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">static</span> <span class="keyword">ref</span> FRAME_ALLOCATOR: UPSafeCell&lt;FrameAllocatorImpl&gt; =</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; UPSafeCell::<span class="title function_ invoke__">new</span>(FrameAllocatorImpl::<span class="title function_ invoke__">new</span>()) &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// initiate the frame allocator using `ekernel` and `MEMORY_END`</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">init_frame_allocator</span>() &#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">ekernel</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    FRAME_ALLOCATOR.<span class="title function_ invoke__">exclusive_access</span>().<span class="title function_ invoke__">init</span>(</span><br><span class="line">        PhysAddr::<span class="title function_ invoke__">from</span>(ekernel <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">ceil</span>(),</span><br><span class="line">        PhysAddr::<span class="title function_ invoke__">from</span>(MEMORY_END).<span class="title function_ invoke__">floor</span>(),</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="åˆ†é…å›æ”¶ç‰©ç†é¡µå¸§çš„æ¥å£">åˆ†é…/å›æ”¶ç‰©ç†é¡µå¸§çš„æ¥å£</h4>
<ol type="1">
<li><code>alloc</code> å’Œ <code>dealloc</code>
éƒ½æ˜¯épubçš„å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å¤–æš´éœ²åˆ†é…çš„æ¥å£ã€‚</li>
<li>è¿™é‡Œéå¸¸å€¼å¾—æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œæˆ‘ä»¬ <code>frame_alloc()</code>
åˆ†é…å¾—åˆ°çš„æ˜¯ <code>FrameTracker</code> è€Œä¸æ˜¯
<code>PhysPageNum</code>ï¼Œè¿™ä¸ªè®¾è®¡å¾ˆå·§å¦™ï¼Œå¯ä»¥å‚è€ƒ <a
href="#physpagenumå’Œframetracker">PhysPageNumå’ŒFrameTracker</a></li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/mm/frame_allocator.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">frame_alloc</span>() <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;FrameTracker&gt; &#123;</span><br><span class="line">    FRAME_ALLOCATOR</span><br><span class="line">        .<span class="title function_ invoke__">exclusive_access</span>()</span><br><span class="line">        .<span class="title function_ invoke__">alloc</span>()</span><br><span class="line">        .<span class="title function_ invoke__">map</span>(|ppn| FrameTracker::<span class="title function_ invoke__">new</span>(ppn))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">frame_dealloc</span>(ppn: PhysPageNum) &#123;</span><br><span class="line">    FRAME_ALLOCATOR</span><br><span class="line">        .<span class="title function_ invoke__">exclusive_access</span>()</span><br><span class="line">        .<span class="title function_ invoke__">dealloc</span>(ppn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>FrameTracker</code> çš„å®ç°</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// tracker for physical page frame allocation and deallocation</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">FrameTracker</span> &#123;</span><br><span class="line">    <span class="comment">/// physical page number</span></span><br><span class="line">    <span class="keyword">pub</span> ppn: PhysPageNum,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">FrameTracker</span> &#123;</span><br><span class="line">    <span class="comment">/// Create a new FrameTracker</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(ppn: PhysPageNum) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="comment">// page cleaning</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">bytes_array</span> = ppn.<span class="title function_ invoke__">get_bytes_array</span>();</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> bytes_array &#123;</span><br><span class="line">            *i = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">Self</span> &#123; ppn &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">Drop</span> <span class="keyword">for</span> <span class="title class_">FrameTracker</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">drop</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">frame_dealloc</span>(<span class="keyword">self</span>.ppn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å¤šçº§é¡µè¡¨ç®¡ç†">å¤šçº§é¡µè¡¨ç®¡ç†</h3>
<h4 id="é¡µè¡¨åŸºæœ¬æ•°æ®ç»“æ„ä¸è®¿é—®æ¥å£">é¡µè¡¨åŸºæœ¬æ•°æ®ç»“æ„ä¸è®¿é—®æ¥å£</h4>
<p>é¡µè¡¨æ˜¯ä¸€ä¸ªå¤šçº§çš„æ•°æ®ç»“æ„ï¼Œä»–çš„ä½œç”¨å°±æ˜¯å°† <code>VPN</code> æ˜ å°„åˆ°
<code>PPN</code>ï¼Œè€Œè¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<ol type="1">
<li>é¡µè¡¨æœ¬èº«ä¹Ÿæ˜¯æ•°æ®ï¼Œæ¯ä¸€ä¸ªé¡µè¡¨éƒ½ä¼šæœ‰ä¸€ä¸ªå”¯ä¸€çš„å…¥å£åœ°å€ï¼Œè€Œè¿™ä¸ªåœ°å€æ˜¯ä»–çš„
PPNï¼›</li>
<li>é¡µè¡¨å†…éƒ¨ <code>frames</code> æ˜¯é€šè¿‡ <code>FrameTracker</code> æ¥å®ç°
PPN
ç®¡ç†ï¼Œè¿™é‡Œåœ¨æˆ‘ä»¬å½“å‰çš„é€»è¾‘ä¸‹æ˜¯å¯ä»¥çš„ï¼šå› ä¸ºæˆ‘ä»¬æš‚æ—¶æ²¡æœ‰<strong>å…±äº«ç‰©ç†é¡µ</strong>çš„åœºæ™¯ã€‚åœ¨å®é™…çš„åº”ç”¨ä¸­ï¼šå½“å¤šä¸ªè¿›ç¨‹å…±äº«ä¸€ä¸ª
PPN æ—¶ï¼ˆä¾‹å¦‚è¿›ç¨‹åˆ›å»ºæ—¶çš„
COWï¼‰ï¼Œä¼šå¯¼è‡´å†…å­˜ç®¡ç†å¼‚å¸¸ï¼Œå› ä¸ºå½“å…±äº«çš„æŸä¸€ä¸ªè¿›ç¨‹ç»“æŸæ—¶ï¼Œè¿™ä¸ªå†…å­˜å°†è¢«é‡Šæ”¾ï¼Œè€Œå¦å¤–ä¸€ä¸ªå¼•ç”¨è¯¥
PPN çš„è¿›ç¨‹ä¼šå¼•ç”¨ä¸€ä¸ªæ‚¬å‚æŒ‡é’ˆã€‚</li>
<li>æ­¤å¤–ï¼Œåœ¨å¼€å¯åˆ†é¡µåï¼Œæ— è®ºæ˜¯å†…æ ¸æ€è¿˜æ˜¯ç”¨æˆ·æ€éƒ½æ˜¯é€šè¿‡è™šæ‹Ÿåœ°å€æ¥è®¿é—®ç‰©ç†å†…å­˜ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¿…é¡»å°†ç‰©ç†å†…å­˜ä¸­<strong>æ‰€æœ‰éœ€è¦è®¿é—®çš„ç‰©ç†é¡µ</strong>éƒ½è®¾å®šä¸€ä¸ª
<code>VPN</code> -&gt; <code>PPN</code>
çš„æ˜ å°„å…³ç³»å¹¶ä¸”å­˜å‚¨åˆ°é¡µè¡¨ä¸­ã€‚è€Œå…·ä½“çš„è¿™ä¸ªæ˜ å°„é€»è¾‘ï¼Œè¯·å‚è€ƒ <a
href="#è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜">è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜</a>ã€‚</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// page table structure</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PageTable</span> &#123;</span><br><span class="line">    <span class="comment">/// Each user-facing application has a corresponding unique multi-level page table,</span></span><br><span class="line">    <span class="comment">/// which means the starting address of each page table is unique.</span></span><br><span class="line">    <span class="comment">/// That also means we must save root ppn as a `identifier`.</span></span><br><span class="line">    root_ppn: PhysPageNum,</span><br><span class="line">    <span class="comment">/// `frames` contains all page table entries (including the root PTE) and stores them as a vector.</span></span><br><span class="line">    frames: <span class="type">Vec</span>&lt;FrameTracker&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PageTable</span> &#123;</span><br><span class="line">    <span class="comment">/// set the map between virtual page number and physical page number</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">map</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, vpn: VirtPageNum, ppn: PhysPageNum, flags: PTEFlags)&#123;&#125;</span><br><span class="line">    <span class="comment">/// remove the map between virtual page number and physical page number</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">unmap</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, vpn: VirtPageNum)&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å†…æ ¸ä¸­è®¿é—®ç‰©ç†é¡µå¸§çš„æ–¹æ³•">å†…æ ¸ä¸­è®¿é—®ç‰©ç†é¡µå¸§çš„æ–¹æ³•</h4>
<ul>
<li><code>get_pte_array</code>
è¿”å›çš„æ˜¯ä¸€ä¸ªé¡µè¡¨é¡¹å®šé•¿æ•°ç»„çš„å¯å˜å¼•ç”¨ï¼Œä»£è¡¨å¤šçº§é¡µè¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼›</li>
<li><code>get_bytes_array</code>
è¿”å›çš„æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„çš„å¯å˜å¼•ç”¨ï¼Œå¯ä»¥ä»¥å­—èŠ‚ä¸ºç²’åº¦å¯¹ç‰©ç†é¡µå¸§ä¸Šçš„æ•°æ®è¿›è¡Œè®¿é—®ï¼Œå‰é¢è¿›è¡Œæ•°æ®æ¸…é›¶å°±ç”¨åˆ°äº†è¿™ä¸ªæ–¹æ³•ï¼›</li>
<li><code>get_mut</code>
æ˜¯ä¸ªæ³›å‹å‡½æ•°ï¼Œå¯ä»¥è·å–ä¸€ä¸ªæ°å¥½æ”¾åœ¨ä¸€ä¸ªç‰©ç†é¡µå¸§å¼€å¤´çš„ç±»å‹ä¸º T
çš„æ•°æ®çš„å¯å˜å¼•ç”¨ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬è·å– <code>TrapContext</code>
å°±å¯ä»¥ä½¿ç”¨å®ƒã€‚</li>
</ul>
<blockquote>
<p>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<code>get_pte_array</code> è¿™ä¸ªæ–¹æ³•åªèƒ½å¯¹äº
<code>PageTable#root_ppn</code> è°ƒç”¨ã€‚</p>
</blockquote>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">PhysAddr</span> &#123;</span><br><span class="line">    <span class="comment">///Get mutable reference to `PhysAddr` value</span></span><br><span class="line">    <span class="comment">/// Get the mutable reference of physical address</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_mut</span>&lt;T&gt;(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="keyword">mut</span> T &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; (<span class="keyword">self</span>.<span class="number">0</span> <span class="keyword">as</span> *<span class="keyword">mut</span> T).<span class="title function_ invoke__">as_mut</span>().<span class="title function_ invoke__">unwrap</span>() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PhysPageNum</span> &#123;</span><br><span class="line">    <span class="comment">/// Get the reference of page table(array of PTEs)</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_pte_array</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="keyword">mut</span> [PageTableEntry] &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">pa</span>: PhysAddr = (*<span class="keyword">self</span>).<span class="title function_ invoke__">into</span>();</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; core::slice::<span class="title function_ invoke__">from_raw_parts_mut</span>(pa.<span class="number">0</span> <span class="keyword">as</span> *<span class="keyword">mut</span> PageTableEntry, <span class="number">512</span>) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// Get the reference of page(array of bytes)</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_bytes_array</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="keyword">mut</span> [<span class="type">u8</span>] &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">pa</span>: PhysAddr = (*<span class="keyword">self</span>).<span class="title function_ invoke__">into</span>();</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; core::slice::<span class="title function_ invoke__">from_raw_parts_mut</span>(pa.<span class="number">0</span> <span class="keyword">as</span> *<span class="keyword">mut</span> <span class="type">u8</span>, <span class="number">4096</span>) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// Get the mutable reference of physical address</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">get_mut</span>&lt;T&gt;(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="symbol">&#x27;static</span> <span class="keyword">mut</span> T &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">pa</span>: PhysAddr = (*<span class="keyword">self</span>).<span class="title function_ invoke__">into</span>();</span><br><span class="line">        pa.<span class="title function_ invoke__">get_mut</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å»ºç«‹å’Œæ‹†é™¤è™šå®åœ°å€æ˜ å°„å…³ç³»">å»ºç«‹å’Œæ‹†é™¤è™šå®åœ°å€æ˜ å°„å…³ç³»</h4>
<p>è¿™ä¸ªé€»è¾‘è¾ƒä¸ºç®€å•ï¼Œå°±æ˜¯ä½¿ç”¨VPNçš„ä¸‰çº§ç´¢å¼•å»æŸ¥è¯¢PageTableï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„å‡ ä¸ªç‚¹æ˜¯ï¼š</p>
<ol type="1">
<li><code>RV39</code> ä¸­ <code>VPN</code> æ˜¯ä¸‰ä¸ª <code>9bit</code> çš„
<code>usize</code>ï¼›</li>
<li><code>VPN</code> ä¸æ˜¯ <code>VA</code>ï¼Œä»–å’Œ <code>offset</code>
ç»“åˆæ‰æ˜¯ <code>VA</code>ï¼›</li>
<li><code>ppn.get_pte_array()</code> è·å–çš„æ˜¯é€šè¿‡ <code>root_ppn</code>
è¯»å–çš„è¿ç»­çš„ PTE å¯¹è±¡ã€‚</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">VirtPageNum</span> &#123;</span><br><span class="line">    <span class="comment">/// Get the indexes of the page table entry</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">indexes</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> [<span class="type">usize</span>; <span class="number">3</span>] &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vpn</span> = <span class="keyword">self</span>.<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">idx</span> = [<span class="number">0usize</span>; <span class="number">3</span>];</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> (<span class="number">0</span>..<span class="number">3</span>).<span class="title function_ invoke__">rev</span>() &#123;</span><br><span class="line">            idx[i] = vpn &amp; <span class="number">0x1FF</span>;</span><br><span class="line">            vpn &gt;&gt;= <span class="number">9</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        idx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">PageTable</span> &#123;</span><br><span class="line">    <span class="comment">/// Find PageTableEntry by VirtPageNum, create a frame for a 4KB page table if not exist</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">find_pte_create</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, vpn: VirtPageNum) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> PageTableEntry&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">idxs</span> = vpn.<span class="title function_ invoke__">indexes</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">ppn</span> = <span class="keyword">self</span>.root_ppn;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">result</span>: <span class="type">Option</span>&lt;&amp;<span class="keyword">mut</span> PageTableEntry&gt; = <span class="literal">None</span>;</span><br><span class="line">        <span class="keyword">for</span> (i, idx) <span class="keyword">in</span> idxs.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">enumerate</span>() &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">pte</span> = &amp;<span class="keyword">mut</span> ppn.<span class="title function_ invoke__">get_pte_array</span>()[*idx];</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">2</span> &#123;</span><br><span class="line">                result = <span class="title function_ invoke__">Some</span>(pte);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> !pte.<span class="title function_ invoke__">is_valid</span>() &#123;</span><br><span class="line">                <span class="keyword">let</span> <span class="variable">frame</span> = <span class="title function_ invoke__">frame_alloc</span>().<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">                *pte = PageTableEntry::<span class="title function_ invoke__">new</span>(frame.ppn, PTEFlags::V);</span><br><span class="line">                <span class="keyword">self</span>.frames.<span class="title function_ invoke__">push</span>(frame);</span><br><span class="line">            &#125;</span><br><span class="line">            ppn = pte.<span class="title function_ invoke__">ppn</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        result</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬åœ¨ä¸€äº›åœºæ™¯ä¸‹å¯èƒ½éœ€è¦è®¿é—®éå½“å‰åœ°å€ç©ºé—´çš„é¡µè¡¨ï¼ˆä¾‹å¦‚ï¼Œåœ¨ç³»ç»Ÿè°ƒç”¨æ—¶å†…æ ¸æ€éœ€è¦è®¿é—®ç”¨æˆ·æ€çš„å†…å­˜ç©ºé—´ï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–¹æ³•ï¼Œèƒ½æŸ¥è¯¢åˆ°å…¶ä»–åœ°å€ç©ºé—´çš„é¡µè¡¨ä½†æ˜¯ä¸å½±å“å…¶æ‰€æœ‰æƒï¼Œæˆ‘ä»¬æä¾›äº†ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">PageTable</span> &#123;</span><br><span class="line">    <span class="comment">/// Temporarily used to get arguments from user space.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">from_token</span>(satp: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            root_ppn: PhysPageNum::<span class="title function_ invoke__">from</span>(satp &amp; ((<span class="number">1usize</span> &lt;&lt; <span class="number">44</span>) - <span class="number">1</span>)),</span><br><span class="line">            frames: <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>(),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/// get the page table entry from the virtual page number</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">translate</span>(&amp;<span class="keyword">self</span>, vpn: VirtPageNum) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;PageTableEntry&gt; &#123;</span><br><span class="line">        <span class="keyword">self</span>.<span class="title function_ invoke__">find_pte</span>(vpn).<span class="title function_ invoke__">map</span>(|pte| *pte)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å†…æ ¸ä¸åº”ç”¨çš„åœ°å€ç©ºé—´">å†…æ ¸ä¸åº”ç”¨çš„åœ°å€ç©ºé—´</h2>
<p><code>PageTable</code>
ä»¥é¡µä¸ºå•ä½ç»´æŠ¤è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜çš„æ˜ å°„å…³ç³»ï¼Œä½†æ˜¯åœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œæ¯ä¸ªåº”ç”¨éƒ½ä¼šç»´æŠ¤ä¸€ä¸ªè‡ªå·±çš„é¡µè¡¨ï¼ˆåŒ…æ‹¬å†…æ ¸ï¼‰ã€‚è€Œè¿™ä¸ªåº”ç”¨é—´ç‹¬ç«‹çš„é¡µè¡¨ç”±
<code>åœ°å€ç©ºé—´</code> æ¥ç»´æŠ¤ã€‚</p>
<h3 id="å®ç°åœ°å€ç©ºé—´æŠ½è±¡">å®ç°åœ°å€ç©ºé—´æŠ½è±¡</h3>
<h4
id="é€»è¾‘æ®µä¸€æ®µè¿ç»­åœ°å€çš„è™šæ‹Ÿå†…å­˜">é€»è¾‘æ®µï¼šä¸€æ®µè¿ç»­åœ°å€çš„è™šæ‹Ÿå†…å­˜</h4>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// map area structure, controls a contiguous piece of virtual memory</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">MapArea</span> &#123;</span><br><span class="line">    vpn_range: VPNRange,</span><br><span class="line">    data_frames: BTreeMap&lt;VirtPageNum, FrameTracker&gt;,</span><br><span class="line">    map_type: MapType,</span><br><span class="line">    map_perm: MapPermission,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol type="1">
<li>MapArea ä»£è¡¨ä¸€æ®µè¿ç»­çš„ è™šæ‹Ÿå†…å­˜åŒºé—´ï¼ˆé€»è¾‘æ®µï¼‰ï¼›
<ul>
<li>vpn_rangeï¼šä¿å­˜è¯¥æ®µåŒ…å«çš„è¿ç»­ VirtPageNum
åŒºé—´ï¼Œæ˜ç¡®è™šæ‹Ÿå†…å­˜çš„èŒƒå›´ï¼ˆæ®µå†…è¿ç»­ï¼‰ï¼›</li>
<li>data_framesï¼šä»…å½“é€»è¾‘æ®µé‡‡ç”¨ MapType::Framed æ˜ å°„æ—¶æœ‰æ•ˆï¼Œæ˜¯å­˜å‚¨
â€œè™šæ‹Ÿé¡µï¼ˆVPNï¼‰â†’ ç‰©ç†é¡µå¸§ï¼ˆFrameTrackerï¼‰â€
çš„é”®å€¼å¯¹å®¹å™¨ï¼ˆBTreeMapï¼‰ã€‚è¿™äº›ç‰©ç†é¡µå¸§ç”¨äºå­˜æ”¾å®é™…æ•°æ®ï¼ˆè€Œéå¤šçº§é¡µè¡¨çš„ä¸­é—´èŠ‚ç‚¹ï¼‰ï¼Œæ ¸å¿ƒä½œç”¨æ˜¯æŒæœ‰ç‰©ç†é¡µçš„æ‰€æœ‰æƒï¼›</li>
<li>map_typeï¼šæŒ‡å®šè¯¥æ®µè™šæ‹Ÿå†…å­˜çš„æ˜ å°„æ–¹å¼ï¼ˆå¦‚æ’ç­‰æ˜ å°„ã€åŠ¨æ€æ˜ å°„ï¼Œåç»­å¯æ‰©å±•æ–‡ä»¶æ˜ å°„ç­‰ï¼‰ï¼›</li>
<li>map_permï¼šæŒ‡å®šè¯¥æ®µçš„è®¿é—®æƒé™ï¼ˆR/W/X/ ç”¨æˆ·æ€å¯è®¿é—®ï¼Œå³ U
ä½ï¼‰ï¼Œä¸é¡µè¡¨é¡¹ï¼ˆPTEï¼‰çš„æƒé™ä¸€è‡´ï¼›</li>
</ul></li>
<li>VPNRangeï¼šé€šè¿‡ SimpleRange<VirtPageNum> ç»„ç»‡è¿ç»­çš„ VirtPageNum
åŒºé—´ï¼Œä¸º vpn_range æä¾›åº•å±‚æ”¯æŒï¼›
<ul>
<li>è¿™äº›é€»è¾‘æ®µçš„è™šæ‹Ÿåœ°å€é€šå¸¸æ˜¯è¿ç»­çš„ï¼Œå› æ­¤ç”¨ vpn_range æ˜ç¡®å…¶èŒƒå›´ï¼›</li>
<li>ä¸åŒæ®µçš„è®¿é—®æƒé™ä¸åŒï¼ˆ.data ä¸º R/Wã€<code>.rodata</code> ä¸º Rã€.text
ä¸º R/Xï¼‰ï¼Œå› æ­¤ç”¨ map_perm å®šä¹‰æƒé™ï¼›</li>
<li>ä¸åŒæ®µçš„æ˜ å°„æ–¹å¼ä¸åŒï¼ˆç”¨æˆ· heap éœ€åŠ¨æ€æ˜ å°„ã€å†…æ ¸ .text/.data
éœ€æ’ç­‰æ˜ å°„ï¼‰ï¼Œå› æ­¤ç”¨ map_type åŒºåˆ†ï¼›</li>
<li>MapArea
ç®¡ç†ä¸€æ®µè¿ç»­çš„è™šæ‹Ÿå†…å­˜åŠå…¶å¯¹åº”çš„ç‰©ç†å†…å­˜ï¼Œéœ€å¯¹äºŒè€…çš„ç”Ÿå‘½å‘¨æœŸè´Ÿè´£ï¼šè™šæ‹Ÿå†…å­˜çš„èŒƒå›´ç”±
vpn_range ç•Œå®šï¼Œç‰©ç†å†…å­˜çš„æ‰€æœ‰æƒç”± data_frames æŒæœ‰ï¼ˆé”€æ¯ MapArea
æ—¶è‡ªåŠ¨å›æ”¶ç‰©ç†é¡µï¼‰ï¼›åŒæ—¶ data_frames æä¾› â€œVPNâ†’FrameTrackerâ€
çš„é«˜æ•ˆåå‘æŸ¥è¯¢ï¼Œæ¯”éå†é¡µè¡¨æ›´å¿«ï¼›</li>
<li>data_frames ä¸ PageTable çš„æ ¸å¿ƒå·®åˆ«ï¼šdata_frames æ˜¯ç‰©ç†å†…å­˜çš„
â€œæ‰€æœ‰è€…â€ï¼ˆç®¡å½’å±ã€ç®¡ç”Ÿå‘½å‘¨æœŸï¼‰ï¼ŒPageTable æ˜¯åœ°å€ç¿»è¯‘çš„ â€œæŸ¥è¯¢å·¥å…·â€ï¼ˆç®¡
VAâ†’PA æ˜ å°„ã€ç®¡æƒé™æ£€æŸ¥ï¼‰ï¼ŒäºŒè€…åˆ†å·¥åä½œï¼Œç¼ºä¸€ä¸å¯ã€‚</li>
</ul></li>
</ol>
<h4
id="åœ°å€ç©ºé—´ä¸€ç³»åˆ—æœ‰å…³è”çš„é€»è¾‘æ®µ">åœ°å€ç©ºé—´ï¼šä¸€ç³»åˆ—æœ‰å…³è”çš„é€»è¾‘æ®µ</h4>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// address space</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">MemorySet</span> &#123;</span><br><span class="line">    page_table: PageTable,</span><br><span class="line">    areas: <span class="type">Vec</span>&lt;MapArea&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol type="1">
<li>MemorySet
ä¸€ä¸ªæœ‰å…³è”ä½†æ˜¯ä¸ä¸€å®šè¿ç»­çš„é€»è¾‘æ®µçš„é›†åˆã€‚å‰é¢æåˆ°ä¸€ä¸ªè¿›ç¨‹é‡Œä¼šæœ‰
<code>.data</code>ï¼Œ <code>.text</code>ï¼Œ <code>.rodata</code>
ç­‰é€»è¾‘æ®µï¼Œè¿™äº›é€»è¾‘æ®µç”¨ <code>MapArea</code> æ¥è¡¨ç¤ºï¼Œè€Œ MemorySet
æ˜¯è¿™äº›é€»è¾‘æ®µçš„é›†åˆã€‚
<ul>
<li>page_table
é¡µè¡¨ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ç‹¬ç«‹çš„é¡µè¡¨ã€‚ä¸åŒè¿›ç¨‹çš„åŒä¸€ä¸ªVAä¼šé€šè¿‡é¡µè¡¨æ˜ å°„åˆ°ç‹¬ç«‹çš„PAï¼›</li>
<li>areas æ˜¯ MapArea çš„é›†åˆï¼ŒåŒ…å«äº†ä¸€ä¸ªç¨‹åºçš„æ‰€æœ‰é€»è¾‘æ®µï¼›</li>
</ul></li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">MemorySet</span> &#123;</span><br><span class="line">    <span class="comment">/// 1. Map a `MapArea` to the page table.</span></span><br><span class="line">    <span class="comment">/// 2. If any input files are provided, copy the data from the input files into the newly initialized `MapArea`.</span></span><br><span class="line">    <span class="comment">/// 3. Push MapArea into `MemorySet`</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">push</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, <span class="keyword">mut</span> map_area: MapArea, data: <span class="type">Option</span>&lt;&amp;[<span class="type">u8</span>]&gt;) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Create a `MapArea` spanning the virtual address (VA) range from `start_va` to `end_va` with the given `permission`.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">insert_framed_area</span>(</span><br><span class="line">        &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">        start_va: VirtAddr,</span><br><span class="line">        end_va: VirtAddr,</span><br><span class="line">        permission: MapPermission,</span><br><span class="line">    ) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Without kernel stacks.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new_kernel</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Include sections in elf and trampoline and TrapContext and user stack,</span></span><br><span class="line">    <span class="comment">/// also returns user_sp_base and entry point.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">from_elf</span>(elf_data: &amp;[<span class="type">u8</span>]) <span class="punctuation">-&gt;</span> (<span class="keyword">Self</span>, <span class="type">usize</span>, <span class="type">usize</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>MemorySet</code></p>
</blockquote>
<ul>
<li><code>push</code>ï¼š
<ol type="1">
<li>ä¸º <code>map_area</code> ä¸­æ‰€æœ‰çš„ <code>vpn</code> åˆ†é…å¯¹åº”çš„
<code>ppn</code>ï¼Œå¹¶æ›´æ–°é¡µè¡¨ï¼Œ<strong>æ³¨æ„ï¼Œæ­¤æ—¶æˆ‘ä»¬åªæ˜¯åˆå§‹åŒ–äº† VPN
-&gt; PPN çš„æ˜ å°„å…³ç³»ï¼Œæ­¤æ—¶æ•°æ®æ˜¯æ²¡æœ‰å†™å…¥åˆ°å†…å­˜çš„ã€‚</strong></li>
<li>å¦‚æœæä¾›äº† <code>data</code> ä½œä¸ºè¾“å…¥ï¼Œæˆ‘ä»¬å°† <code>data</code>
å¤åˆ¶åˆ°ä¸»å­˜ã€‚<strong>æ³¨æ„ï¼Œåœ¨è¿™ä¸ªæ—¶åˆ»æˆ‘ä»¬å·²ç»å¼€å§‹éœ€è¦ä½¿ç”¨PageTableæ¥æ˜ å°„VPN
-&gt; PPNäº†ã€‚</strong></li>
<li>å°†æ„é€ å¥½çš„ <code>map_area</code> åŠ å…¥æˆ‘ä»¬çš„åœ°å€ç©ºé—´ -- ä¹Ÿå°±æ˜¯
MemorySetã€‚</li>
</ol></li>
<li><code>insert_framed_area</code> åˆ›å»ºä¸€ä¸ªä» <code>start_va</code>
å¼€å§‹åˆ° <code>end_va</code> ç»“æŸçš„ MapAreaã€‚</li>
</ul>
<h4 id="å†…æ ¸åœ°å€ç©ºé—´">å†…æ ¸åœ°å€ç©ºé—´</h4>
<p>å¯ç”¨åˆ†é¡µæ¨¡å¼ä¸‹ï¼Œå†…æ ¸ä»£ç çš„è®¿å­˜åœ°å€ä¹Ÿä¼šè¢«è§†ä¸ºä¸€ä¸ªè™šæ‹Ÿåœ°å€å¹¶éœ€è¦ç»è¿‡
MMU
çš„åœ°å€è½¬æ¢ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿéœ€è¦ä¸ºå†…æ ¸å¯¹åº”æ„é€ ä¸€ä¸ªåœ°å€ç©ºé—´ï¼Œå®ƒé™¤äº†ä»ç„¶éœ€è¦å…è®¸å†…æ ¸çš„å„æ•°æ®æ®µèƒ½å¤Ÿè¢«æ­£å¸¸è®¿é—®ä¹‹åï¼Œè¿˜éœ€è¦åŒ…å«æ‰€æœ‰åº”ç”¨çš„å†…æ ¸æ ˆä»¥åŠä¸€ä¸ª
è·³æ¿ (Trampoline) ã€‚</p>
<p>åœ¨å¼€å§‹æ¢³ç†ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ä»¥ä¸‹ä¸¤ä¸ªå†…å®¹ï¼š</p>
<ul>
<li><a href="#sv39æ¨¡å¼ä¸‹çš„åœ°å€ç©ºé—´">sv39æ¨¡å¼ä¸‹çš„åœ°å€ç©ºé—´</a></li>
<li><a
href="#åº”ç”¨æ ˆå’Œåº”ç”¨å†…æ ¸æ ˆä»¥åŠå†…æ ¸æ ˆ">åº”ç”¨æ ˆå’Œåº”ç”¨å†…æ ¸æ ˆä»¥åŠå†…æ ¸æ ˆ</a></li>
</ul>
<p><code>new_kernel()</code> æ–¹æ³•å°†
<code>.text/.rodata/.data/.bss</code> ä»¥åŠ
<code>å†…æ ¸-&gt;å†…å­˜ç»“æŸ</code> çš„è¿™äº”ä¸ªé€»è¾‘æ®µåˆå§‹åŒ–å®Œæˆã€‚</p>
<blockquote>
<p><strong>è¿™é‡Œæœ€éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæˆ‘ä»¬æ‰€æœ‰çš„ memory_set.push() æ–¹æ³•éƒ½æ˜¯ä¸å¸¦
<code>data</code>
å‚æ•°çš„ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ’ç­‰æ˜ å°„ï¼Œä»–æ‰€è®¿é—®çš„å†…å­˜åŒºåŸŸæœ¬èº«å°±æ˜¯å­˜åœ¨æ•°æ®çš„ã€‚</strong></p>
</blockquote>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/mm/memory_set.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">stext</span>();</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">etext</span>();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">MemorySet</span> &#123;</span><br><span class="line">    <span class="comment">/// Without kernel stacks.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new_kernel</span>() <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">memory_set</span> = <span class="keyword">Self</span>::<span class="title function_ invoke__">new_bare</span>();</span><br><span class="line">        <span class="comment">// map trampoline</span></span><br><span class="line">        memory_set.<span class="title function_ invoke__">map_trampoline</span>();</span><br><span class="line">        <span class="comment">// map kernel sections</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;[main][kernel] Hello, world!&quot;</span>);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;mapping .text section&quot;</span>);</span><br><span class="line">        memory_set.<span class="title function_ invoke__">push</span>(MapArea::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            (stext <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            (etext <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            MapType::Identical,</span><br><span class="line">            MapPermission::R | MapPermission::X,</span><br><span class="line">        ), <span class="literal">None</span>);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        memory_set</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥æŠŠLOGæ—¥å¿—æ‰“å¼€æµ‹è¯•ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make run BASE=4 TEST=4 LOG=TRACE</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„è¾“å‡ºï¼Œèµ·å§‹ä½ç½®å’Œæˆ‘ä»¬ linker.ld çš„å£°æ˜æ˜¯ä¸€è‡´çš„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[TRACE] [main][kernel] .text [0x80200000, 0x8020c000)</span><br><span class="line">[DEBUG] [main][kernel] .rodata [0x8020c000, 0x80210000)</span><br><span class="line">[ INFO] [main][kernel] .data [0x80210000, 0x8023a000)</span><br><span class="line">[ WARN] [main][kernel] boot_stack top=bottom=0x8024a000, lower_bound=0x8023a000</span><br><span class="line">[ERROR] [main][kernel] .bss [0x8024a000, 0x8224b000)</span><br></pre></td></tr></table></figure>
<h3 id="åº”ç”¨åœ°å€ç©ºé—´">åº”ç”¨åœ°å€ç©ºé—´</h3>
<blockquote>
<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹ <a href="#trampoline">trampoline</a></p>
</blockquote>
<figure>
<img src="/images/20251121/app-as-full.png" alt="app-as-full.png" />
<figcaption aria-hidden="true">app-as-full.png</figcaption>
</figure>
<p>åº”ç”¨åœ°å€ç©ºé—´çš„åˆå§‹åŒ–é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li>åˆå§‹åŒ–é«˜256GiBï¼š
<ol type="1">
<li>åˆå§‹åŒ– <code>trampoline</code>ï¼Œtrampoline
ä½äºé«˜256GiBçš„æœ€é«˜ç‚¹èµ·å§‹ä½ç½®ï¼Œä»…ä»…ä½¿ç”¨ä¸€é¡µï¼›</li>
<li>åˆå§‹åŒ–
<code>TrapContext</code>ï¼Œä»–åœ¨trampolineçš„ä¸‹æ–¹ï¼Œä¹Ÿä»…ä»…ä½¿ç”¨ä¸€é¡µï¼›</li>
</ol></li>
<li>åˆå§‹åŒ–ä½256GiBï¼š
<ol type="1">
<li>åˆå§‹åŒ–<code>.text/.rodata/.data/.bss</code> ï¼šè§£æ <code>elf</code>
æ–‡ä»¶ï¼Œå°†elfæ–‡ä»¶ä¸­çš„æ‰€æœ‰ program headers å¤åˆ¶åˆ°å†…æ ¸ä¸­ï¼š
<ol type="1">
<li>è§£æelfï¼Œä¸ºæ¯ä¸ªphåˆ›å»ºä¸€ä¸ªMapAreaï¼›</li>
<li>å°†phå¤åˆ¶åˆ°æˆ‘ä»¬åˆ›å»ºçš„MapAreaä¸­ï¼Œå¹¶åˆå§‹åŒ–å¯¹åº”çš„æƒé™ï¼›</li>
<li>è¿™é‡Œä¸€å®šéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨
<code>xmas_elf::ElfFile::new(elf_data)</code>
çš„æ—¶å€™å·²ç»å°†æ•°æ®åŠ è½½åˆ°ç‰©ç†å†…å­˜äº†ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦å¤åˆ¶åˆ°æˆ‘ä»¬å¯¹åº”çš„MapAreaå‘¢ï¼Ÿ
<ul>
<li>ç°åœ¨è¯»å–åˆ°çš„æ•°æ®è™½ç„¶å·²ç»åœ¨ç‰©ç†å†…å­˜ä¸­äº†ï¼Œä½†æ˜¯ä»–åªæ˜¯åœ¨è¿™ä¸ªå‡½æ•°ä¸‹çš„ä¸€æ®µä¸´æ—¶çš„æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä»–è½¬æ¢ä¸ºä¸€ä¸ªç”Ÿå‘½å‘¨æœŸå’Œåº”ç”¨ä¸€è‡´çš„ç¨‹åºï¼Œä¹Ÿå°±æ˜¯MapAreaï¼›å¦‚æœæˆ‘ä»¬ä¸æŠŠä»–è½¬æ¢ä¸ºMapAreaï¼Œé‚£ä¹ˆrustç¼–è¯‘å™¨ä¼šä¿è¯åœ¨è¯¥å‡½æ•°é€€å‡ºåä»–å¯¹åº”çš„ç‰©ç†å†…å­˜è¢«å›æ”¶ï¼›</li>
<li>è¯»å–åˆ°æ•°æ®ä¹‹åï¼Œ<code>[ph.virtual_addr(), ph.virtual_addr() + ph.mem_size())</code>
è¿™æ®µè™šæ‹Ÿå†…å­˜ä¿è¯æ˜¯å¯ç”¨çš„ã€‚æˆ‘ä»¬å…¶å®ä¹Ÿå¯ä»¥é€‰æ‹©è‡ªå·±é‡æ–°ä¸ºå®ƒç”Ÿæˆä¸€ä¸ªæ–°çš„è™šæ‹Ÿå†…å­˜ç‰‡åœ°å€ï¼Œä½†æ˜¯æ„ä¹‰ä¸å¤§ã€‚</li>
</ul></li>
</ol></li>
<li>åˆå§‹åŒ– <code>user stack</code>ï¼›</li>
<li>åˆå§‹åŒ– <code>sbrk</code>ï¼›</li>
</ol></li>
</ol>
<h4 id="åˆå§‹åŒ–-trampoline">åˆå§‹åŒ– trampoline</h4>
<p>ä¸‹é¢çš„ä»£ç ä¸­ï¼Œåœ¨é«˜256Gä¸­åˆå§‹åŒ–äº†ä¸€é¡µä½œä¸ºtrampolineï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ä¸ªç‚¹ï¼š</p>
<ol type="1">
<li><code>strampoline</code> åœ¨ <code>linker.ld</code> ä¸­å£°æ˜ï¼Œä»–ç´§è·Ÿåœ¨
<code>*(.text.entry)</code> è¿›è¡Œ4Kå¯¹é½ä¹‹åï¼›</li>
<li><code>strampoline</code>
è‡ªèº«çš„å†…å®¹ä¹Ÿéœ€è¦4Kå¯¹é½ï¼Œè¿™æ ·å¯ä»¥æ­£å¥½å»é€‚é…æˆ‘ä»¬çš„ä¸€ä¸ªå†…å­˜é¡µï¼›</li>
<li><code>strampoline</code>
çš„å¤§å°ä¸èƒ½è¶…è¿‡4Kï¼Œå¦åˆ™åœ¨mapçš„æ—¶å€™å°†å‡ºç°æ•°æ®ç¼ºå¤±ï¼›</li>
<li><code>trampoline</code> çš„èŒƒå›´æ˜¯é«˜256çš„æœ€é«˜ä½å¼€å§‹å‘ä¸‹è®¡ç®—ä¸€é¡µã€‚</li>
</ol>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text</span> : &#123;</span><br><span class="line">    *(<span class="meta">.text</span>.entry)</span><br><span class="line">    . = <span class="meta">ALIGN</span>(<span class="number">4</span>K)<span class="comment">;</span></span><br><span class="line">    strampoline = .<span class="comment">;</span></span><br><span class="line">    *(<span class="meta">.text</span>.trampoline)<span class="comment">;</span></span><br><span class="line">    . = <span class="meta">ALIGN</span>(<span class="number">4</span>K)<span class="comment">;</span></span><br><span class="line">    *(<span class="meta">.text</span> <span class="meta">.text</span>.*)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// config.rs</span></span><br><span class="line"><span class="comment">/// The virtual address of the trampoline.</span></span><br><span class="line"><span class="comment">/// The trampoline is placed at the top of the high 256 GiB virtual address space,</span></span><br><span class="line"><span class="comment">/// with its starting address set to `usize::MAX - PAGE_SIZE + 1`.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">const</span> TRAMPOLINE: <span class="type">usize</span> = <span class="type">usize</span>::MAX - PAGE_SIZE + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// memory_set.rs</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">strampoline</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// memory_set.rs</span></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">MemorySet</span> &#123;</span><br><span class="line">    <span class="comment">/// Mention that trampoline is not collected by areas.</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">map_trampoline</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.page_table.<span class="title function_ invoke__">map</span>(</span><br><span class="line">            VirtAddr::<span class="title function_ invoke__">from</span>(TRAMPOLINE).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            PhysAddr::<span class="title function_ invoke__">from</span>(strampoline <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            PTEFlags::R | PTEFlags::X,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4
id="ä»elfåˆå§‹åŒ–.text.rodata.data.bss">ä»elfåˆå§‹åŒ–.text/.rodata/.data/.bss</h4>
<blockquote>
<p>APPENDIXï¼š<a href="#elfæ–‡ä»¶çš„vaå’Œpa">elfæ–‡ä»¶çš„VAå’ŒPA</a></p>
</blockquote>
<ol type="1">
<li>éå†elfæ–‡ä»¶å†…çš„
<code>program headers</code>ã€‚è¿™æ ·ï¼Œphä¼šè¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ä»–ä»¬æ¥åˆ›å»ºå‡ºä¸€ä¸ªMapAreaäº†ï¼›</li>
<li>åœ¨åˆ›å»º <code>MapArea</code>
ä¹‹åï¼Œæœ‰éå¸¸é‡è¦çš„ä¸€ä¸ªæ­¥éª¤ï¼Œ<strong>é‚£å°±æ˜¯æŠŠæˆ‘ä»¬elfçš„é€»è¾‘æ®µæ•°æ®æ˜ å°„åˆ°æˆ‘ä»¬æ–°åˆ›å»ºçš„MapArea</strong>ã€‚ä¸åŒäº
<code>trampoline</code>, <code>TrapContext</code>,
<code>user_stack</code>, <code>sbrk</code>
è¿™å‡ ä¸ªé€»è¾‘æ®µï¼Œelfçš„é€»è¾‘æ•°æ®æ®µæ˜¯æœ‰åˆå§‹å€¼çš„ --
ä¹Ÿå°±æ˜¯elfæ–‡ä»¶é‡Œçš„å€¼ã€‚<strong>æˆ‘ä»¬ç°åœ¨åªæ˜¯ä¸ºelfæ–‡ä»¶åˆ›å»ºäº†æ˜ å°„ï¼Œæ˜ å°„æŒ‡å‘çš„ç‰©ç†å†…å­˜æ•°æ®ä»ç„¶ä¸å­˜åœ¨ã€‚</strong></li>
<li>åœ¨ <code>push()</code>
çš„æ—¶å€™å°†æ•°æ®ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œåˆå§‹åŒ–elfçš„é€»è¾‘æ®µåˆ°è™šæ‹Ÿå†…å­˜
<code>(&amp;elf.input[ph.offset() as usize..(ph.offset() + ph.file_size()) as usize])</code>ã€‚</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">map_elf</span>(memory_set: &amp;<span class="keyword">mut</span> MemorySet, elf: &amp; xmas_elf::ElfFile) <span class="punctuation">-&gt;</span> VirtPageNum &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">elf_header</span> = elf.header;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">magic</span> = elf_header.pt1.magic;</span><br><span class="line">    <span class="built_in">assert_eq!</span>(magic, [<span class="number">0x7f</span>, <span class="number">0x45</span>, <span class="number">0x4c</span>, <span class="number">0x46</span>], <span class="string">&quot;invalid elf!&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ph_count</span> = elf_header.pt2.<span class="title function_ invoke__">ph_count</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">max_end_vpn</span> = <span class="title function_ invoke__">VirtPageNum</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..ph_count &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ph</span> = elf.<span class="title function_ invoke__">program_header</span>(i).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        <span class="keyword">if</span> ph.<span class="title function_ invoke__">get_type</span>().<span class="title function_ invoke__">unwrap</span>() == xmas_elf::program::Type::Load &#123;</span><br><span class="line">            <span class="comment">// Notice that the elf file has been loaded into virtual memory</span></span><br><span class="line">            <span class="keyword">let</span> <span class="variable">start_va</span>: VirtAddr = (ph.<span class="title function_ invoke__">virtual_addr</span>() <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">end_va</span>: VirtAddr = ((ph.<span class="title function_ invoke__">virtual_addr</span>() + ph.<span class="title function_ invoke__">mem_size</span>()) <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">map_perm</span> = MapPermission::U;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">ph_flags</span> = ph.<span class="title function_ invoke__">flags</span>();</span><br><span class="line">            <span class="keyword">if</span> ph_flags.<span class="title function_ invoke__">is_read</span>() &#123;</span><br><span class="line">                map_perm |= MapPermission::R;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ph_flags.<span class="title function_ invoke__">is_write</span>() &#123;</span><br><span class="line">                map_perm |= MapPermission::W;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ph_flags.<span class="title function_ invoke__">is_execute</span>() &#123;</span><br><span class="line">                map_perm |= MapPermission::X;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">map_area</span> = MapArea::<span class="title function_ invoke__">new</span>(start_va, end_va, MapType::Framed, map_perm);</span><br><span class="line">            max_end_vpn = map_area.vpn_range.<span class="title function_ invoke__">get_end</span>();</span><br><span class="line">            <span class="comment">// init MapArea and copy program header into the newly created MapArea</span></span><br><span class="line">            memory_set.<span class="title function_ invoke__">push</span>(</span><br><span class="line">                map_area,</span><br><span class="line">                <span class="title function_ invoke__">Some</span>(&amp;elf.input[ph.<span class="title function_ invoke__">offset</span>() <span class="keyword">as</span> <span class="type">usize</span>..(ph.<span class="title function_ invoke__">offset</span>() + ph.<span class="title function_ invoke__">file_size</span>()) <span class="keyword">as</span> <span class="type">usize</span>]),</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    max_end_vpn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å…¶ä»–éƒ¨åˆ†åˆå§‹åŒ–">å…¶ä»–éƒ¨åˆ†åˆå§‹åŒ–</h4>
<p>é™¤äº† trampoline ä¹‹å¤–ï¼Œå…¶ä»–çš„é€»è¾‘åŸºæœ¬ä¸å¤æ‚ï¼Œè¿™é‡Œå°±ä¸åšèµ˜è¿°ã€‚</p>
<h2 id="åŸºäºåœ°å€ç©ºé—´çš„åˆ†æ—¶å¤šä»»åŠ¡">åŸºäºåœ°å€ç©ºé—´çš„åˆ†æ—¶å¤šä»»åŠ¡</h2>
<h3
id="å»ºç«‹å¹¶å¼€å¯åŸºäºåˆ†é¡µæ¨¡å¼çš„è™šæ‹Ÿåœ°å€ç©ºé—´">å»ºç«‹å¹¶å¼€å¯åŸºäºåˆ†é¡µæ¨¡å¼çš„è™šæ‹Ÿåœ°å€ç©ºé—´</h3>
<p>æœºå™¨å¯åŠ¨æ—¶æ˜¯ <code>M</code> æ¨¡å¼ï¼ŒSBIåŠ è½½å¹¶åˆå§‹åŒ–å®Œæˆåè¿›å…¥
<code>S</code> æ¨¡å¼ï¼Œéšåå†…æ ¸åˆå§‹åŒ–é¡µè¡¨ç­‰ä¿¡æ¯åï¼Œä¿®æ”¹ <code>satp</code>
å¼€å¯åˆ†é¡µæ¨¡å¼ã€‚</p>
<h4 id="åˆ›å»ºå†…æ ¸åœ°å€ç©ºé—´">åˆ›å»ºå†…æ ¸åœ°å€ç©ºé—´</h4>
<blockquote>
<p><code>lazy_static!</code> çš„æè¿°å‚è€ƒ <a
href="#lazy_static">lazy_static!</a></p>
</blockquote>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/mm/memory_set.rs</span></span><br><span class="line"></span><br><span class="line">lazy_static! &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">static</span> <span class="keyword">ref</span> KERNEL_SPACE: Arc&lt;UPSafeCell&lt;MemorySet&gt;&gt; = Arc::<span class="title function_ invoke__">new</span>(<span class="keyword">unsafe</span> &#123;</span><br><span class="line">        UPSafeCell::<span class="title function_ invoke__">new</span>(MemorySet::<span class="title function_ invoke__">new_kernel</span>()</span><br><span class="line">    )&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºå†…æ ¸åœ°å€ç©ºé—´éœ€è¦æœ‰ä¸‰éƒ¨ï¼š</p>
<ol type="1">
<li>ä¸ºruståˆå§‹åŒ–ä¸€ä¸ª HEAPï¼›</li>
<li>ä¸ºkernelåˆå§‹åŒ–ä¸€ä¸ªç‰©ç†å†…å­˜åˆ†é…å™¨ï¼›</li>
<li>ä¿®æ”¹ <code>satp</code> å¼€å¯åˆ†é¡µæ¨¡å¼ã€‚</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// os/src/mm/mod.rs</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">use</span> memory_set::KERNEL_SPACE;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">init</span>() &#123;</span><br><span class="line">    heap_allocator::<span class="title function_ invoke__">init_heap</span>();</span><br><span class="line">    frame_allocator::<span class="title function_ invoke__">init_frame_allocator</span>();</span><br><span class="line">    KERNEL_SPACE.<span class="title function_ invoke__">exclusive_access</span>().<span class="title function_ invoke__">activate</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æˆ‘ä»¬å…ˆé€šè¿‡ <code>init_heap()</code>
åˆå§‹åŒ–äº†å †ï¼Œè¿™é‡Œåˆå§‹åŒ–çš„è¿‡ç¨‹å¯ä»¥å‚è€ƒ <a
href="#å †çš„åˆå§‹åŒ–">å †çš„åˆå§‹åŒ–</a></p>
</blockquote>
<p>éšåæˆ‘ä»¬åˆå§‹åŒ– <code>FRAME_ALLOCATOR</code>ï¼Œè¿™ä¸ªæ¨¡å—ç»‘å®šäº†
<code>[ekernel, MEMORY_END)</code> è¿™æ®µ
<strong>ç‰©ç†å†…å­˜ç©ºé—´</strong>ï¼›</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// `frame_allocator.rs`</span></span><br><span class="line"><span class="comment">/// initiate the frame allocator using `ekernel` and `MEMORY_END`</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">init_frame_allocator</span>() &#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">ekernel</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    FRAME_ALLOCATOR.<span class="title function_ invoke__">exclusive_access</span>().<span class="title function_ invoke__">init</span>(</span><br><span class="line">        PhysAddr::<span class="title function_ invoke__">from</span>(ekernel <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">ceil</span>(),</span><br><span class="line">        PhysAddr::<span class="title function_ invoke__">from</span>(MEMORY_END).<span class="title function_ invoke__">floor</span>(),</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">OUTPUT_ARCH<span class="params">(riscv)</span></span><br><span class="line">ENTRY<span class="params">(_start)</span></span><br><span class="line">BASE_ADDRESS = 0x80200000;</span><br><span class="line"></span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">//</span> <span class="string">...</span></span><br><span class="line">    . = BASE_ADDRESS;</span><br><span class="line">    . = ALIGN<span class="params">(4K)</span>;</span><br><span class="line">    ebss = .;</span><br><span class="line">    ekernel = .;</span><br><span class="line"></span><br><span class="line">    <span class="string">/DISCARD/</span> : &#123;</span><br><span class="line">        *<span class="params">(.eh_frame)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åï¼Œæˆ‘ä»¬å¼€å¯äº†åˆ†é¡µæ¨¡å¼ï¼š</p>
<ol type="1">
<li><code>self.page_table.token()</code> æŒ‰ç…§CSRè¦æ±‚å¼€å¯
<code>SV39</code> åˆ†é¡µæ¨¡å¼ï¼›</li>
<li><code>sfence.vma</code> å°†å¿«è¡¨æ¸…ç©ºã€‚</li>
</ol>
<figure>
<img src="/images/20251121/satp.png" alt="satp.png" />
<figcaption aria-hidden="true">satp.png</figcaption>
</figure>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">MemorySet</span> &#123;</span><br><span class="line">    <span class="comment">/// Change page table by writing satp CSR Register.</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">activate</span>(&amp;<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">satp</span> = <span class="keyword">self</span>.page_table.<span class="title function_ invoke__">token</span>();</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            satp::<span class="title function_ invoke__">write</span>(satp);</span><br><span class="line">            asm!(<span class="string">&quot;sfence.vma&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        info!(<span class="string">&quot;[kernel]: enable kernel space.&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="trampolineçš„å®ç°">trampolineçš„å®ç°</h3>
<blockquote>
<p>åœ¨ <a href="#trampoline">trampoline</a>
ä¸­æˆ‘ä»¬åˆ†æäº†ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·ä¸€ä¸ªä¸­é—´å±‚ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å®ç°ä»–çš„å…·ä½“é€»è¾‘ã€‚</p>
</blockquote>
<blockquote>
<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥è®¨è®ºä¸€ä¸‹å®ç°å†…æ ¸çš„ä¸¤ä¸ªæ–¹å¼ï¼š</p>
<ol type="1">
<li>æ¯ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´éƒ½ä¼šå°†é€»è¾‘æ®µåˆ†ä¸º <code>å†…æ ¸æ®µ</code> å’Œ
<code>ç”¨æˆ·æ®µ</code> ä¸¤ä¸ªéƒ¨åˆ†ï¼›</li>
<li>æ¯ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´å€¼åŒ…å« <code>ç”¨æˆ·æ®µ</code>ï¼Œä»–ä»¬å…±äº«ä¸€ä¸ª
<code>å†…æ ¸æ®µ</code>ã€‚</li>
</ol>
<p>ç¬¬ä¸€ç§æ–¹å¼çš„å¥½å¤„æ˜¯ï¼Œç”¨æˆ·å’Œå†…æ ¸çš„åˆ‡æ¢ä¸éœ€è¦åˆ‡æ¢åœ°å€ç©ºé—´ï¼Œåªéœ€è¦åœ¨è¿›ç¨‹ä¹‹é—´åˆ‡æ¢å†…æ ¸æ®µï¼Œè¿™æ ·å®ç°è¾ƒä¸ºç®€å•ã€‚ä½†æ˜¯å¸¦æ¥çš„é—®é¢˜æ˜¯ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½éœ€è¦å­˜å‚¨ä¸€ä»½å†—ä½™çš„å†…æ ¸ä»£ç ï¼Œæµªè´¹äº†å¤§é‡çš„å†…å­˜ã€‚</p>
<p>ç¬¬äºŒç§æ–¹å¼èŠ‚çœå†…å­˜ï¼Œä½†æ˜¯å®ç°è¾ƒä¸ºå¤æ‚ã€‚</p>
</blockquote>
<figure>
<img src="/images/20251121/memory.png" alt="memory.png" />
<figcaption aria-hidden="true">memory.png</figcaption>
</figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„TrapContext<strong>ä½äº
<code>åº”ç”¨åœ°å€ç©ºé—´çš„æ¬¡é«˜é¡µé¢</code>
è€Œä¸æ˜¯å†…æ ¸åœ°å€ç©ºé—´</strong>ã€‚åŸå› åœ¨äºï¼Œå‡å¦‚æˆ‘ä»¬å°†å…¶æ”¾åœ¨å†…æ ¸æ ˆ ä¸­ï¼Œåœ¨ä¿å­˜
Trap ä¸Šä¸‹æ–‡ä¹‹å‰æˆ‘ä»¬å¿…é¡»å…ˆåˆ‡æ¢åˆ°å†…æ ¸åœ°å€ç©ºé—´ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬åšä¸¤ä»¶äº‹ï¼š</p>
<ol type="1">
<li>å°†å†…æ ¸åœ°å€ç©ºé—´çš„ token å†™å…¥ satp å¯„å­˜å™¨ï¼Œæ³¨æ„ satp
ä¸æ˜¯å•çº¯çš„é¡µè¡¨åœ°å€ï¼Œå› ä¸ºå®ƒè¿˜æŒ‡å®šäº†CPUçš„åˆ†é¡µæ¨¡å¼ï¼›</li>
<li>ä¹‹åæˆ‘ä»¬è¿˜éœ€è¦æœ‰ä¸€ä¸ªé€šç”¨å¯„å­˜å™¨ä¿å­˜å†…æ ¸æ ˆæ ˆé¡¶çš„ä½ç½®ï¼Œè¿™æ ·æ‰èƒ½ä»¥å®ƒä¸ºåŸºå€ä¿å­˜
Trap ä¸Šä¸‹æ–‡ã€‚</li>
</ol>
<p>åœ¨ä¿å­˜ Trap ä¸Šä¸‹æ–‡ä¹‹å‰æˆ‘ä»¬å¿…é¡»å®Œæˆè¿™
ä¸¤é¡¹å·¥ä½œã€‚ç„¶è€Œï¼Œæˆ‘ä»¬æ— æ³•åœ¨ä¸ç ´åä»»ä½•ä¸€ä¸ªé€šç”¨å¯„å­˜å™¨çš„æƒ…å†µä¸‹åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>
<p>å› ä¸ºäº‹å®ä¸Šæˆ‘ä»¬éœ€è¦ç”¨åˆ°å†…æ ¸çš„ä¸¤æ¡ä¿¡æ¯ï¼šå†…æ ¸åœ°å€ç©ºé—´ çš„ token
è¿˜æœ‰åº”ç”¨å†…æ ¸æ ˆé¡¶çš„ä½ç½®ï¼Œç¡¬ä»¶å´åªæä¾›ä¸€ä¸ª <code>sscratch</code>
å¯ä»¥ç”¨æ¥è¿›è¡Œå‘¨è½¬ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸å¾—ä¸å°† Trap ä¸Šä¸‹æ–‡ä¿å­˜åœ¨
åº”ç”¨åœ°å€ç©ºé—´çš„ä¸€ä¸ªè™šæ‹Ÿé¡µé¢ä¸­ä»¥é¿å…åˆ‡æ¢åˆ°å†…æ ¸åœ°å€ç©ºé—´æ‰èƒ½ä¿å­˜ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">TrapContext</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> x: [<span class="type">usize</span>; <span class="number">32</span>],</span><br><span class="line">    <span class="keyword">pub</span> sstatus: Sstatus,</span><br><span class="line">    <span class="keyword">pub</span> sepc: <span class="type">usize</span>,</span><br><span class="line">    <span class="keyword">pub</span> kernel_satp: <span class="type">usize</span>,</span><br><span class="line">    <span class="keyword">pub</span> kernel_sp: <span class="type">usize</span>,</span><br><span class="line">    <span class="keyword">pub</span> trap_handler: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€çš„ TrapContext å¦‚ä¸‹å®šä¹‰ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">TrapContext</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> x: [<span class="type">usize</span>; <span class="number">32</span>],</span><br><span class="line">    <span class="keyword">pub</span> sstatus: Sstatus,</span><br><span class="line">    <span class="keyword">pub</span> sepc: <span class="type">usize</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›¸å¯¹äºä¹‹å‰ï¼Œé¢å¤–å¢åŠ äº† <code>kernel_satp</code>ï¼Œ
<code>kernel_sp</code>ï¼Œ <code>trap_handler</code> ä¸‰ä¸ªå­—æ®µï¼š</p>
<ul>
<li><code>kernel_satp</code> è¡¨ç¤ºå†…æ ¸åœ°å€ç©ºé—´çš„ token ï¼›</li>
<li><code>kernel_sp</code>
è¡¨ç¤ºå½“å‰åº”ç”¨åœ¨å†…æ ¸åœ°å€ç©ºé—´ä¸­çš„å†…æ ¸æ ˆæ ˆé¡¶çš„è™šæ‹Ÿåœ°å€ï¼›</li>
<li><code>trap_handler</code> è¡¨ç¤ºå†…æ ¸ä¸­ trap handler
å…¥å£ç‚¹çš„è™šæ‹Ÿåœ°å€ã€‚</li>
</ul>
<h2 id="rcore-åœ°å€ç©ºé—´æ‹“å±•å®ç°">rCore-åœ°å€ç©ºé—´æ‹“å±•å®ç°</h2>
<h3 id="sys_get_time">sys_get_time</h3>
<pre><code class="highlight mermaid">flowchart LR
    %% æ ·å¼å®šä¹‰ï¼ˆé¿å¼€å…³é”®å­—ï¼Œç”¨åˆæ³•è¯­æ³•ï¼‰
    classDef structStyle fill:#f0f8ff,stroke:#2c3e50,stroke-width:2px,rounded:10px
    classDef vaStyle fill:#fdf2f8,stroke:#9b59b6,stroke-width:2px,rounded:10px
    classDef vpnStyle fill:#fef7fb,stroke:#9b59b6,stroke-width:1px,rounded:8px,padding:10px
    classDef paStyle fill:#e8f4f8,stroke:#3498db,stroke-width:2px,rounded:10px
    classDef ppnStyle fill:#f0f8ff,stroke:#3498db,stroke-width:1px,rounded:8px,padding:10px
    classDef fieldStyle font-weight:bold,color:#2c3e50
    classDef connStyle stroke:#7f8c8d,stroke-width:1.5px,arrowheadStyle:fill:#7f8c8d

    %% ä¸Šå±‚ï¼šç»“æ„ä½“ï¼ˆè¿ç»­å­—æ®µï¼‰
    subgraph Struct[&quot;ğŸ“¦ TimeVal ç»“æ„ä½“ï¼ˆè¿ç»­è™šæ‹Ÿå†…å­˜è§†å›¾ï¼‰&quot;]
        direction TB
        sec[&quot;&lt;span class=&#x27;fieldStyle&#x27;&gt;sec&lt;/span&gt;&lt;br/&gt;usize (8å­—èŠ‚)&quot;]:::fieldStyle
        usec[&quot;&lt;span class=&#x27;fieldStyle&#x27;&gt;usec&lt;/span&gt;&lt;br/&gt;usize (8å­—èŠ‚)&quot;]:::fieldStyle
    end
    class Struct structStyle

    %% ä¸­å±‚ï¼šè™šæ‹Ÿåœ°å€ VAï¼ˆè¿ç»­ï¼Œè·¨2ä¸ªè™šæ‹Ÿé¡µï¼‰
    subgraph VA[&quot;ğŸŒ è™šæ‹Ÿåœ°å€ VAï¼ˆè¿ç»­ï¼‰&quot;]
        direction LR
        subgraph VPN0[&quot;VPN0ï¼ˆè™šæ‹Ÿé¡µ0ï¼‰&quot;]
            %% ä¿®æ­£ï¼šsec ä½äº VPN0 æœ«å°¾ï¼ŒVA = é¡µèµ·å§‹ + (4KB-8) = 0x40200000 + 0xFF8 = 0x40200FF8
            va_sec[&quot;0x40200FF8&lt;br/&gt;[é¡µå†…åç§»: 0xFF8 = 4KB-8]&quot;]
        end
        subgraph VPN1[&quot;VPN1ï¼ˆè™šæ‹Ÿé¡µ1ï¼‰&quot;]
            %% ä¿®æ­£ï¼šusec ä½äº VPN1 èµ·å§‹ï¼Œé¡µå†…åç§» 0x000
            va_usec[&quot;0x40201000&lt;br/&gt;[é¡µå†…åç§»: 0x000]&quot;]
        end
        note_va[&quot;é¡µå¤§å°ï¼š4KB (0x1000)&lt;br/&gt;VPN0èŒƒå›´ï¼š0x40200000~0x40200FFF&lt;br/&gt;VPN1èŒƒå›´ï¼š0x40201000~0x40201FFF&quot;]
        class note_va vaStyle
    end
    class VA vaStyle

    %% ä¸‹å±‚ï¼šç‰©ç†åœ°å€ PAï¼ˆç¦»æ•£ï¼‰
    subgraph PA[&quot;ğŸ’¾ ç‰©ç†åœ°å€ PAï¼ˆç¦»æ•£ï¼‰&quot;]
        subgraph PPN0[&quot;PPN0ï¼ˆç‰©ç†é¡µ0ï¼‰&quot;]
            %% ç‰©ç†é¡µ0èµ·å§‹ + åç§»0xFF8 = 0x8000 + 0xFF8 = 0x8FF8
            pa_sec[&quot;0x8FF8&lt;br/&gt;[é¡µå†…åç§»: 0xFF8]&quot;]
        end
        subgraph PPN1[&quot;PPN1ï¼ˆç‰©ç†é¡µ1ï¼‰&quot;]
            %% ç‰©ç†é¡µ1èµ·å§‹ + åç§»0x000 = 0x4000 + 0x000 = 0x4000
            pa_usec[&quot;0x4000&lt;br/&gt;[é¡µå†…åç§»: 0x000]&quot;]
        end
        note_pa[&quot;ç‰©ç†é¡µç‹¬ç«‹åˆ†é…ï¼Œåœ°å€ä¸è¿ç»­&lt;br/&gt;PPN0èŒƒå›´ï¼š0x8000~0x8FFF&lt;br/&gt;PPN1èŒƒå›´ï¼š0x4000~0x4FFF&quot;]
        class note_pa paStyle
    end
    class PA paStyle

    %% æ˜ å°„å…³ç³»ï¼ˆå­—æ®µ â†’ VA â†’ PAï¼‰
    sec -.-&gt;|å­—æ®µå¯¹åº”VA| va_sec:::connStyle
    usec -.-&gt;|å­—æ®µå¯¹åº”VA| VPN1:::connStyle
    va_sec -.-&gt;|é¡µè¡¨ç¿»è¯‘ï¼ˆVPN0â†’PPN0ï¼‰| pa_sec:::connStyle
    va_usec -.-&gt;|é¡µè¡¨ç¿»è¯‘ï¼ˆVPN1â†’PPN1ï¼‰| pa_usec:::connStyle

    %% æ ¸å¿ƒç»“è®ºæ ‡æ³¨ï¼ˆçªå‡ºé—®é¢˜ï¼‰
    conclusion[&quot;âš ï¸  æ ¸å¿ƒé—®é¢˜ï¼š&lt;br/&gt;ç»“æ„ä½“VAè¿ç»­ï¼ˆè·¨é¡µè¾¹ç•Œï¼‰ï¼Œä½†æ˜ å°„çš„PAç¦»æ•£&lt;br/&gt;å†…æ ¸éœ€æ‹†ä¸º2æ®µå†™å…¥ï¼š&lt;br/&gt;1. PPN0çš„0x8FF8~0x8FFFï¼ˆ6å­—èŠ‚ï¼Ÿä¸ï¼Œ8å­—èŠ‚åˆšå¥½ï¼‰&lt;br/&gt;2. PPN1çš„0x4000~0x4007&quot;]:::structStyle
    PA -.-&gt;|ä½“ç°| conclusion:::connStyle</code></pre>
<blockquote>
<p>åœ¨å¼•å…¥è™šæ‹Ÿå†…å­˜ä¹‹åï¼Œ<code>sys_get_time</code>
çš„åŸæœ¬å®ç°å·²ç»å¤±æ•ˆï¼Œæˆ‘ä»¬ç°åœ¨é‡æ–°å®ç°è¯¥é€»è¾‘ã€‚</p>
</blockquote>
<p>æ–°å¢ <code>sys_get_time</code>
é€»è¾‘ç›¸å½“ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦å¤ç”¨ä¹‹å‰çš„ç³»ç»Ÿæ—¶é’Ÿè·å–æ—¶é—´æˆ³ï¼Œåœ¨å†…æ ¸æ€æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€å¹¶æ›´æ–°å³å¯ï¼Œä½†æ˜¯ä»ç„¶æœ‰å‡ ä¸ªå€¼å¾—ç•™æ„çš„ç‚¹ï¼š</p>
<ol type="1">
<li>ç”¨æˆ·ç¨‹åºä½¿ç”¨çš„æ˜¯
VAï¼Œæ‰€ä»¥ä»–çš„æŒ‡é’ˆä¼ åˆ°kernelæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒè½¬æ¢ä¸ºPAï¼›</li>
<li>å¦‚æœç”¨æˆ·æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼Œä¸åœ¨åŒä¸€é¡µæ€ä¹ˆåŠï¼Ÿä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œæˆ‘ä»¬çš„é¡µå¤§å°æ˜¯4KBï¼Œæˆ‘ä»¬çš„å¯¹è±¡å¤§å°è¶…è¿‡äº†4KBï¼Œé‚£ä»–å¿…ç„¶è¢«åˆ†åˆ°ä¸¤é¡µ
--
<strong>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬é¢ä¸´çš„é—®é¢˜æ˜¯ï¼Œå¯¹äºç”¨æˆ·ç¨‹åºæ¥è®²ï¼ŒVAæ˜¯è¿ç»­çš„ï¼›ä½†æ˜¯å¯¹äºå†…æ ¸æ¥è®²ï¼ŒPAä¸ä¸€å®šæ˜¯è¿ç»­çš„ï¼</strong></li>
</ol>
<p>æˆ‘ä»¬çš„å®ç°å°±å¿…é¡»å¤„ç†å†…å­˜åˆ†æ®µæ˜ å°„è¿™ä¸ªé€»è¾‘ï¼Œå…·ä½“çš„å®ç°å¯ä»¥æŸ¥çœ‹è¿™ä¸ª <a
target="_blank" rel="noopener" href="https://github.com/LearningOS/2025a-rcore-0x822a5b87/commit/c64709a084641f8585b14d8930e7c5b4ed0abe90">commit</a>ã€‚</p>
<blockquote>
<p>åœ¨ <code>io.rs</code> ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†å°†structæŠ“æ¢ä¸º <code>[u8]</code>
çš„é€»è¾‘ã€‚</p>
</blockquote>
<h4 id="serialize_struct">serialize_struct</h4>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// write the struct to physical address range</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">serialize_struct</span>&lt;S&gt;(s: &amp;S, pa_range: <span class="type">Vec</span>&lt;&amp;<span class="symbol">&#x27;static</span> <span class="keyword">mut</span> [<span class="type">u8</span>]&gt;) <span class="keyword">where</span> S: SerializeToBytes &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">bytes</span> = s.<span class="title function_ invoke__">as_bytes</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">bytes_written</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">slice</span> <span class="keyword">in</span> pa_range &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">len</span> = slice.<span class="title function_ invoke__">len</span>().<span class="title function_ invoke__">min</span>(bytes.<span class="title function_ invoke__">len</span>() - bytes_written);</span><br><span class="line">        slice[..len].<span class="title function_ invoke__">copy_from_slice</span>(&amp;bytes[bytes_written..bytes_written + len]);</span><br><span class="line">        bytes_written += len;</span><br><span class="line">        <span class="keyword">if</span> bytes_written &gt;= bytes.<span class="title function_ invoke__">len</span>() &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="serializetobytes">SerializeToBytes</h4>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// io.rust</span></span><br><span class="line"><span class="comment">/// structs that implement this trait can be serialized to and deserialized from byte slices</span></span><br><span class="line"><span class="meta">#[allow(dead_code)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">trait</span> <span class="title class_">SerializeToBytes</span>: <span class="built_in">Copy</span> + <span class="symbol">&#x27;static</span> &#123;</span><br><span class="line">    <span class="comment">/// serialize struct with specific trait to byte slice</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">as_bytes</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;[<span class="type">u8</span>] &#123;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123;</span><br><span class="line">            core::slice::<span class="title function_ invoke__">from_raw_parts</span>(</span><br><span class="line">                <span class="keyword">self</span> <span class="keyword">as</span> *<span class="keyword">const</span> <span class="keyword">Self</span> <span class="keyword">as</span> *<span class="keyword">const</span> <span class="type">u8</span>,</span><br><span class="line">                core::mem::size_of::&lt;<span class="keyword">Self</span>&gt;(),</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// deserialize byte slice to struct with specific trait</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">from_bytes</span>(bytes: &amp;[<span class="type">u8</span>]) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;&amp;<span class="keyword">Self</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> bytes.<span class="title function_ invoke__">len</span>() != core::mem::size_of::&lt;<span class="keyword">Self</span>&gt;() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">unsafe</span> &#123; <span class="title function_ invoke__">Some</span>(&amp;*(bytes.<span class="title function_ invoke__">as_ptr</span>() <span class="keyword">as</span> *<span class="keyword">const</span> <span class="keyword">Self</span>)) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>åœ¨ <code>mm.rs</code> ä¸­ï¼Œæˆ‘ä»¬å¤„ç†äº†å°† <code>[u8]</code>
åˆ†æ®µçš„å¤åˆ¶åˆ°ç‰©ç†å†…å­˜çš„é€»è¾‘ã€‚</p>
</blockquote>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// mm.rs</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//! utilities for memory management</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> crate::mm::&#123;PageTable, StepByOne, VirtAddr, VirtPageNum&#125;;</span><br><span class="line"><span class="keyword">use</span> alloc::vec::<span class="type">Vec</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Translate a virtual address to a physical address through page table</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">translate_va_to_pa</span>(token: <span class="type">usize</span>, ptr: *<span class="keyword">const</span> <span class="type">u8</span>, len: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;&amp;<span class="symbol">&#x27;static</span> <span class="keyword">mut</span> [<span class="type">u8</span>]&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">v</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">page_table</span> = PageTable::<span class="title function_ invoke__">from_token</span>(token);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">start</span> = ptr <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">end</span> = start + len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> start &lt; end &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">start_va</span> = VirtAddr::<span class="title function_ invoke__">from</span>(start);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vpn</span> = VirtPageNum::<span class="title function_ invoke__">from</span>(start_va.<span class="title function_ invoke__">floor</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">ppn</span> = page_table.<span class="title function_ invoke__">translate</span>(vpn).<span class="title function_ invoke__">unwrap</span>().<span class="title function_ invoke__">ppn</span>();</span><br><span class="line">        vpn.<span class="title function_ invoke__">step</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">end_va</span> = VirtAddr::<span class="title function_ invoke__">from</span>(end.<span class="title function_ invoke__">min</span>(VirtAddr::<span class="title function_ invoke__">from</span>(vpn).<span class="title function_ invoke__">into</span>()));</span><br><span class="line">        <span class="keyword">if</span> end_va.<span class="title function_ invoke__">aligned</span>() &#123;</span><br><span class="line">            v.<span class="title function_ invoke__">push</span>(&amp;<span class="keyword">mut</span> ppn.<span class="title function_ invoke__">get_bytes_array</span>()[start_va.<span class="title function_ invoke__">page_offset</span>()..]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            v.<span class="title function_ invoke__">push</span>(&amp;<span class="keyword">mut</span> ppn.<span class="title function_ invoke__">get_bytes_array</span>()[start_va.<span class="title function_ invoke__">page_offset</span>()..end_va.<span class="title function_ invoke__">page_offset</span>()]);</span><br><span class="line">        &#125;</span><br><span class="line">        start = end_va.<span class="title function_ invoke__">into</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    v</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="sys_trace">sys_trace</h3>
<blockquote>
<p>è¿™é‡Œå†è´´ä¸€ä¸‹ <code>sys_trace</code> çš„å®ç°è¦æ±‚ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">sys_trace</span>(_trace_request: <span class="type">usize</span>, _id: <span class="type">usize</span>, _data: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">isize</span></span><br></pre></td></tr></table></figure>
<ul>
<li>è°ƒç”¨è§„èŒƒï¼šè¿™ä¸ªç³»ç»Ÿè°ƒç”¨æœ‰ä¸‰ç§åŠŸèƒ½ï¼Œæ ¹æ® <code>trace_request</code>
çš„å€¼ä¸åŒï¼Œæ‰§è¡Œä¸åŒçš„æ“ä½œï¼š
<ul>
<li>å¦‚æœ <code>trace_request</code> ä¸º 0ï¼Œåˆ™ <code>id</code> åº”è¢«è§†ä½œ
<code>*const u8</code> ï¼Œè¡¨ç¤ºè¯»å–å½“å‰ä»»åŠ¡ <code>id</code>
åœ°å€å¤„ä¸€ä¸ªå­—èŠ‚çš„æ— ç¬¦å·æ•´æ•°å€¼ã€‚æ­¤æ—¶åº”å¿½ç•¥ <code>data</code>
å‚æ•°ã€‚è¿”å›å€¼ä¸º <code>id</code> åœ°å€å¤„çš„å€¼ã€‚</li>
<li>å¦‚æœ <code>trace_request</code> ä¸º 1ï¼Œåˆ™ <code>id</code> åº”è¢«è§†ä½œ
<code>*mut u8</code> ï¼Œè¡¨ç¤ºå†™å…¥ <code>data</code> ï¼ˆä½œä¸º
<code>u8</code>ï¼Œå³åªè€ƒè™‘æœ€ä½ä½çš„ä¸€ä¸ªå­—èŠ‚ï¼‰åˆ°è¯¥ç”¨æˆ·ç¨‹åº <code>id</code>
åœ°å€å¤„ã€‚è¿”å›å€¼åº”ä¸º0ã€‚</li>
<li>å¦‚æœ <code>trace_request</code> ä¸º 2ï¼Œè¡¨ç¤ºæŸ¥è¯¢å½“å‰ä»»åŠ¡è°ƒç”¨ç¼–å·ä¸º
<code>id</code>
çš„ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ï¼Œè¿”å›å€¼ä¸ºè¿™ä¸ªè°ƒç”¨æ¬¡æ•°ã€‚<strong>æœ¬æ¬¡è°ƒç”¨ä¹Ÿè®¡å…¥ç»Ÿè®¡</strong>
ã€‚å¦åˆ™ï¼Œå¿½ç•¥å…¶ä»–å‚æ•°ï¼Œè¿”å›å€¼ä¸º -1ã€‚</li>
</ul></li>
<li>è¯´æ˜ï¼š
<ul>
<li>ä½ å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œè¿™ä¸ªè°ƒç”¨çš„è¯»å†™å¹¶ä¸å®‰å…¨ï¼Œä½¿ç”¨ä¸å½“å¯èƒ½å¯¼è‡´å´©æºƒã€‚è¿™æ˜¯å› ä¸ºåœ¨ä¸‹ä¸€ç« èŠ‚å®ç°åœ°å€ç©ºé—´ä¹‹å‰ï¼Œç³»ç»Ÿä¸­ç¼ºä¹éš”ç¦»æœºåˆ¶ã€‚æ‰€ä»¥æˆ‘ä»¬
<strong>ä¸è¦æ±‚ä½ å®ç°å®‰å…¨æ£€æŸ¥æœºåˆ¶ï¼Œåªéœ€é€šè¿‡æµ‹è¯•ç”¨ä¾‹å³å¯</strong> ã€‚</li>
<li>ä½ è¿˜å¯èƒ½æ³¨æ„åˆ°ï¼Œè¿™ä¸ªç³»ç»Ÿè°ƒç”¨è¯»å†™æœ¬ä»»åŠ¡å†…å­˜çš„åŠŸèƒ½å¹¶ä¸æ˜¯å¾ˆæœ‰ç”¨ã€‚è¿™æ˜¯å› ä¸ºä½œä¸šçš„çµæ„Ÿæ¥æº
syscall ä¸»è¦ä¾é  trace
åŠŸèƒ½è¿½è¸ªå…¶ä»–ä»»åŠ¡çš„ä¿¡æ¯ï¼Œä½†åœ¨æœ¬ç« èŠ‚æˆ‘ä»¬è¿˜æ²¡æœ‰è¿›ç¨‹ã€çº¿ç¨‹ç­‰æ¦‚å¿µï¼Œæ‰€ä»¥ç®€åŒ–äº†æ“ä½œï¼Œåªè¦æ±‚è¿½è¸ªè‡ªèº«çš„ä¿¡æ¯ã€‚</li>
</ul></li>
<li>æ­¤å¤–ï¼Œç”±äºæœ¬ç« æˆ‘ä»¬æœ‰äº†åœ°å€ç©ºé—´ä½œä¸ºéš”ç¦»æœºåˆ¶ï¼Œæ‰€ä»¥
<code>sys_trace</code> <strong>éœ€è¦è€ƒè™‘ä¸€äº›é¢å¤–çš„æƒ…å†µ</strong>ï¼š
<ul>
<li>åœ¨è¯»å–ï¼ˆ<code>trace_request</code> ä¸º
0ï¼‰æ—¶ï¼Œå¦‚æœå¯¹åº”åœ°å€ç”¨æˆ·ä¸å¯è§æˆ–ä¸å¯è¯»ï¼Œåˆ™è¿”å›å€¼åº”ä¸º
-1ï¼ˆ<code>isize</code> æ ¼å¼çš„ -1ï¼Œè€Œé <code>u8</code>ï¼‰ã€‚</li>
<li>åœ¨å†™å…¥ï¼ˆ<code>trace_request</code> ä¸º
1ï¼‰æ—¶ï¼Œå¦‚æœå¯¹åº”åœ°å€ç”¨æˆ·ä¸å¯è§æˆ–ä¸å¯å†™ï¼Œåˆ™è¿”å›å€¼åº”ä¸º
-1ï¼ˆ<code>isize</code> æ ¼å¼çš„ -1ï¼Œè€Œé <code>u8</code>ï¼‰ã€‚</li>
</ul></li>
</ul>
</blockquote>
<p>æœ¬ç¨‹åºçš„å®ç°ä¾ç„¶æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯è€ƒè™‘åˆ°<strong>ä»ç‰©ç†å†…å­˜ä¸­<code>è¯»æ•°æ®</code>ä¸<code>å†™æ•°æ®</code></strong>æ˜¯ä¸€ä¸ªç›¸å½“é€šç”¨çš„éœ€æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„éœ€è¦æŠ½è±¡ä¸¤ä¸ªç‹¬ç«‹çš„å‡½æ•°æ¥å¸®åŠ©æˆ‘ä»¬å®Œæˆï¼Œå®Œæ•´çš„ä»£ç è¯·æŸ¥çœ‹
<a
target="_blank" rel="noopener" href="https://github.com/LearningOS/2025a-rcore-0x822a5b87/commit/90334f3d41b6265d3925938ea91b981748236099">commit</a>ã€‚</p>
<h4 id="read">read</h4>
<p>å‡½æ•°çš„é€»è¾‘éå¸¸ç®€å•ï¼Œå°±æ˜¯å°† <code>è¿ç»­çš„VA</code> æ˜ å°„ä¸ºä¸€ä¸ª
<code>å¯èƒ½åˆ†æ®µçš„PA</code>ï¼Œå¹¶è¿”å› <code>pa_range</code>
çš„å¼•ç”¨ï¼Œå†ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„ <code>from_bytes</code>
æ¥å£å°†æ•°æ®ååºåˆ—åŒ–æˆå¯¹åº”çš„å¯¹è±¡ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// read `S` from physical address range</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">read</span>&lt;S&gt;(token: <span class="type">usize</span>, ptr: *<span class="keyword">const</span> <span class="type">u8</span>, len: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;S, &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    S: SerializeToBytes,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">flags</span> = PTEFlags::V | PTEFlags::A | PTEFlags::R;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">auth</span> = <span class="title function_ invoke__">auth_check</span>(token, ptr, len, flags);</span><br><span class="line">    <span class="keyword">if</span> !auth &#123;</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(<span class="string">&quot;unauthorized access&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">pa_range</span> = crate::util::mm::<span class="title function_ invoke__">translate_va_to_pa</span>(token, ptr, len);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">data</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">        <span class="keyword">for</span> <span class="variable">slice</span> <span class="keyword">in</span> pa_range &#123;</span><br><span class="line">            data.<span class="title function_ invoke__">extend_from_slice</span>(slice);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">x</span> = S::<span class="title function_ invoke__">from_bytes</span>(&amp;data).<span class="title function_ invoke__">copied</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">res</span> = <span class="keyword">match</span> x &#123;</span><br><span class="line">            <span class="title function_ invoke__">Some</span>(v) =&gt; <span class="title function_ invoke__">Ok</span>(v),</span><br><span class="line">            <span class="literal">None</span> =&gt; <span class="title function_ invoke__">Err</span>(<span class="string">&quot;failed to deserialize&quot;</span>),</span><br><span class="line">        &#125;;</span><br><span class="line">        res</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="write">write</h4>
<p><code>write</code> ä¹Ÿæ˜¯åŒæ ·çš„æ€è·¯ï¼Œå°† <code>è¿ç»­çš„VA</code>
æ˜ å°„ä¸ºä¸€ä¸ª <code>å¯èƒ½åˆ†æ®µçš„PA</code>ï¼Œå¹¶è¿”å› <code>pa_range</code>
çš„å¼•ç”¨ï¼Œä½¿ç”¨æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„ <a
href="#serialize_struct">serialize_struct</a> æ¥åºåˆ—åŒ–åˆ°ç‰©ç†å†…å­˜ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// write `S` to physical address range</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">write</span>&lt;S&gt;(s: &amp;S, token: <span class="type">usize</span>, ptr: *<span class="keyword">const</span> <span class="type">u8</span>, len: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;<span class="type">usize</span>, &amp;<span class="symbol">&#x27;static</span> <span class="type">str</span>&gt;</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    S: SerializeToBytes,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">flags</span> = PTEFlags::V | PTEFlags::A | PTEFlags::R;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">auth</span> = <span class="title function_ invoke__">auth_check</span>(token, ptr, len, flags);</span><br><span class="line">    <span class="keyword">if</span> !auth &#123;</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(<span class="string">&quot;unauthorized access&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">pa_range</span> = crate::util::mm::<span class="title function_ invoke__">translate_va_to_pa</span>(token, ptr, len);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">serialized_size</span> = <span class="title function_ invoke__">serialize_struct</span>(s, pa_range);</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(serialized_size)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="auth_check">auth_check</h4>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬ä¸èƒ½ä¿¡ä»»ç”¨æˆ·ä¼ é€’çš„æ•°æ®ï¼Œæˆ‘ä»¬å¿…é¡»è¦å¯¹åœ°å€è¿›è¡Œæ£€éªŒ --
<strong>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæƒé™çš„æ£€éªŒæ˜¯ä»¥PTEä½œä¸ºå•ä½æ¥æ£€éªŒçš„ã€‚</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Check whether a virtual address range has the required permissions</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">auth_check</span>(token: <span class="type">usize</span>, ptr: *<span class="keyword">const</span> <span class="type">u8</span>, len: <span class="type">usize</span>, auth_flags: PTEFlags) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">pte_list</span> = <span class="title function_ invoke__">translate_entries</span>(token, ptr, len);</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">pte</span> <span class="keyword">in</span> pte_list &#123;</span><br><span class="line">        <span class="keyword">if</span> pte.<span class="title function_ invoke__">flags</span>() &amp; auth_flags != auth_flags &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="translate_entries">translate_entries</h4>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Get all entries of a virtual address range</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">translate_entries</span>(token: <span class="type">usize</span>, ptr: *<span class="keyword">const</span> <span class="type">u8</span>, len: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">Vec</span>&lt;PageTableEntry&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">v</span> = <span class="type">Vec</span>::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">page_table</span> = PageTable::<span class="title function_ invoke__">from_token</span>(token);</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">start</span> = ptr <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">end</span> = start + len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> start &lt; end &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">start_va</span> = VirtAddr::<span class="title function_ invoke__">from</span>(start);</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">vpn</span> = VirtPageNum::<span class="title function_ invoke__">from</span>(start_va.<span class="title function_ invoke__">floor</span>());</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">pte</span> = page_table.<span class="title function_ invoke__">translate</span>(vpn).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">        v.<span class="title function_ invoke__">push</span>(pte);</span><br><span class="line">        vpn.<span class="title function_ invoke__">step</span>();</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">end_va</span> = VirtAddr::<span class="title function_ invoke__">from</span>(end.<span class="title function_ invoke__">min</span>(VirtAddr::<span class="title function_ invoke__">from</span>(vpn).<span class="title function_ invoke__">into</span>()));</span><br><span class="line">        start = end_va.<span class="title function_ invoke__">into</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    v</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="mmap-å’Œ-munmap">mmap å’Œ munmap</h3>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/mmap.2.html">mmap</a>
åœ¨ Linux ä¸­ä¸»è¦ç”¨äºåœ¨å†…å­˜ä¸­æ˜ å°„æ–‡ä»¶ï¼Œ
æœ¬æ¬¡å®éªŒç®€åŒ–å®ƒçš„åŠŸèƒ½ï¼Œä»…ç”¨äºç”³è¯·å†…å­˜ã€‚</p>
<p>è¯·å®ç° mmap å’Œ munmap ç³»ç»Ÿè°ƒç”¨ï¼Œmmap å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">fn</span> <span class="title function_">sys_mmap</span>(start: <span class="type">usize</span>, len: <span class="type">usize</span>, prot: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="type">isize</span></span><br></pre></td></tr></table></figure>
<ul>
<li>syscall IDï¼š222</li>
<li>ç”³è¯·é•¿åº¦ä¸º len
å­—èŠ‚çš„ç‰©ç†å†…å­˜ï¼ˆä¸è¦æ±‚å®é™…ç‰©ç†å†…å­˜ä½ç½®ï¼Œå¯ä»¥éšä¾¿æ‰¾ä¸€å—ï¼‰ï¼Œå°†å…¶æ˜ å°„åˆ°
start å¼€å§‹çš„è™šå­˜ï¼Œå†…å­˜é¡µå±æ€§ä¸º prot</li>
<li>å‚æ•°</li>
<li>start éœ€è¦æ˜ å°„çš„è™šå­˜èµ·å§‹åœ°å€ï¼Œè¦æ±‚æŒ‰é¡µå¯¹é½len æ˜ å°„å­—èŠ‚é•¿åº¦ï¼Œå¯ä»¥ä¸º
0</li>
<li>protï¼šç¬¬ 0 ä½è¡¨ç¤ºæ˜¯å¦å¯è¯»ï¼Œç¬¬ 1 ä½è¡¨ç¤ºæ˜¯å¦å¯å†™ï¼Œç¬¬ 2
ä½è¡¨ç¤ºæ˜¯å¦å¯æ‰§è¡Œã€‚å…¶ä»–ä½æ— æ•ˆä¸”å¿…é¡»ä¸º 0</li>
<li>è¿”å›å€¼ï¼šæ‰§è¡ŒæˆåŠŸåˆ™è¿”å› 0ï¼Œé”™è¯¯è¿”å› -1</li>
<li>è¯´æ˜ï¼šä¸ºäº†ç®€å•ï¼Œç›®æ ‡è™šå­˜åŒºé—´è¦æ±‚æŒ‰é¡µå¯¹é½ï¼Œlen
å¯ç›´æ¥æŒ‰é¡µå‘ä¸Šå–æ•´ï¼Œä¸è€ƒè™‘åˆ†é…å¤±è´¥æ—¶çš„é¡µå›æ”¶ã€‚</li>
</ul>
</blockquote>
<p>æœ¬æ¬¡å®éªŒçš„å…¨éƒ¨ä»£ç ï¼Œè¯·æŸ¥çœ‹ <a
target="_blank" rel="noopener" href="https://github.com/LearningOS/2025a-rcore-0x822a5b87/commit/a672c7113f73d7878c388f30ab0bbb6e12dc5b43">commit</a></p>
<p>æœ¬å®éªŒçš„æ€è·¯ä¹Ÿç›¸å½“ç®€å•ï¼Œåªæ˜¯åœ¨å¼€å‘è¿‡ç¨‹ä¸­éœ€è¦å¤„ç†çš„ç»†èŠ‚è¾ƒå¤šã€‚æˆ‘ä»¬æ ¹æ®é”™è¯¯è°ƒè¯•å³å¯ã€‚æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯å½“æ‰§è¡Œmmapæ—¶ï¼Œç”Ÿæˆä¸€ä¸ª
<code>MapArea</code> å¹¶è®°å½•ï¼›å½“æ‰§è¡Œmunmapæ—¶ï¼Œåˆ é™¤ç”Ÿæˆçš„
<code>MapArea</code>ï¼Œ<code>RAII</code>
ä¼šè‡ªåŠ¨çš„å›æ”¶æˆ‘ä»¬åˆ†é…çš„ç‰©ç†é¡µé¢ã€‚</p>
<h4 id="insert_mapped_area">insert_mapped_area</h4>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// insert_mapped_area</span></span><br><span class="line">   <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">insert_mapped_area</span>(</span><br><span class="line">       &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">       start_va: VirtAddr,</span><br><span class="line">       end_va: VirtAddr,</span><br><span class="line">       permission: MapPermission,</span><br><span class="line">   ) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">String</span>&gt; &#123;</span><br><span class="line">       <span class="keyword">let</span> <span class="variable">map_area</span> = MapArea::<span class="title function_ invoke__">new</span>(start_va, end_va, MapType::Framed, permission);</span><br><span class="line">       <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(v) = <span class="keyword">self</span>.<span class="title function_ invoke__">intersect_map_area</span>(&amp;map_area) &#123;</span><br><span class="line">           trace!(</span><br><span class="line">               <span class="string">&quot;[MemorySet]: intersected with existing area: l = &#123;:?&#125;, r = &#123;:?&#125;&quot;</span>,</span><br><span class="line">               map_area.vpn_range,</span><br><span class="line">               v.vpn_range</span><br><span class="line">           );</span><br><span class="line">           <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(</span><br><span class="line">               <span class="string">&quot;[MemorySet]: insert_mapped_area failed due to intersecting with existing area&quot;</span>,</span><br><span class="line">           ));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">self</span>.<span class="title function_ invoke__">mmap</span>(map_area);</span><br><span class="line">       <span class="title function_ invoke__">Ok</span>(())</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="delete_mapped_area">delete_mapped_area</h4>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// delete_mapped_area</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">delete_mapped_area</span>(</span><br><span class="line">    &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">    start_va: VirtAddr,</span><br><span class="line">    end_va: VirtAddr,</span><br><span class="line">    permission: MapPermission,</span><br><span class="line">) <span class="punctuation">-&gt;</span> <span class="type">Result</span>&lt;(), <span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">map_area</span> = MapArea::<span class="title function_ invoke__">new</span>(start_va, end_va, MapType::Framed, permission);</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">None</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">intersect_map_area</span>(&amp;map_area) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">Err</span>(<span class="type">String</span>::<span class="title function_ invoke__">from</span>(</span><br><span class="line">            <span class="string">&quot;[MemorySet]: no existing map area has been found!&quot;</span>,</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">unmap</span>(map_area)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="qa">QA</h2>
<h3 id="trapcontextçš„åˆå§‹åŒ–">TrapContextçš„åˆå§‹åŒ–</h3>
<blockquote>
<p>å†å›å¿†ä¸€æ¬¡ <code>TaskContext</code> å’Œ <code>TrapContext</code>
çš„åŒºåˆ«ï¼š</p>
<p>TrapContext
æ˜¯åº”ç”¨å’Œå†…æ ¸åˆ‡æ¢æ—¶çš„ä¸Šä¸‹æ–‡ï¼Œè€ŒTaskContextæ˜¯åº”ç”¨ä¹‹é—´åˆ‡æ¢çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</p>
<p>TrapContext
æ˜¯ä¸å¯é¢„æµ‹çš„ï¼Œæ‰€ä»¥ä»–éœ€è¦ä¿å­˜å…¨éƒ¨çš„å¯„å­˜å™¨ã€‚è€ŒTaskContextæ˜¯ç”¨æˆ·åŸºäºæ—¶é’Ÿæˆ–è€…ä¸»åŠ¨è°ƒç”¨çš„ï¼Œæ˜¯å¯é¢„æµ‹çš„ï¼Œæ‰€ä»¥åªéœ€è¦ä¿å­˜callee-savedå¯„å­˜å™¨ã€‚</p>
</blockquote>
<p><code>TrapContext</code>
æ˜¯å’Œåº”ç”¨å¼ºç»‘å®šçš„ï¼Œå†…æ ¸åœ¨åˆå§‹åŒ–åº”ç”¨æ—¶ï¼Œä¼šä¸ºæ¯ä¸€ä¸ªåº”ç”¨åˆå§‹åŒ–ä¸€ä¸ª
<code>TaskControlBlock(TCB)</code>ï¼Œè€Œ TrapContext å°±æ˜¯ TCB
çš„ä¸€éƒ¨åˆ†ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// The task control block (TCB) of a task.</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">TaskControlBlock</span> &#123;</span><br><span class="line">		<span class="comment">/// ...</span></span><br><span class="line">    <span class="comment">/// The phys page number of trap context</span></span><br><span class="line">    <span class="keyword">pub</span> trap_cx_ppn: PhysPageNum,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„ <code>TrapContext</code>
å®é™…ä¸Šæ˜¯å•ç‹¬çš„ä¸€ä¸ªå†…å­˜é¡µï¼ŒTrapContext çš„è™šæ‹Ÿåœ°å€æ˜¯
<code>0xffff_ffff_ffff_e000</code>ï¼ˆTRAP_CONTEXT_BASEï¼‰ï¼Œtrampoline
çš„è™šæ‹Ÿåœ°å€æ˜¯ <code>0xffff_ffff_ffff_f000</code>ï¼ˆTRAMPOLINEï¼‰â€”â€” ä¸¤è€…æ˜¯
<strong>è¿ç»­çš„ä¸¤ä¸ªé«˜åœ°å€é¡µ</strong>ï¼ŒTrapContext ç´§é‚» trampoline çš„
â€œä¸‹æ–¹â€ï¼ˆä½åœ°å€ä¾§ï¼‰ --
å¯¹äºä»»æ„ä¸€ä¸ªè¿›ç¨‹ï¼Œå®ƒçš„TrapContextçš„è™šæ‹Ÿåœ°å€æ˜¯å›ºå®šçš„ï¼</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">TaskControlBlock</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(elf_data: &amp;[<span class="type">u8</span>], app_id: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="comment">// memory_set with elf program headers/trampoline/trap context/user stack</span></span><br><span class="line">        <span class="keyword">let</span> (memory_set, user_sp, entry_point) = MemorySet::<span class="title function_ invoke__">from_elf</span>(elf_data);</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">trap_cx_ppn</span> = memory_set</span><br><span class="line">            .<span class="title function_ invoke__">translate</span>(VirtAddr::<span class="title function_ invoke__">from</span>(TRAP_CONTEXT_BASE).<span class="title function_ invoke__">into</span>())</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">            .<span class="title function_ invoke__">ppn</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œå®ƒè¢«å½“åšä¸€ä¸ªé€»è¾‘æ®µï¼Œåœ¨ç”¨æˆ·å†…å­˜åœ°å€åˆå§‹åŒ–çš„æ—¶å€™è¢«åˆå§‹åŒ–ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">MemorySet</span> &#123;</span><br><span class="line">  <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">from_elf</span>(elf_data: &amp;[<span class="type">u8</span>]) <span class="punctuation">-&gt;</span> (<span class="keyword">Self</span>, <span class="type">usize</span>, <span class="type">usize</span>) &#123;</span><br><span class="line">        <span class="comment">// map TrapContext</span></span><br><span class="line">        memory_set.<span class="title function_ invoke__">push</span>(</span><br><span class="line">            MapArea::<span class="title function_ invoke__">new</span>(</span><br><span class="line">                TRAP_CONTEXT_BASE.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">                TRAMPOLINE.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">                MapType::Framed,</span><br><span class="line">                MapPermission::R | MapPermission::W,</span><br><span class="line">            ),</span><br><span class="line">            <span class="literal">None</span>,</span><br><span class="line">        );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="sscratch">sscratch</h3>
<blockquote>
<p>å…ˆè¯´ç»“è®ºï¼Œ<code>sscratch</code> æ˜¯ <code>trap_return</code>
å‡½æ•°ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œä½¿ç”¨ <code>TRAP_CONTEXT_BASE</code>
åˆå§‹åŒ–çš„ä¸€ä¸ªæŒ‡å‘ <code>TrapContext</code> çš„æŒ‡é’ˆã€‚</p>
</blockquote>
<p>åœ¨ç”¨æˆ·è¿›ç¨‹å¯åŠ¨æ—¶ï¼Œå†…æ ¸ä¼šä¸ºæ¯ä¸ªè¿›ç¨‹åˆå§‹åŒ– TaskControlBlockï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lazy_static! &#123;</span><br><span class="line">    <span class="comment">/// a `TaskManager` global instance through lazy_static!</span></span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">static</span> <span class="keyword">ref</span> TASK_MANAGER: TaskManager = &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..num_app &#123;</span><br><span class="line">            tasks.<span class="title function_ invoke__">push</span>(TaskControlBlock::<span class="title function_ invoke__">new</span>(<span class="title function_ invoke__">get_app_data</span>(i), i));			<span class="comment">/// init TCB here</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œåœ¨åˆå§‹åŒ– TaskControlBlock çš„è¿‡ç¨‹ä¸­ï¼Œä¼šåˆå§‹åŒ–
<code>TaskContext</code></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">TaskControlBlock</span> &#123;</span><br><span class="line">  <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(elf_data: &amp;[<span class="type">u8</span>], app_id: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">task_control_block</span> = <span class="keyword">Self</span> &#123;</span><br><span class="line">            task_status,</span><br><span class="line">            task_cx: TaskContext::<span class="title function_ invoke__">goto_trap_return</span>(kernel_stack_top),			<span class="comment">/// init task context</span></span><br><span class="line">            memory_set,</span><br><span class="line">            trap_cx_ppn,</span><br><span class="line">            base_size: user_sp,</span><br><span class="line">            heap_bottom: user_sp,</span><br><span class="line">            program_brk: user_sp,</span><br><span class="line">        &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ—¶å€™ï¼Œä¼šä¸º <code>TaskContext</code> ä¸­çš„ <code>ra</code>
èµ‹å€¼ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> <span class="title class_">TaskContext</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">goto_trap_return</span>(kstack_ptr: <span class="type">usize</span>) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">        <span class="keyword">Self</span> &#123;</span><br><span class="line">            ra: trap_return <span class="keyword">as</span> <span class="type">usize</span>,																				<span class="comment">/// init return address</span></span><br><span class="line">            sp: kstack_ptr,</span><br><span class="line">            s: [<span class="number">0</span>; <span class="number">12</span>],</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œï¼Œ<code>ra</code> çš„å€¼å°±æ˜¯ <code>trap_return</code>
ï¼šä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å†…æ ¸ç¬¬ä¸€æ¬¡è°ƒåº¦è¯¥è¿›ç¨‹çš„æ—¶å€™ï¼Œå†…æ ¸åœ¨æ‰§è¡Œå®Œå†…æ ¸æ€çš„æ‰€æœ‰æŒ‡ä»¤åï¼Œä¼šè·³è½¬åˆ°
<code>trap_return</code>ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[no_mangle]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">trap_return</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="comment">// set stvec to trampoline</span></span><br><span class="line">    <span class="title function_ invoke__">set_user_trap_entry</span>();</span><br><span class="line">    <span class="comment">// get trap context pointer</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">trap_cx_ptr</span> = TRAP_CONTEXT_BASE;</span><br><span class="line">    <span class="comment">// get the user page table addr with other satp fields</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user_satp</span> = <span class="title function_ invoke__">current_user_token</span>();</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">__alltraps</span>();</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">__restore</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">restore_va</span> = __restore <span class="keyword">as</span> <span class="type">usize</span> - __alltraps <span class="keyword">as</span> <span class="type">usize</span> + TRAMPOLINE;</span><br><span class="line">    <span class="comment">// trace!(&quot;[kernel] trap_return: ..before return&quot;);</span></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        asm!(</span><br><span class="line">            <span class="string">&quot;fence.i&quot;</span>,</span><br><span class="line">            <span class="string">&quot;jr &#123;restore_va&#125;&quot;</span>,         <span class="comment">// jump to new addr of __restore asm function</span></span><br><span class="line">            restore_va = <span class="title function_ invoke__">in</span>(reg) restore_va,</span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;a0&quot;</span>) trap_cx_ptr,      <span class="comment">// a0 = virt addr of Trap Context</span></span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;a1&quot;</span>) user_satp,        <span class="comment">// a1 = phy addr of usr page table</span></span><br><span class="line">            <span class="title function_ invoke__">options</span>(noreturn)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>trap_return</code> ä¸­åˆå§‹åŒ–äº† <code>stvec</code>ï¼Œå¹¶ä½¿ç”¨
<code>trap_cx_ptr -&gt; TRAP_CONTEXT_BASE</code> å’Œ
<code>user_stap</code> ä½œä¸ºå‚æ•°è°ƒç”¨äº†æ–¹æ³•
<code>__restore</code>ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼š</p>
<ol type="1">
<li>æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ <code>jr restore_va</code> æŒ‡ä»¤è€Œä¸æ˜¯
<code>call __restore</code>ï¼›</li>
<li><code>restore_va</code> ä¹Ÿä¸æ˜¯ç›´æ¥ä½¿ç”¨
<code>jr __restore</code>ï¼›</li>
</ol>
<p>è¿™ä¸ªé€»è¾‘å¯ä»¥åœ¨ <a href="#restore_va">restore_va</a>
ä¸­æ‰¾åˆ°å…·ä½“è§£æï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆçœ‹ <code>sscratch</code> ç›¸å…³çš„å†…å®¹ã€‚</p>
<p>åœ¨ <code>__restore</code> ä¸­ï¼Œæˆ‘ä»¬å°† <code>a0 = trap_cx_ptr</code>
èµ‹å€¼ç»™äº† <code>sscratch</code>ï¼Œäºæ˜¯åˆå§‹åŒ–å®Œæˆã€‚</p>
<h3 id="restore_va">restore_va</h3>
<blockquote>
<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ <code>linker.ld</code>
ä¸­å£°æ˜çš„åœ°å€å’Œç‰©ç†åœ°å€çš„å…³ç³» -- æ˜¯çš„ï¼Œlinker.ld
ä¸­çš„åœ°å€æ˜¯è™šæ‹Ÿåœ°å€ã€‚ç»†èŠ‚å‚è€ƒ <a href="#linker.ld">linker.ld</a></p>
</blockquote>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">trap_return</span>() <span class="punctuation">-&gt;</span> ! &#123;</span><br><span class="line">    <span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">__alltraps</span>();</span><br><span class="line">        <span class="keyword">fn</span> <span class="title function_">__restore</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">restore_va</span> = __restore <span class="keyword">as</span> <span class="type">usize</span> - __alltraps <span class="keyword">as</span> <span class="type">usize</span> + TRAMPOLINE;</span><br><span class="line">    <span class="comment">// trace!(&quot;[kernel] trap_return: ..before return&quot;);</span></span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        asm!(</span><br><span class="line">            <span class="string">&quot;fence.i&quot;</span>,</span><br><span class="line">            <span class="string">&quot;jr &#123;restore_va&#125;&quot;</span>,         <span class="comment">// jump to new addr of __restore asm function</span></span><br><span class="line">            restore_va = <span class="title function_ invoke__">in</span>(reg) restore_va,</span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;a0&quot;</span>) trap_cx_ptr,      <span class="comment">// a0 = virt addr of Trap Context</span></span><br><span class="line">            <span class="title function_ invoke__">in</span>(<span class="string">&quot;a1&quot;</span>) user_satp,        <span class="comment">// a1 = phy addr of usr page table</span></span><br><span class="line">            <span class="title function_ invoke__">options</span>(noreturn)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨å†…æ ¸æ€å°†æ§åˆ¶æƒäº¤è¿˜ç»™ç”¨æˆ·æ€çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨
<code>__restore</code>ï¼Œè€Œè¿™é‡Œæ˜¯é€šè¿‡ <code>restore_va</code>
è¿™ä¸ªå¥‡æ€ªçš„åœ°å€æ¥è·³è½¬çš„ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿæˆ‘ä»¬å¯ä»¥å…ˆçœ‹çœ‹
<code>restore_va</code> è¿™ä¸ªå€¼æ˜¯æ€ä¹ˆè®¡ç®—å‡ºæ¥çš„ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ï¼Œæˆ‘ä»¬çš„ <code>strampoline</code> å®åœ¨
<code>linkder.ld</code> ä¸Šå®šä¹‰çš„ï¼Œå®ƒè¢«åŒ…å«åœ¨äº†å†…æ ¸çš„ <code>.text</code>
é€»è¾‘æ®µä¸­ï¼š<strong>åœ¨åŠ è½½å†…æ ¸ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œ<code>strampoline</code> è¿™ä¸ª
VA è¢«ä»¥æ’ç­‰æ˜ å°„çš„æ–¹å¼æ˜ å°„åˆ°ç‰©ç†å†…å­˜ã€‚</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">OUTPUT_ARCH(riscv)</span><br><span class="line">ENTRY(_start)</span><br><span class="line">BASE_ADDRESS = 0x80200000;</span><br><span class="line"></span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">    . = BASE_ADDRESS;</span><br><span class="line">    skernel = .;</span><br><span class="line"></span><br><span class="line">    stext = .;</span><br><span class="line">    .text : &#123;</span><br><span class="line">        *(.text.entry)</span><br><span class="line">        . = ALIGN(4K);</span><br><span class="line">        strampoline = .;								/// strampoline is defined here</span><br><span class="line">        *(.text.trampoline);							/// .text.trampoline is included here </span><br><span class="line">        . = ALIGN(4K);</span><br><span class="line">        *(.text .text.*)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>memory_set.rs</code> ä¸­ï¼Œæˆ‘ä»¬æä¾›äº†æ–¹æ³•æ¥æ˜ å°„
<code>VA</code> åˆ° <code>PA</code>ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">strampoline</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="title class_">MemorySet</span> &#123;</span><br><span class="line">    <span class="comment">/// Mention that trampoline is not collected by areas.</span></span><br><span class="line">    <span class="keyword">fn</span> <span class="title function_">map_trampoline</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.page_table.<span class="title function_ invoke__">map</span>(</span><br><span class="line">            VirtAddr::<span class="title function_ invoke__">from</span>(TRAMPOLINE).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            PhysAddr::<span class="title function_ invoke__">from</span>(strampoline <span class="keyword">as</span> <span class="type">usize</span>).<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            PTEFlags::R | PTEFlags::X,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éšåï¼Œæˆ‘ä»¬åœ¨<strong>åŠ è½½å†…æ ¸</strong>ä»¥åŠ<strong>å†…æ ¸åŠ è½½åº”ç”¨ç¨‹åº</strong>çš„æ—¶å€™ï¼Œéƒ½è°ƒç”¨
<code>map_tramploine</code> è¿™ä¸ªå‡½æ•°ï¼Œå°† <code>TRAMPOLINE</code>
è¿™ä¸ªVAæ˜ å°„åˆ°äº†åŒä¸€ä¸ª PAã€‚</p>
<p>å†å›åˆ° <code>__alltraps</code> å’Œ <code>__restore</code>ï¼Œåœ¨
<code>trap.S</code> ä¸­ï¼Œæˆ‘ä»¬å£°æ˜ <code>.text.trampoline</code>
é€»è¾‘æ®µå’Œè¿™ä¸¤ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    .section .text.trampoline</span><br><span class="line">    .globl __alltraps</span><br><span class="line">    .globl __restore</span><br><span class="line">    .align 2</span><br><span class="line">__alltraps:</span><br><span class="line">	# ...</span><br><span class="line">__restore:</span><br><span class="line">	# ...</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼š<code>__alltraps</code> å’Œ
<code>__restore</code> æ˜¯è¢«å¼•å…¥åˆ°äº† <code>linker.ld</code> çš„
<code>.text</code> æ®µï¼Œå¹¶ä¸”å®ƒåŠ è½½æ—¶å°šæœªå¼€å¯åˆ†é¡µæ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯
<code>__alltraps</code> å’Œ <code>__restore</code> æ ‡ç­¾çš„å€¼æ˜¯ä¸€ä¸ª
<code>PA</code>ã€‚æ­¤æ—¶ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ <code>call __alltraps</code> æˆ–è€…
<code>call __restore</code>
æ—¶å°†å‘ç”Ÿå¼‚å¸¸ï¼Œå› ä¸ºæ­¤æ—¶æˆ‘ä»¬å·²ç»å¼€å¯äº†åˆ†é¡µæ¨¡å¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªèƒ½æ‰‹åŠ¨çš„è®¡ç®—è¿™ä¸ªä»–ä»¬çš„å€¼ã€‚</p>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥çŸ¥é“å‡ ä¸ªä¿¡æ¯ï¼šVA <code>TRAMPOLINE</code> æŒ‡å‘äº† PA
<code>strampoline</code>ï¼š</p>
<ul>
<li>è®¿é—® <code>__alltraps</code> æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ VA
<code>TRAMPOLINE</code>ï¼›</li>
<li>è®¿é—® <code>__restore</code> æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ VA
<code>TRAMPOLINE + len(__alltraps)</code> =
<code>TRAMPOLINE + (__restore - __alltraps)</code>ã€‚</li>
</ul>
<blockquote>
<p>åœ¨ä¸Šé¢çš„åœ°å€è®¡ç®—ä¸­ï¼Œæœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œç”»å†…å­˜å¸ƒå±€å›¾æ—¶ä»é«˜åˆ°ä½ç”»ï¼Œä½†ä»£ç å®é™…ä»ä½åœ°å€å¾€é«˜åœ°å€åŠ è½½ï¼ˆtrampoline
ä»£ç ä»ä¸‹å¾€ä¸Šï¼‰</p>
<p>ä»¥ <code>trampoline</code> ä¸ºä¾‹ï¼Œtrampoline çš„æŒ‡é’ˆæ˜¯
<code>TRAMPOLINE</code>ï¼Œé‚£ä¹ˆå®é™…çš„åŠ è½½çš„æ•°æ®æ˜¯ä»
<code>TRAMPOLINE</code> -&gt; <code>TRAMPOLINE + PAGE_SIZE - 1</code>
è¿™ä¸ªæ–¹å‘å»åŠ è½½çš„ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæŠŠ trampoline
çš„ä»£ç ä¹Ÿç”»åˆ°å†…å­˜å¸ƒå±€å›¾ä¸Šçš„è¯ï¼Œå®ƒçš„ä»£ç æ˜¯ä»ä¸‹å¾€ä¸Šçš„ã€‚</p>
<figure>
<img src="/images/20251121/addresses.png" alt="addresses.png" />
<figcaption aria-hidden="true">addresses.png</figcaption>
</figure>
</blockquote>
<h3 id="linker.ld">linker.ld</h3>
<p>æˆ‘ä»¬çš„ <code>linker.ld</code> ä¸€èˆ¬æ˜¯å¦‚ä¸‹å½¢å¼ï¼Œè€Œå…¶ä¸­å£°æ˜çš„åœ°å€ä¾‹å¦‚
<code>BASE_ADDRESS = 0x80200000</code> éƒ½æ˜¯è™šæ‹Ÿåœ°å€ -- ä¸ç®¡æ˜¯å†…æ ¸æ€çš„
linker.ld è¿˜æ˜¯ç”¨æˆ·æ€çš„ linker.ldã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä¹‹å‰å¤„ç†
<code>elf</code> æ–‡ä»¶çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ <code>ph.virtual_addr()</code>
è·å–åˆ°ä¸€ä¸ªé€»è¾‘æ®µçš„è™šæ‹Ÿåœ°å€çš„åŸå› ï¼ˆæœ€ç®€å•çš„ç†è§£æ˜¯ï¼Œç‰©ç†åœ°å€æ˜¯è¿è¡Œæ—¶æ‰æœ‰çš„æ¦‚å¿µï¼Œåœ¨é™æ€æ–‡ä»¶ä¸­æ ¹æœ¬å°±ä¸å¯èƒ½çŸ¥é“ä»»ä½•ç‰©ç†åœ°å€çš„ä¿¡æ¯ï¼‰ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OUTPUT_ARCH(riscv)</span><br><span class="line">ENTRY(_start)</span><br><span class="line">BASE_ADDRESS = 0x80200000;</span><br><span class="line"></span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">    . = BASE_ADDRESS;</span><br><span class="line">    skernel = .;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>.cargo/config.yml</code> ä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šäº†è¯¥ linker.ldï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">build</span>]</span><br><span class="line"><span class="string">target</span> <span class="string">=</span> <span class="string">&quot;riscv64gc-unknown-none-elf&quot;</span></span><br><span class="line"></span><br><span class="line">[<span class="string">target.riscv64gc-unknown-none-elf</span>]</span><br><span class="line"><span class="string">rustflags</span> <span class="string">=</span> [</span><br><span class="line">    <span class="string">&quot;-Clink-arg=-Tsrc/linker.ld&quot;</span>, <span class="string">&quot;-Cforce-frame-pointers=yes&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>ç„¶è€Œï¼Œåœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åœ¨åŠ è½½è¿™ä¸ªç¨‹åºåˆ°å†…å­˜æ—¶æ˜¯ä¸€ä¸ªè£¸æœºç¨‹åºï¼Œä»–å’Œå…¶ä»–çš„åº”ç”¨ç¨‹åºä¸ä¸€æ ·ã€‚ä»–æ˜¯ä»
<code>M</code> æ¨¡å¼å¯åŠ¨åŠ è½½çš„ï¼Œæ­¤æ—¶PCå°šæœªå¼€å¯åˆ†é¡µæ¨¡å¼ --
ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„<code>VA</code>ä¼šç›´æ¥è¢«æ˜ å°„åˆ°å¯¹åº”çš„ <code>PA</code>ã€‚</p>
<p>å½“å†…æ ¸åŠ è½½å®Œæˆï¼Œå¼€å¯åˆ†é¡µæ¨¡å¼åï¼Œæ­¤æ—¶å†åŠ è½½åº”ç”¨ç¨‹åºï¼Œæ­¤æ—¶çš„
<code>VA</code> å·²ç»åœ¨åŠ è½½é˜¶æ®µè¢«æˆ‘ä»¬æ˜ å°„åˆ°äº† <code>PA</code>ã€‚</p>
<h4 id="m-æ¨¡å¼å¯åŠ¨åŠ è½½">M æ¨¡å¼å¯åŠ¨åŠ è½½</h4>
<ol type="1">
<li>RISC-V å¤ä½åï¼ŒCPU è¿›å…¥ <strong>M æ¨¡å¼</strong>ï¼Œæ‰§è¡Œ
bootloaderï¼ˆé€šå¸¸æ˜¯å¼€æºçš„ OpenSBIï¼Œæˆ–ç®€æ˜“ bootloaderï¼‰ï¼›</li>
<li>bootloader å®Œæˆç¡¬ä»¶åˆå§‹åŒ–ï¼ˆå¦‚å†…å­˜åˆå§‹åŒ–ã€ä¸²å£é…ç½®ï¼‰åï¼Œä¼šå°†å†…æ ¸ ELF
åŠ è½½åˆ°ç‰©ç†åœ°å€ <code>0x80200000</code>ï¼›</li>
<li>éšå bootloader åˆ‡æ¢åˆ° <strong>S
æ¨¡å¼</strong>ï¼ˆç›‘ç£æ¨¡å¼ï¼‰ï¼Œå¹¶è·³è½¬åˆ°å†…æ ¸çš„å…¥å£åœ°å€ï¼ˆ<code>_start</code>ï¼Œè™šæ‹Ÿåœ°å€
= ç‰©ç†åœ°å€ = 0x80200000ï¼‰ï¼›</li>
<li>å†…æ ¸åç»­åœ¨ S æ¨¡å¼è¿è¡Œï¼ˆç®¡ç†é¡µè¡¨ã€å¤„ç† Trapã€è°ƒåº¦åº”ç”¨ï¼‰ï¼ŒM æ¨¡å¼ä»…ç”¨äº
bootloader åˆå§‹åŒ–ï¼Œå†…æ ¸è¿è¡Œæ—¶ä¸æ¶‰åŠ M æ¨¡å¼ã€‚</li>
</ol>
<p>å†å›å¤´çœ‹æˆ‘ä»¬çš„ <code>entry.asm</code> æ–‡ä»¶ï¼Œè¿™é‡Œå£°æ˜äº†
<code>.text.entry</code> æ®µå’Œ <code>_start</code>ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    .section .text.entry								# è¿™é‡Œå£°æ˜äº† .text.entry</span><br><span class="line">    .globl _start</span><br><span class="line">_start:</span><br><span class="line">    la sp, boot_stack_top</span><br><span class="line">    call rust_main										# è¿™å°±æ˜¯å†…æ ¸çš„å…¥å£åœ°å€</span><br></pre></td></tr></table></figure>
<p>è€Œ <code>linker.ld</code> ä¸­å°† <code>text.entry</code> åŠ è½½åˆ°äº†
<code>.text</code> çš„èµ·å§‹ä½ç½®ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">OUTPUT_ARCH(riscv)</span><br><span class="line">ENTRY(_start)</span><br><span class="line">BASE_ADDRESS = 0x80200000;</span><br><span class="line"></span><br><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">    . = BASE_ADDRESS;</span><br><span class="line">    skernel = .;</span><br><span class="line"></span><br><span class="line">    stext = .;</span><br><span class="line">    .text : &#123;</span><br><span class="line">        *(.text.entry)									# è¿™é‡Œå°† .text.entry åŠ è½½åˆ° .text</span><br><span class="line">        . = ALIGN(4K);</span><br><span class="line">        strampoline = .;</span><br><span class="line">        *(.text.trampoline);</span><br><span class="line">        . = ALIGN(4K);</span><br><span class="line">        *(.text .text.*)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å †çš„åˆå§‹åŒ–">å †çš„åˆå§‹åŒ–</h3>
<blockquote>
<p>åœ¨æœ¬é¡¹ç›®ä¸­ï¼ŒHEAP_ALLOCATOR é  Rust çš„
<code>#[global_allocator]</code> ç¼–è¯‘å™¨å±æ€§
â€œæ³¨å†Œä¸ºå…¨å±€å †åˆ†é…å™¨â€ï¼ŒHEAP_SPACE æ˜¯å †çš„ â€œç‰©ç†å†…å­˜è½½ä½“â€ï¼Œé€šè¿‡ init_heap()
æ‰‹åŠ¨ç»‘å®šåˆ°åˆ†é…å™¨ â€”â€”
ä¸¤è€…æ— éœ€å¤–éƒ¨æ˜¾å¼å¼•ç”¨ï¼Œé ç¼–è¯‘å™¨çº¦å®šå’Œåˆå§‹åŒ–é€»è¾‘ååŒå·¥ä½œï¼Œæœ€ç»ˆè®©å†…æ ¸çš„
Box/Vec/Arc ç­‰åŠ¨æ€åˆ†é…æ“ä½œè‡ªåŠ¨è·¯ç”±åˆ°è¿™ä¸ªå †ã€‚</p>
</blockquote>
<h4 id="ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶">ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶</h4>
<table>
<colgroup>
<col style="width: 13%" />
<col style="width: 33%" />
<col style="width: 53%" />
</colgroup>
<thead>
<tr class="header">
<th>ç»„ä»¶</th>
<th>è§’è‰²</th>
<th>å…³é”®ç‰¹æ€§</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>HEAP_ALLOCATOR</td>
<td>å…¨å±€å †åˆ†é…å™¨å®ä¾‹ï¼ˆbuddy_system_allocator çš„ä¼™ä¼´ç³»ç»Ÿåˆ†é…å™¨ï¼‰</td>
<td>è¢« #[global_allocator]
æ ‡è®°ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å°†æ‰€æœ‰å †åˆ†é…è¯·æ±‚è·¯ç”±åˆ°å®ƒï¼›LockedHeap
å¸¦é”ï¼Œæ”¯æŒå¤šçº¿ç¨‹å®‰å…¨ã€‚</td>
</tr>
<tr class="even">
<td>HEAP_SPACE</td>
<td>å†…æ ¸å †çš„ â€œå†…å­˜ç©ºé—´è½½ä½“â€ï¼ˆä¸€å—é™æ€æ•°ç»„ï¼‰</td>
<td>æœ¬è´¨æ˜¯ <code>.bss</code> æ®µçš„è¿ç»­å†…å­˜ï¼ˆç¼–è¯‘æœŸåˆ†é…å¤§å°
KERNEL_HEAP_SIZEï¼ŒåŠ è½½æ—¶æ“ä½œç³»ç»Ÿæ¸…é›¶ï¼‰ï¼Œæ˜¯å †åˆ†é…çš„ â€œç‰©ç†åŸºç¡€â€ã€‚</td>
</tr>
<tr class="odd">
<td>init_heap()</td>
<td>ç»‘å®š â€œè½½ä½“â€ å’Œ â€œåˆ†é…å™¨â€ çš„åˆå§‹åŒ–å‡½æ•°</td>
<td>æ‰‹åŠ¨å°† HEAP_SPACE çš„åœ°å€å’Œå¤§å°å‘Šè¯‰ HEAP_ALLOCATORï¼Œè®©åˆ†é…å™¨çŸ¥é“
â€œç®¡ç†å“ªå—å†…å­˜â€ã€‚</td>
</tr>
</tbody>
</table>
<h4 id="global_allocator"><code>#[global_allocator]</code></h4>
<p>Rust æ²¡æœ‰å†…ç½®çš„å†…æ ¸å †ï¼Œå¿…é¡»æ‰‹åŠ¨å®ç° / æŒ‡å®š
â€œå…¨å±€åˆ†é…å™¨â€â€”â€”<code>#[global_allocator]</code> å°±æ˜¯ç¼–è¯‘å™¨æä¾›çš„
â€œæ³¨å†Œçº¦å®šâ€ï¼š</p>
<p>åªè¦æœ‰ä¸€ä¸ªé™æ€å˜é‡è¢« <code>#[global_allocator]</code>
æ ‡è®°ï¼Œä¸”è¯¥å˜é‡å®ç°äº† <code>core::alloc::GlobalAlloc</code>
traitï¼ˆLockedHeap å·²å®ç°ï¼‰ï¼Œç¼–è¯‘å™¨å°±ä¼šå°†æ‰€æœ‰ â€œåŠ¨æ€å†…å­˜åˆ†é…æ“ä½œâ€ï¼ˆå¦‚
<code>Box::new()</code>ã€<code>Vec::push()</code>ã€<code>Arc::new()</code>ã€<code>String::from()</code>ç­‰ï¼‰è·¯ç”±åˆ°è¿™ä¸ªåˆ†é…å™¨çš„
<code>alloc/dealloc</code> æ–¹æ³•ã€‚</p>
<h4 id="heap_spaceå’Œheap_allocator">HEAP_SPACEå’ŒHEAP_ALLOCATOR</h4>
<p>HEAP_ALLOCATOR åˆå§‹åŒ–æ—¶æ˜¯
<code>LockedHeap::empty()</code>ï¼ˆç©ºåˆ†é…å™¨ï¼Œä¸çŸ¥é“è¦ç®¡ç†å“ªå—å†…å­˜ï¼‰ï¼Œè€Œ
HEAP_SPACE æ˜¯ä¸€å— â€œé™æ€åˆ†é…çš„è¿ç»­å†…å­˜â€ï¼ˆ.bss æ®µï¼‰ï¼Œinit_heap()
çš„ä½œç”¨å°±æ˜¯æŠŠä¸¤è€… â€œç»‘åœ¨ä¸€èµ·â€ï¼š</p>
<h3 id="lazy_static">lazy_static</h3>
<blockquote>
<p>lazy_static! æ˜¯ Rust ç¤¾åŒºæä¾›çš„ â€œå»¶è¿Ÿåˆå§‹åŒ–é™æ€å˜é‡â€ å®ï¼ˆå±äº
lazy_static crateï¼‰ï¼Œæ ¸å¿ƒè§£å†³ â€œæ— æ³•åœ¨ç¼–è¯‘æœŸåˆå§‹åŒ–å¤æ‚é™æ€å˜é‡â€
çš„é—®é¢˜</p>
</blockquote>
<p><code>MemorySet::new_kernel()</code>
æ˜¯è¿è¡Œæ—¶æ‰§è¡Œçš„å‡½æ•°ï¼ˆéœ€è¦åˆå§‹åŒ–é¡µè¡¨ã€æ˜ å°„å†…æ ¸æ®µç­‰ï¼‰ï¼Œä¸èƒ½ç›´æ¥ç”¨ static
å®šä¹‰ï¼ˆstatic è¦æ±‚ç¼–è¯‘æœŸå¸¸é‡åˆå§‹åŒ–ï¼‰ã€‚</p>
<p><code>lazy_static!</code> çš„å®ç°åŸç†æ˜¯ï¼š</p>
<ul>
<li>ç¼–è¯‘æœŸï¼šå®ä¼šç”Ÿæˆä¸€ä¸ªéšè—çš„é™æ€å˜é‡ï¼ˆæ ‡è®°ä¸º
lazyï¼‰ï¼Œå¹¶åˆ†é…ä¸€å°å—ç©ºé—´åœ¨ .data æ®µï¼ˆæˆ– .bss
æ®µï¼Œå–å†³äºæ˜¯å¦æœ‰åˆå§‹å€¼ï¼‰ï¼Œç”¨äºå­˜å‚¨ â€œåˆå§‹åŒ–çŠ¶æ€â€ï¼ˆæ˜¯å¦å·²åˆ›å»ºå®ä¾‹ï¼‰å’Œ
â€œå®ä¾‹æŒ‡é’ˆâ€ï¼›</li>
<li>è¿è¡Œæ—¶ï¼šé¦–æ¬¡è®¿é—® KERNEL_SPACE æ—¶ï¼Œä¼šæ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€ â€”â€”
è‹¥æœªåˆå§‹åŒ–ï¼Œæ‰§è¡Œ MemorySet::new_kernel() åˆ›å»ºå®ä¾‹ï¼Œå°†å®ä¾‹çš„æ‰€æœ‰æƒäº¤ç»™
Arcï¼Œå†æŠŠ Arc æŒ‡é’ˆå­˜å…¥ä¹‹å‰åˆ†é…çš„ .data
æ®µç©ºé—´ï¼›åç»­è®¿é—®ç›´æ¥å¤ç”¨è¯¥å®ä¾‹ï¼Œä¸å†é‡å¤åˆå§‹åŒ–ã€‚</li>
</ul>
<p><code>lazy_static!</code> ä¼šåŒ…å«ä¸‰ä¸ªæ¨¡å—ï¼š</p>
<ol type="1">
<li>å®ä¾‹æŒ‡é’ˆï¼šç”¨äºå­˜å‚¨åç»­åˆå§‹åŒ–å®Œæˆåï¼ŒArc&lt;UPSafeCell<MemorySet>&gt;
çš„æŒ‡é’ˆï¼ˆåˆå§‹å€¼ä¸º null æˆ–å ä½ç¬¦ï¼‰ï¼›</li>
<li>åˆå§‹åŒ–çŠ¶æ€æ ‡è®°ï¼šä¸€ä¸ªåŸå­å˜é‡ï¼ˆå¦‚ AtomicBool æˆ–æšä¸¾
Uninit/Initï¼‰ï¼Œæ ‡è®°å®ä¾‹æ˜¯å¦å·²åˆå§‹åŒ–ï¼ˆåˆå§‹çŠ¶æ€ä¸º â€œæœªåˆå§‹åŒ–â€ï¼‰ï¼›</li>
<li>åŒæ­¥é”ï¼šç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„åˆå§‹åŒ–äº’æ–¥ï¼ˆé¿å…å¤šä¸ªçº¿ç¨‹åŒæ—¶è§¦å‘åˆå§‹åŒ–ï¼Œå¯¼è‡´å®ä¾‹é‡å¤åˆ›å»ºï¼‰â€”â€”
è¿™æ˜¯ lazy_static! é»˜è®¤æä¾›çš„çº¿ç¨‹å®‰å…¨ä¿éšœã€‚</li>
</ol>
<p>å®é™…çš„æ‰§è¡Œè¿‡ç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š</p>
<ol type="1">
<li>è·å–åŒæ­¥é”ï¼ŒæˆåŠŸåˆ™è¿›å…¥ <code>&lt;2&gt;</code></li>
<li>æŸ¥è¯¢åˆå§‹åŒ–çŠ¶æ€
<ul>
<li>å¦‚æœæœªåˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–å¯¹è±¡ï¼Œå¹¶ç»™å®ä¾‹æŒ‡é’ˆèµ‹å€¼ï¼›ä¿®æ”¹åˆå§‹åŒ–çŠ¶æ€æ ‡è®°ï¼›</li>
<li>å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œåˆ™ç›´æ¥ä½¿ç”¨å¯¹è±¡ï¼›</li>
</ul></li>
<li>é‡Šæ”¾é”ã€‚</li>
</ol>
<h3 id="elfæ–‡ä»¶çš„vaå’Œpa">elfæ–‡ä»¶çš„VAå’ŒPA</h3>
<blockquote>
<p>åœ¨æˆ‘ä»¬é€šè¿‡elfåˆå§‹åŒ– <code>.text/.rodata/.data/.bss</code>
é€»è¾‘æ®µæ—¶ï¼Œelfæ–‡ä»¶è‡ªèº«å­˜åœ¨VAå’ŒPAï¼Œè€Œæˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸ªæ•°æ®è½¬æ¢ä¸ºMapAreaï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p>
</blockquote>
<p>åœ¨åˆ†æè¿™æ®µä»£ç çš„å†…å­˜æƒ…å†µä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ç›®å‰å†…æ ¸çš„åˆå§‹åŒ–çŠ¶æ€ï¼š</p>
<ol type="1">
<li><code>KERNEL_SPACE</code> å·²ç»åˆå§‹åŒ–ï¼Œè¿™æ„å‘³ç€
<code>new_kernel()</code>
å·²ç»è¢«è°ƒç”¨ï¼Œ<strong>å†…æ ¸çš„é¡µè¡¨å·²ç»åˆå§‹åŒ–å®Œæˆ</strong>ï¼›</li>
<li><code>MemorySet#activate()</code>
å·²ç»è°ƒç”¨ï¼Œè¿™æ„å‘³ç€<strong>åˆ†é¡µè®¿é—®å·²ç»å¼€å¯</strong>ï¼›</li>
<li>æˆ‘ä»¬çš„ç›®çš„æ˜¯åˆå§‹åŒ–ç”¨æˆ·åœ°å€ç©ºé—´ï¼Œæ­¤æ—¶ç¨‹åºä»å¤´è‡³å°¾å‡åœ¨å†…æ ¸æ€ä¸‹æ‰§è¡Œã€‚</li>
</ol>
<p>é‚£ä¹ˆæ•´ä½“çš„è½¬æ¢è¿‡ç¨‹å¯ä»¥å¦‚ä¸‹è¡¨ç¤ºï¼š</p>
<ol type="1">
<li>å†…æ ¸è¯»å– ELF æ•°æ®åˆ°å†…æ ¸åœ°å€ç©ºé—´ï¼š
<ol type="1">
<li>å†…æ ¸é€šè¿‡å—è®¾å¤‡é©±åŠ¨ï¼ˆå¦‚ç£ç›˜ï¼‰ï¼Œå°† ELF æ–‡ä»¶è¯»å–åˆ°å½“å‰å‡½æ•°çš„æ ˆ / å † /
å…¨å±€ç¼“å†²åŒºï¼ˆ<code>elf_data</code>ï¼‰ï¼›</li>
<li><code>elf_data</code> çš„åœ°å€æ˜¯å†…æ ¸
VAï¼Œé€šè¿‡å†…æ ¸é¡µè¡¨ç¿»è¯‘åï¼Œå¾—åˆ°å¯¹åº”çš„ç‰©ç†åœ°å€ PA_ELF â€”â€” ELF
åŸå§‹æ•°æ®ï¼ˆ.text/.data ç­‰ï¼‰å­˜å‚¨åœ¨ PA_ELF å¯¹åº”çš„ç‰©ç†å†…å­˜ä¸­ã€‚</li>
</ol></li>
<li>è§£æ ELF å¾—åˆ°å…ƒæ•°æ®ï¼Œæå–å…³é”®ä¿¡æ¯å¹¶å¤åˆ¶ï¼›</li>
<li>æ­¤æ—¶ï¼šæˆ‘ä»¬çš„elfæ–‡ä»¶å­˜å‚¨åœ¨ <code>å†…æ ¸æ ˆ</code> ä¸Šï¼š
<ul>
<li>è¿™äº› ELF åŸå§‹æ•°æ®ï¼ˆ.text/.data ç­‰ï¼‰åœ¨ã€Œå†…æ ¸åœ°å€ç©ºé—´ã€çš„ VA èŒƒå›´æ˜¯
<code>[elf_data, elf_data + elf_data_size)</code>ï¼›</li>
<li>è€Œ
<code>[ph.virtual_addr(), ph.virtual_addr() + ph.mem_size()]</code>
æ˜¯è¿™äº›æ•°æ®åœ¨ã€Œç”¨æˆ·åœ°å€ç©ºé—´ã€çš„ã€Œç›®æ ‡ VA èŒƒå›´ã€â€”â€” è¿™ä¸ªç›®æ ‡ VA
æ˜¯é“¾æ¥é˜¶æ®µç¡®å®šçš„ï¼Œå†…æ ¸åŠ è½½æ—¶ä¼šå°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç‰©ç†å†…å­˜ï¼Œå¹¶å»ºç«‹ã€Œç”¨æˆ·ç›®æ ‡
VA â†’ ç”¨æˆ·ç‰©ç†
PAã€çš„æ˜ å°„ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ¯ä¸€ä¸ªåº”ç”¨ç¨‹åºèƒ½é€šè¿‡åŒä¸€ä¸ªVAè®¿é—®åˆ°ä¸åŒPAçš„æ ¹æœ¬åŸå› 
-- è¿™äº›æ•°æ®å°†è¢«æ˜ å°„åˆ°ä¸åŒçš„PAï¼›</li>
</ul></li>
<li>æœ€åï¼Œæˆ‘ä»¬é€šè¿‡ <code>memory_set.push(map_area, elf.data)</code>
çš„æ–¹æ³•ï¼Œå°†è¿™ä¸€ä»½æ•°æ®å¤åˆ¶åˆ°äº†ç”¨æˆ·æ€çš„ <code>MemorySet</code>
ä¸­ã€‚<strong>æ³¨æ„ï¼ŒMemorySetæ˜¯å­˜åœ¨äºå†…æ ¸æ€ï¼Œå¯¹ç”¨æˆ·æ€å®Œå…¨é€æ˜çš„ã€‚</strong></li>
</ol>
<h3 id="sbrk">sbrk</h3>
<p><code>sbrk(n)</code> æ˜¯ç»å…¸çš„ Unix ç³»ç»Ÿè°ƒç”¨ï¼ŒåŠŸèƒ½æ˜¯ â€œæ‰©å±• /
æ”¶ç¼©è¿›ç¨‹çš„å †ç©ºé—´â€ï¼ˆæˆ–æ ˆç©ºé—´ï¼Œå–å†³äºå†…æ ¸è®¾è®¡ï¼‰ï¼šåœ¨æˆ‘ä»¬çš„
<code>rCore</code> ä¸­ï¼Œ <code>sbrk</code> æ˜¯ç´§è·Ÿç€
<code>user_stack_top</code>ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">map</span>() &#123;</span><br><span class="line">    user_stack_bottom += PAGE_SIZE;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">user_stack_top</span> = user_stack_bottom + USER_STACK_SIZE;</span><br><span class="line">    memory_set.<span class="title function_ invoke__">push</span>(</span><br><span class="line">        MapArea::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            user_stack_bottom.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            user_stack_top.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            MapType::Framed,</span><br><span class="line">            MapPermission::R | MapPermission::W | MapPermission::U,</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// used in sbrk</span></span><br><span class="line">    memory_set.<span class="title function_ invoke__">push</span>(</span><br><span class="line">        MapArea::<span class="title function_ invoke__">new</span>(</span><br><span class="line">            user_stack_top.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            user_stack_top.<span class="title function_ invoke__">into</span>(),</span><br><span class="line">            MapType::Framed,</span><br><span class="line">            MapPermission::R | MapPermission::W | MapPermission::U,</span><br><span class="line">        ),</span><br><span class="line">        <span class="literal">None</span>,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒæ•´ sbrk æ¥ä¼¸ç¼©æˆ‘ä»¬çš„æ ˆå¤§å°ï¼š</p>
<ul>
<li>å½“ n&gt;0 æ—¶ï¼Œå‘å†…æ ¸ç”³è¯· n å­—èŠ‚çš„å†…å­˜ï¼Œå † / æ ˆç©ºé—´æ‰©å¤§ï¼›</li>
<li>å½“ n&lt;0 æ—¶ï¼Œé‡Šæ”¾ |n| å­—èŠ‚çš„å†…å­˜ï¼Œå † / æ ˆç©ºé—´ç¼©å°ï¼›</li>
<li>è¿”å›å€¼æ˜¯æ‰©å±•å‰çš„å † / æ ˆé¡¶æŒ‡é’ˆï¼ˆæˆ–å‡ºé”™æ—¶è¿”å› -1ï¼‰ã€‚</li>
</ul>
<p>å¦‚æœéœ€è¦åˆå§‹åŒ– <code>sbrk</code>ï¼Œå¯ä»¥åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè®¾å®šä¸€ä¸ª
<code>start == end</code> çš„MapAreaã€‚</p>
<ul>
<li>æ­£å¸¸çš„ MapArea æ˜¯ start_va &lt; end_vaï¼ˆæœ‰å®é™…åœ°å€èŒƒå›´ï¼‰ï¼Œä½†è¿™é‡Œ
start_va == end_vaï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª â€œç©ºæ˜ å°„â€ â€”â€”
ä¸å ç”¨å®é™…è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä»…ä½œä¸º â€œé¢„ç•™æ ‡è¯†â€ï¼›</li>
<li>ç›®çš„ï¼šå‘Šè¯‰å†…æ ¸ â€œuser_stack_top
ä»¥ä¸‹çš„åŒºåŸŸï¼ˆç”¨æˆ·æ ˆçš„é¢„æœŸæ‰©å±•æ–¹å‘ï¼‰æ˜¯åˆæ³•çš„æ ˆç©ºé—´â€ï¼Œåç»­ sbrk
æ‰©å±•æ—¶ï¼Œåªéœ€ä¿®æ”¹ end_va æ‰©å¤§åœ°å€èŒƒå›´ï¼Œæ— éœ€é‡æ–°åˆ›å»º
MapAreaï¼ˆé¿å…é‡å¤æ˜ å°„å†²çªï¼‰ï¼›</li>
<li>è¡¥å……ï¼šç”¨æˆ·æ ˆçš„æ‰©å±•æ–¹å‘é€šå¸¸æ˜¯ â€œä»é«˜åœ°å€å‘ä½åœ°å€æ‰©å±•â€ï¼ˆuser_stack_top
æ˜¯æ ˆé¡¶é«˜åœ°å€ï¼Œæ‰©å±•æ—¶æ ˆåº•å‘ä½åœ°å€ç§»åŠ¨ï¼Œend_va å‡å°ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œä»¥
user_stack_top ä¸ºèµ·ç‚¹å ä½ã€‚</li>
</ul>
<h3 id="trampoline">trampoline</h3>
<blockquote>
<p><strong>trampoline æ˜¯ â€œè·³æ¿â€ æˆ– â€œè¿‡æ¸¡ä»£ç æ®µâ€</strong>â€”â€”
æœ¬è´¨æ˜¯ä¸€æ®µå›ºå®šåœ¨å†…æ ¸é«˜åœ°å€ç©ºé—´ï¼ˆé«˜ 256GiBï¼‰çš„æ±‡ç¼–ä»£ç ï¼Œæ ¸å¿ƒä½œç”¨æ˜¯
<strong>è§£å†³ â€œç”¨æˆ·æ€ï¼ˆU ç‰¹æƒçº§ï¼‰â†”ï¸ å†…æ ¸æ€ï¼ˆS ç‰¹æƒçº§ï¼‰åˆ‡æ¢æ—¶çš„ç‰¹æƒçº§ +
åœ°å€ç©ºé—´åˆ‡æ¢éš¾é¢˜â€</strong></p>
</blockquote>
<h4 id="é›¶ç³»ç»Ÿè°ƒç”¨çš„æµç¨‹">é›¶ã€ç³»ç»Ÿè°ƒç”¨çš„æµç¨‹</h4>
<p>å¦‚æœæ²¡æœ‰<code>trampoline</code>ï¼Œä¸€æ¬¡å®Œæ•´çš„ç³»ç»Ÿè°ƒç”¨æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<ol type="1">
<li>æœ€å¼€å§‹ï¼ŒCPUå¤„äº <code>U</code> æ¨¡å¼ï¼Œ<code>satp</code>
æŒ‡å‘ç”¨æˆ·æ€é¡µè¡¨ï¼›</li>
<li>è°ƒç”¨ <code>ecall</code> æå‡CPUåˆ° <code>S</code> æ¨¡å¼ï¼Œæ­¤æ—¶
<code>satp</code> æŒ‡å‘ç”¨æˆ·æ€é¡µè¡¨ï¼›</li>
<li><strong>CPUå°è¯•é€šè¿‡ <code>stvec</code>
è·³è½¬åˆ°å¼‚å¸¸å¤„ç†æµç¨‹</strong>ï¼Œè¿™ä¸ªä¼šç›´æ¥å¤±è´¥ï¼Œå› ä¸º<code>__alltrap</code>
æŒ‡ä»¤æ˜¯å­˜æ”¾åœ¨å†…æ ¸æ€çš„ <code>.text</code>
æ®µä¸­ï¼ŒCPUå–å€¼ä¼šå°è¯•ä½¿ç”¨VAæŸ¥è¯¢PAï¼Œè€Œæ­¤æ—¶ç”¨æˆ·æ€çš„é¡µè¡¨æ ¹æœ¬æŸ¥ä¸åˆ°è¿™ä¸ªVAç›¸å…³çš„ä¿¡æ¯ã€‚ï¼Œ</li>
</ol>
<h4 id="ä¸€ä¸ºä»€ä¹ˆå¿…é¡»æœ‰-trampoline">ä¸€ã€ä¸ºä»€ä¹ˆå¿…é¡»æœ‰ trampolineï¼Ÿ</h4>
<p>RISC-V æ¶æ„ä¸‹ï¼Œç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ‡æ¢ï¼ˆç³»ç»Ÿè°ƒç”¨ã€å¼‚å¸¸ /
ä¸­æ–­ï¼‰æœ‰ä¸¤ä¸ªç¡¬ä»¶é™åˆ¶ï¼Œç›´æ¥åˆ‡æ¢ä¼šå¤±è´¥ï¼Œå¿…é¡»é  trampoline è¿‡æ¸¡ï¼š</p>
<ol type="1">
<li><strong>ç‰¹æƒçº§ä¸é¡µè¡¨åˆ‡æ¢çš„ â€œé¡ºåºçŸ›ç›¾â€</strong>ï¼š<code>RV39</code>
æ¨¡å¼ä¸‹ï¼Œå†…å­˜ç©ºé—´è¢«åˆ†ä¸ºä¸¤ä¸ªä¸è¿ç»­çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œåˆ†åˆ«å­˜å‚¨äº†ç”¨æˆ·æ€çš„æ•°æ®å’Œå†…æ ¸æ€çš„æ•°æ®ï¼š
<code>user_satp</code> åªçŸ¥é“ç”¨æˆ·æ€çš„é¡µè¡¨åœ°å€ï¼›<code>kernel_satp</code>
åªçŸ¥é“å†…æ ¸æ€çš„é¡µè¡¨åœ°å€ï¼›
<ol type="1">
<li>å¦‚æœæˆ‘ä»¬å…ˆä¿®æ”¹ <code>satp</code> å†è°ƒç”¨
<code>ecall</code>ï¼šæ­¤æ—¶ä¿®æ”¹satpä¼šç›´æ¥å¼‚å¸¸ï¼Œå› ä¸ºç”¨æˆ·æ€ä¸å…è®¸ä¿®æ”¹satpé¡µè¡¨ï¼›</li>
<li>å¦‚æœæˆ‘ä»¬å…ˆè°ƒç”¨ <code>ecall</code> å†ä¿®æ”¹
<code>satp</code>ï¼Œæˆ‘ä»¬çš„æ‰§è¡Œæ˜¯è¿™æ ·çš„ï¼š
<ol type="1">
<li>æ‰§è¡Œ <code>ecall</code> é™·å…¥å†…æ ¸æ€ï¼Œæ­¤æ—¶ <code>satp</code> ä»ç„¶æŒ‡å‘
<code>user_satp</code>ï¼›</li>
<li><strong><code>ecall</code> æˆ–å¼‚å¸¸è§¦å‘åï¼ŒCPU ä¼šè‡ªåŠ¨è·³è½¬åˆ°
<code>stvec</code> å¯„å­˜å™¨æŒ‡å‘çš„åœ°å€ï¼ˆä¹Ÿå°±æ˜¯ <code>__alltrap</code>
å‡½æ•°çš„ VAï¼‰</strong>ã€‚ç„¶è€Œï¼Œ<code>__alltrap</code> æŒ‡ä»¤æ˜¯å­˜æ”¾åœ¨å†…æ ¸æ€çš„
<code>.text</code>
æ®µä¸­ï¼ŒCPUå–å€¼ä¼šå°è¯•ä½¿ç”¨VAæŸ¥è¯¢PAï¼Œè€Œæ­¤æ—¶ç”¨æˆ·æ€çš„é¡µè¡¨æ ¹æœ¬æŸ¥ä¸åˆ°è¿™ä¸ªVAç›¸å…³çš„ä¿¡æ¯ã€‚</li>
</ol></li>
</ol></li>
<li>åˆ‡æ¢æ—¶å†…æ ¸æ€æ•°æ®/ä»£ç çš„å¯è®¿é—®æ€§ï¼šåœ¨ä»»æ„trapï¼ˆä¸»åŠ¨ecallè§¦å‘æˆ–è¢«åŠ¨è§¦å‘ï¼‰å‘ç”Ÿæ—¶ï¼š
<ol type="1">
<li>CPUä¼šæå‡åˆ°Sæ¨¡å¼ï¼Œæ­¤æ—¶ <code>satp</code> è¿˜æŒ‡å‘
<code>user_satp</code>ï¼›</li>
<li>CPUå°è¯•ä» <code>stvec</code> åŠ è½½å¼‚å¸¸å¤„ç†çš„ä»£ç ï¼Œè¿™ä¼šç›´æ¥å¼‚å¸¸ï¼Œå› ä¸º
<code>stvec</code> æŒ‡å‘çš„ä»£ç æ˜¯åœ¨å†…æ ¸æ€çš„ <code>.text</code>
ä¸­ï¼Œç”¨æˆ·æ€é¡µè¡¨æ ¹æœ¬æ— æ³•è®¿é—®ã€‚</li>
</ol></li>
</ol>
<h3 id="åº”ç”¨æ ˆå’Œåº”ç”¨å†…æ ¸æ ˆä»¥åŠå†…æ ¸æ ˆ">åº”ç”¨æ ˆå’Œåº”ç”¨å†…æ ¸æ ˆä»¥åŠå†…æ ¸æ ˆ</h3>
<p>åº”ç”¨çš„å†…æ ¸æ ˆï¼Œæ˜¯æ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªåº”ç”¨ç¨‹åºï¼ˆè¿›ç¨‹ï¼‰å•ç‹¬åˆ†é…çš„ã€ä»…åœ¨åº”ç”¨
â€œé™·å…¥å†…æ ¸æ€â€ æ—¶ä½¿ç”¨çš„ä¸“å±æ ˆâ€”â€”
æœ¬è´¨æ˜¯ä¸€å—å†…æ ¸åœ°å€ç©ºé—´ä¸­çš„ç‰©ç†å†…å­˜ï¼Œä¸“é—¨ç”¨äºæ‰¿è½½åº”ç”¨åœ¨æ ¸å†…æ€è¿è¡Œæ—¶çš„å‡½æ•°è°ƒç”¨ã€å±€éƒ¨å˜é‡ã€ä¸Šä¸‹æ–‡æ•°æ®ï¼ˆæ¯”å¦‚ç³»ç»Ÿè°ƒç”¨å¤„ç†ã€å¼‚å¸¸å¤„ç†çš„æ ˆå¸§ï¼‰ã€‚</p>
<p>ç®€å•è¯´ï¼šåº”ç”¨åœ¨ç”¨æˆ·æ€ï¼ˆæ¯”å¦‚è¿è¡Œè‡ªå·±çš„ä»£ç ï¼‰æ—¶ï¼Œç”¨çš„æ˜¯ã€Œç”¨æˆ·æ ˆã€ï¼›ä¸€æ—¦è§¦å‘ç³»ç»Ÿè°ƒç”¨ã€å¼‚å¸¸
/ ä¸­æ–­ï¼ˆæ¯”å¦‚ ecall
æŒ‡ä»¤ã€é¡µé”™è¯¯ï¼‰ï¼Œåˆ‡æ¢åˆ°å†…æ ¸æ€åï¼Œå†…æ ¸ä¼šè‡ªåŠ¨åˆ‡æ¢æ ˆæŒ‡é’ˆï¼ˆspï¼‰åˆ°è¯¥åº”ç”¨çš„ã€Œå†…æ ¸æ ˆã€ï¼Œæ‰€æœ‰å†…æ ¸ä»£ç ï¼ˆå¦‚
trap_handlerã€ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•°ï¼‰éƒ½åœ¨è¿™ä¸ªæ ˆä¸Šè¿è¡Œã€‚</p>
<p>è€Œå†…æ ¸è‡ªèº«è¿˜æœ‰ä¸€ä¸ª â€œå†…æ ¸ä¸»æ ˆâ€ï¼ˆKernel Main
Stackï¼‰ï¼Œä¸æ‰€æœ‰åº”ç”¨çš„å†…æ ¸æ ˆç‹¬ç«‹ï¼š</p>
<ul>
<li>å†…æ ¸ä¸»æ ˆï¼šç”¨äºå†…æ ¸åˆå§‹åŒ–ï¼ˆå¦‚ main
å‡½æ•°ï¼‰ã€ç¡¬ä»¶ä¸­æ–­å¤„ç†ï¼ˆä¸åº”ç”¨æ— å…³çš„ä¸­æ–­ï¼Œå¦‚æ—¶é’Ÿä¸­æ–­ï¼‰ç­‰å†…æ ¸åŸç”Ÿæµç¨‹ï¼›</li>
<li>åº”ç”¨çš„å†…æ ¸æ ˆï¼šä»…ç”¨äº
â€œè¯¥åº”ç”¨è§¦å‘çš„å†…æ ¸æ€æ“ä½œâ€ï¼ˆå¦‚è¯¥åº”ç”¨çš„ç³»ç»Ÿè°ƒç”¨ã€è¯¥åº”ç”¨å¯¼è‡´çš„é¡µé”™è¯¯ï¼‰ï¼›</li>
<li>ä¸¤è€…ç‰©ç†é¡µç‹¬ç«‹ã€åœ°å€ç©ºé—´ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰°ã€‚</li>
</ul>
<h3 id="sv39æ¨¡å¼ä¸‹çš„åœ°å€ç©ºé—´">SV39æ¨¡å¼ä¸‹çš„åœ°å€ç©ºé—´</h3>
<p><code>SV39</code> æ¨¡å¼éµå¾ªç¬¦å·æ‰©å±•ï¼ˆSign
Extensionï¼‰è§„åˆ™ï¼Œæ‰€ä»¥åœ°å€ç©ºé—´çš„ <code>[63:39]</code>
å¿…é¡»å’Œç¬¬<code>38</code>ä½ä¿æŒä¸€è‡´ï¼Œå¦åˆ™æ— æ³•é€šè¿‡ MMU
çš„æ ¡éªŒï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ°å€ç©ºé—´è¢«åˆ†ä¸ºäº† <code>[0, 0x3F FFFF FFFF FFFF)</code>
å’Œ <code>[0xFFFF FFC0 0000 0000, 0xFFFF FFFF FFFF FFFF)</code>
ä¸¤ä¸ªä¸è¿ç»­çš„ <code>256GiB</code> çš„åœ°å€ç©ºé—´ã€‚</p>
<p>åœ¨ <code>rCore</code> ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬æŠŠé«˜256GiBçš„å†…å­˜ç©ºé—´ç”¨æ¥å­˜å‚¨
<code>trampoline</code> å’Œåº”ç”¨å†…æ ¸æ ˆï¼ŒæŒ‰ç…§å¦‚ä¸‹æ ¼å¼ï¼š</p>
<ol type="1">
<li><code>trampoline</code> 4KiBï¼›</li>
<li><code>app 0 kernel stack</code> æ ¹æ® config#KERNEL_STACK_SIZE
å®šä¹‰ï¼›</li>
<li><code>Guard Page</code>ï¼›</li>
<li><code>app 1 kernel stack</code>ï¼›</li>
<li><code>Guard Page</code>ï¼›</li>
<li>...</li>
</ol>
<figure>
<img src="/images/20251121/kernel-as-high.png"
alt="kernel-as-high.png" />
<figcaption aria-hidden="true">kernel-as-high.png</figcaption>
</figure>
<p>ä½256GiBï¼Œæˆ‘ä»¬ç”¨æ¥å­˜å‚¨å†…æ ¸çš„æ®µï¼Œä»¥åŠç©ºé—²ç‰©ç†é¡µå¸§ï¼ˆAvailable Physical
Framesï¼‰ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ ¼å¼ï¼š</p>
<ol type="1">
<li>Available Physical Frames</li>
<li><code>.bss</code></li>
<li><code>.data</code></li>
<li><code>.rodata</code></li>
<li><code>.text</code></li>
</ol>
<figure>
<img src="/images/20251121/kernel-as-low.png" alt="kernel-as-low.png" />
<figcaption aria-hidden="true">kernel-as-low.png</figcaption>
</figure>
<ol type="1">
<li>è¿™é‡Œåœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡æ’ç­‰æ˜ å°„å°†
<code>.bss/.data/.rodata/.text</code> æ®µæ˜ å°„åˆ°äº†ç‰©ç†å†…å­˜ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨
linker.ld å†…å£°æ˜çš„ã€‚æ­¤å¤–ï¼Œä»¬çš„é¡¹ç›®æ˜¯åŸºäºqemuæ¨¡æ‹Ÿçš„ï¼Œè€Œqemuçš„å†…å­˜ç©ºé—´ä»
0x80000000å¼€å§‹ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬åœ¨linkeré‡Œè®¾ç½®äº†é”™è¯¯çš„ç‰©ç†å†…å­˜åœ°å€ï¼Œä¾‹å¦‚
0x78000000ï¼Œé‚£ä¹ˆç¨‹åºä¼šç›´æ¥å¯åŠ¨å¤±è´¥ã€‚</li>
<li>ä»£ç æ®µçš„ <code>U</code> éƒ½è®¾ç½®ä¸º0ï¼Œä¹Ÿå°±æ˜¯åªèƒ½åœ¨å†…æ ¸æ€è®¿é—®ï¼›</li>
<li><code>.text</code> ä¸å…è®¸è¢«ä¿®æ”¹ï¼›</li>
<li><code>.rodata</code> ä¸å…è®¸è¢«ä¿®æ”¹ï¼Œä¹Ÿä¸å…è®¸ä»å®ƒä¸Šé¢å–æŒ‡æ‰§è¡Œï¼›</li>
<li><code>.data/.bss</code>
å‡å…è®¸è¢«è¯»å†™ï¼Œä½†æ˜¯ä¸å…è®¸ä»å®ƒä¸Šé¢å–æŒ‡æ‰§è¡Œ</li>
</ol>
<h3 id="è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜">è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜</h3>
<h4 id="å†…æ ¸æ€çš„åˆ†é¡µé€»è¾‘">å†…æ ¸æ€çš„åˆ†é¡µé€»è¾‘</h4>
<blockquote>
<p>å¼€å¯åˆ†é¡µåï¼ŒCPU ä¸ä¼šåŒºåˆ† â€œå†…æ ¸æ€åœ°å€â€ å’Œ
â€œç”¨æˆ·æ€åœ°å€â€â€”â€”æ‰€æœ‰è®¿å­˜åœ°å€éƒ½ä¼šè¢«è§†ä¸ºè™šæ‹Ÿåœ°å€ï¼Œå¿…é¡»ç»è¿‡ MMU
æŸ¥é¡µè¡¨è½¬æ¢ã€‚å“ªæ€•æ˜¯å†…æ ¸è®¿é—®è‡ªå·±çš„ä»£ç ã€æ•°æ®ï¼Œä¹Ÿå¾—é€šè¿‡æ˜ å°„æ‰èƒ½æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†é¡µã€‚</p>
</blockquote>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨æˆ‘ä»¬çš„ <code>rCore</code>
å®ç°ä¸­ï¼Œæˆ‘ä»¬åœ¨é“¾æ¥å™¨ä¸­è®¾ç½®çš„èµ·å§‹åœ°å€æ˜¯
<code>0x80200000</code>ï¼Œæˆ‘ä»¬çš„è®¿é—®æ˜¯è¿™æ ·çš„ï¼š</p>
<ol type="1">
<li>å†…æ ¸ä»£ç æ®µå­˜æ”¾åœ¨ç‰©ç†åœ°å€ 0x80200000ï¼ˆekernel ä¹‹å‰ï¼‰ï¼›</li>
<li>å¯ç”¨åˆ†é¡µå‰ï¼ŒCPU æ‰§è¡Œ lw x1, 0x80200000ï¼Œç›´æ¥è®¿é—®ç‰©ç†å†…å­˜
0x80200000ï¼›</li>
<li>å¯ç”¨åˆ†é¡µåï¼ŒCPU ä¼šæŠŠ 0x80200000 å½“æˆ è™šæ‹Ÿåœ°å€ï¼š
<ol type="1">
<li>è‹¥é¡µè¡¨ä¸­æ²¡æœ‰ â€œè™šæ‹Ÿåœ°å€ 0x80200000 â†’ ç‰©ç†åœ°å€ 0x80200000â€ çš„æ˜ å°„ï¼ŒMMU
ä¼šè§¦å‘é¡µé”™è¯¯ï¼Œå†…æ ¸ç›´æ¥å´©æºƒï¼›</li>
<li>åªæœ‰å»ºç«‹äº†æ˜ å°„ï¼ŒMMU
æ‰ä¼šæŠŠè™šæ‹Ÿåœ°å€è½¬æˆç‰©ç†åœ°å€ï¼Œå†…æ ¸æ‰èƒ½æ­£å¸¸æ‰§è¡Œä»£ç ã€è®¿é—®æ•°æ®ã€‚</li>
</ol></li>
</ol>
<blockquote>
<p>å†…æ ¸æ€çš„å†…å­˜ï¼ˆä»£ç ã€æ•°æ®ã€æ ˆã€é¡µè¡¨æœ¬èº«ï¼‰ï¼Œæ˜¯ â€œéœ€è¦è®¿é—®çš„ç‰©ç†é¡µâ€
ä¸­æœ€æ ¸å¿ƒçš„ä¸€éƒ¨åˆ†ï¼Œå¿…é¡»ä¼˜å…ˆå»ºç«‹æ˜ å°„ â€”â€” å¦åˆ™å†…æ ¸è‡ªå·±éƒ½è·‘ä¸èµ·æ¥ã€‚</p>
</blockquote>
<h4
id="å†…æ ¸æ€éœ€è¦æ˜ å°„çš„ç‰©ç†é¡µå…·ä½“æœ‰å“ªäº›">å†…æ ¸æ€éœ€è¦æ˜ å°„çš„ç‰©ç†é¡µå…·ä½“æœ‰å“ªäº›</h4>
<ol type="1">
<li>å†…æ ¸è‡ªèº«çš„ä»£ç æ®µï¼ˆ.textï¼‰ã€æ•°æ®æ®µï¼ˆ.dataï¼‰ã€.bss
æ®µï¼šå†…æ ¸çš„æŒ‡ä»¤ã€å…¨å±€å˜é‡ã€æœªåˆå§‹åŒ–å˜é‡éƒ½å­˜åœ¨è¿™äº›ç‰©ç†é¡µä¸­ï¼Œæ˜¯å†…æ ¸è¿è¡Œçš„åŸºç¡€
â€”â€” å¿…é¡»å»ºç«‹æ˜ å°„ï¼Œå¦åˆ™å†…æ ¸æ— æ³•æ‰§è¡ŒæŒ‡ä»¤ã€è®¿é—®å…¨å±€å˜é‡ã€‚</li>
<li>å†…æ ¸æ ˆï¼ˆKernel Stackï¼‰ï¼šå†…æ ¸çº¿ç¨‹ /
è¿›ç¨‹çš„æ ˆç©ºé—´ï¼ˆç”¨äºå‡½æ•°è°ƒç”¨ã€å±€éƒ¨å˜é‡å­˜å‚¨ï¼‰ï¼Œæœ¬è´¨æ˜¯ä¸€å—ç‰©ç†é¡µ â€”â€”
å¿…é¡»å»ºç«‹æ˜ å°„ï¼Œå¦åˆ™å†…æ ¸å‡½æ•°è°ƒç”¨ä¼šæ ˆæº¢å‡ºæˆ–è®¿é—®éæ³•åœ°å€ã€‚</li>
<li><strong>é¡µè¡¨é¡µï¼ˆæ ¹é¡µè¡¨ã€ä¸­é—´çº§é¡µè¡¨ï¼‰ï¼šé¡µè¡¨æœ¬èº«ä¹Ÿæ˜¯ç‰©ç†é¡µï¼Œå†…æ ¸éœ€è¦ä¿®æ”¹é¡µè¡¨é¡¹ï¼ˆå¦‚ä¸ºç”¨æˆ·è¿›ç¨‹å»ºç«‹æ˜ å°„ï¼‰ï¼Œå°±å¿…é¡»è®¿é—®è¿™äº›ç‰©ç†é¡µ
â€”â€” å› æ­¤é¡µè¡¨é¡µè‡ªèº«ä¹Ÿéœ€è¦å»ºç«‹æ˜ å°„ï¼ˆé€šå¸¸æ˜¯æ’ç­‰æ˜ å°„ï¼‰ã€‚ </strong></li>
<li>å†…æ ¸ç®¡ç†çš„ç©ºé—²ç‰©ç†é¡µï¼ˆæŒ‰éœ€æ˜ å°„ï¼‰ï¼š å†…æ ¸éœ€è¦åˆ†é… /
å›æ”¶ç‰©ç†é¡µï¼ˆå¦‚ç”¨æˆ·è¿›ç¨‹ malloc æ—¶ï¼‰ï¼Œå°±å¿…é¡»è®¿é—®è¿™äº›ç©ºé—²ç‰©ç†é¡µ â€”â€”
é€šè¿‡æ’ç­‰æ˜ å°„ï¼Œå†…æ ¸å¯ä»¥ç›´æ¥ç”¨ â€œç‰©ç†åœ°å€ä½œä¸ºè™šæ‹Ÿåœ°å€â€
è®¿é—®å®ƒä»¬ï¼Œæ— éœ€é¢å¤–è®¡ç®—åç§»ã€‚</li>
</ol>
<blockquote>
<p>è¿™äº›æ˜ å°„é€šå¸¸åœ¨å†…æ ¸åˆå§‹åŒ–é˜¶æ®µã€å¯ç”¨åˆ†é¡µä¹‹å‰å°±å»ºç«‹å®Œæˆï¼Œç¡®ä¿å¯ç”¨åˆ†é¡µåå†…æ ¸èƒ½æ­£å¸¸è¿è¡Œã€‚</p>
</blockquote>
<h4 id="å¦‚ä½•å»ºç«‹æ˜ å°„">å¦‚ä½•å»ºç«‹æ˜ å°„</h4>
<blockquote>
<p>é™¤äº† â€œç”¨æˆ·æ€ç§æœ‰æ•°æ®é¡µâ€ å’Œ
â€œæŒ‰éœ€åŠ¨æ€æ˜ å°„çš„ç©ºé—²ç‰©ç†é¡µâ€ï¼Œå†…æ ¸æ€æ‰€æœ‰éœ€è¦è®¿é—®çš„ç‰©ç†é¡µï¼ˆä»£ç æ®µã€æ•°æ®æ®µã€.bssã€å†…æ ¸æ ˆã€é¡µè¡¨é¡µï¼‰ï¼Œå‡ä½¿ç”¨æ’ç­‰æ˜ å°„ï¼ˆVA=PAï¼‰ã€‚</p>
</blockquote>
<ul>
<li>ä»¥ä¸‹åœºæ™¯å¿…é¡»ä½¿ç”¨
<code>æ’ç­‰æ˜ å°„</code>ï¼Œå› ä¸ºå¿…é¡»ç›´æ¥è®¿é—®ç‰©ç†é¡µï¼Œä¸”åœ°å€ä¸èƒ½å˜ï¼š
<ul>
<li>å†…æ ¸ä»£ç æ®µï¼ˆ.textï¼‰ã€æ•°æ®æ®µï¼ˆ.dataï¼‰ã€.bss æ®µï¼š
é“¾æ¥å™¨æŒ‡å®šçš„åœ°å€å°±æ˜¯ç‰©ç†åœ°å€ï¼Œå†…æ ¸ä»£ç  /
å…¨å±€å˜é‡çš„å¼•ç”¨ç›´æ¥ä¾èµ–è¿™ä¸ªåœ°å€ï¼Œæ”¹ç”¨éæ’ç­‰æ˜ å°„ä¼šå¯¼è‡´
â€œä»£ç æŒ‡ä»¤åœ°å€æ‰¾ä¸åˆ°â€â€œå…¨å±€å˜é‡è®¿é—®é”™ä½â€ï¼Œå†…æ ¸æ— æ³•è¿è¡Œï¼›</li>
<li>å†…æ ¸æ ˆï¼ˆKernel Stackï¼‰ï¼š
æ ˆæŒ‡é’ˆï¼ˆspï¼‰æŒ‡å‘çš„æ˜¯ç‰©ç†åœ°å€ï¼Œå‡½æ•°è°ƒç”¨ã€å±€éƒ¨å˜é‡å­˜å‚¨ä¾èµ–è¿™ä¸ªåœ°å€çš„è¿ç»­æ€§ï¼Œéæ’ç­‰æ˜ å°„ä¼šå¯¼è‡´æ ˆè®¿é—®å¼‚å¸¸ï¼ˆå¦‚æ ˆæº¢å‡ºã€æ•°æ®é”™ä¹±ï¼‰ï¼›</li>
<li>é¡µè¡¨é¡µï¼ˆæ ¹é¡µè¡¨ã€ä¸­é—´çº§é¡µè¡¨ï¼‰ï¼š
é¡µè¡¨é¡¹ï¼ˆPTEï¼‰ä¸­å­˜å‚¨çš„æ˜¯ç‰©ç†é¡µå·ï¼ˆPPNï¼‰ï¼Œå†…æ ¸ä¿®æ”¹é¡µè¡¨æ—¶éœ€è¦ç›´æ¥è®¿é—®é¡µè¡¨é¡µçš„ç‰©ç†åœ°å€ï¼Œæ’ç­‰æ˜ å°„èƒ½è®©å†…æ ¸
â€œä»¥ç‰©ç†åœ°å€ä¸ºè™šæ‹Ÿåœ°å€â€ ç›´æ¥æ“ä½œï¼Œæ— éœ€é¢å¤–è®¡ç®—åç§»ã€‚</li>
</ul></li>
<li>ç©ºé—²ç‰©ç†é¡µæ˜¯æ¯æ¬¡ç”¨æˆ·æ€ç¨‹åºç”³è¯·å†…å­˜æ—¶ï¼Œä» FRAME_ALLOCATOR
ä¸­å¾—åˆ°çš„éšæœºæ˜ å°„ã€‚</li>
</ul>
<p>æˆ‘ä»¬æ•´ä½“çš„æµç¨‹å¯ä»¥æ€»ç»“ä¸ºï¼š</p>
<pre><code class="highlight mermaid">flowchart TD
    A[&quot;å¯åŠ¨å†…æ ¸ï¼ˆåˆ†é¡µå…³é—­ï¼ŒPA ç›´è®¿ï¼‰&quot;] --&gt; B[&quot;åˆå§‹åŒ– FRAME_ALLOCATORã€PageTableã€KERNEL_STACK ç­‰&quot;]
    B --&gt; C[&quot;åœ¨ PageTable ä¸­å»ºç«‹å†…æ ¸ç›¸å…³ç‰©ç†é¡µçš„æ’ç­‰æ˜ å°„ï¼ˆ.text/.data/æ ˆ/é¡µè¡¨é¡µï¼‰&quot;]
    C --&gt; D[&quot;é…ç½® satp å¯„å­˜å™¨ï¼ˆæ¨¡å¼+æ ¹ PPnï¼‰+ sfence.vma åˆ·æ–° TLB&quot;]
    D --&gt; E[&quot;åˆ†é¡µå¼€å¯æˆåŠŸï¼ˆVA è®¿å­˜ï¼ŒMMU è½¬æ¢ï¼‰&quot;]
    E --&gt; F[&quot;ç”¨æˆ·è¿›ç¨‹åˆ›å»ºï¼šåˆå§‹åŒ–ä¸“å± PageTable&quot;]
    F --&gt; G[&quot;ç”¨æˆ· mallocï¼šåˆ†é…ç‰©ç†é¡µ + åŠ¨æ€å»ºç«‹ VAâ†’PA æ˜ å°„ï¼ˆç”¨æˆ·é¡µè¡¨ï¼‰&quot;]
    G --&gt; H[&quot;è¿›ç¨‹åˆ‡æ¢ï¼šåˆ‡æ¢ satp åˆ°ç”¨æˆ·é¡µè¡¨ + åˆ·æ–° TLB&quot;]</code></pre>
<h3 id="physpagenumå’Œframetracker">PhysPageNumå’ŒFrameTracker</h3>
<p>ä½¿ç”¨ <code>FrameTracker</code> ä»£æ›¿ <code>PhysPageNum</code>
è¿™ä¸ªæ˜¯åŸºäº <code>RAII</code> çš„æ€æƒ³çš„è®¾è®¡ï¼šæˆ‘ä»¬ä¸º
<code>FrameTracker</code> å®ç°äº†
<code>Drop</code>ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ç”¨æ‰‹åŠ¨çš„åœ¨ç‰©ç†æ ˆå¸§é€€å‡ºä½œç”¨åŸŸæ—¶æ‰‹åŠ¨çš„
<code>dealloc()</code> äº†ã€‚</p>
<p>è€Œè¿™é‡Œï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥ä½¿ç”¨ <code>FrameTracker</code> æ¥å®ç°ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¸º
<code>PhysPageNum</code> å®ç° <code>Drop</code>
æ¥å£ï¼Œæ˜¯å› ä¸ºä¸¤è€…çš„è¯­ä¹‰æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ï¼š</p>
<ol type="1">
<li><code>PhysPageNum</code> æ˜¯ç‰©ç†é¡µå¸§çš„ç¼–å·ï¼Œä»–æ˜¯ä¸€ä¸ªæ— æ‰€æœ‰æƒçš„
â€œæ ‡è¯†â€ï¼›</li>
<li><code>FrameTracker</code> æ˜¯ç‰©ç†é¡µå¸§çš„ â€œèµ„æºå¥æŸ„â€ï¼Œæ˜¯
<strong>æ‰€æœ‰æƒçš„ç®¡ç†è€…ã€‚</strong></li>
</ol>
<table>
<colgroup>
<col style="width: 9%" />
<col style="width: 17%" />
<col style="width: 10%" />
<col style="width: 62%" />
</colgroup>
<thead>
<tr class="header">
<th>ç±»å‹</th>
<th>æ ¸å¿ƒè¯­ä¹‰</th>
<th>è§’è‰²å®šä½</th>
<th>å…³é”®ç‰¹æ€§</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>PhysPageNum</td>
<td>ç‰©ç†é¡µå¸§çš„ â€œç¼–å·â€ï¼ˆå¦‚ 0x100ã€0x200ï¼‰</td>
<td>æ— æ‰€æœ‰æƒçš„ â€œæ ‡è¯† / ç´¢å¼•â€</td>
<td>1. ä»…å­˜å‚¨é¡µå·ï¼Œä¸å…³è” â€œåˆ†é…çŠ¶æ€â€ï¼› <br/>2.
å¯å¤åˆ¶ã€å¯ä¼ é€’ï¼Œä¸å½±å“ç‰©ç†é¡µï¼›<br/> 3. æ— æ³•æ„ŸçŸ¥ â€œæ˜¯å¦è¢«åˆ†é…â€ã€‚</td>
</tr>
<tr class="even">
<td>FrameTracker</td>
<td>ç‰©ç†é¡µå¸§çš„ â€œèµ„æºå¥æŸ„â€</td>
<td>æœ‰æ‰€æœ‰æƒçš„ â€œç®¡ç†è€…â€</td>
<td>1. æŒæœ‰ PhysPageNumï¼Œä»£è¡¨ â€œç‹¬å è¯¥ç‰©ç†é¡µâ€ï¼›<br/>2. å®ç°
Dropï¼Œç¦»å¼€ä½œç”¨åŸŸè‡ªåŠ¨è°ƒç”¨ deallocï¼›<br/> 3. ä¸å¯éšæ„å¤åˆ¶ï¼ˆé€šå¸¸
!Cloneï¼‰ï¼Œç¡®ä¿æ‰€æœ‰æƒå”¯ä¸€ã€‚</td>
</tr>
</tbody>
</table>
<p>ç±»ä¼¼äºæˆ¿é—´ï¼Œ<code>PhysPageNum</code>
æ˜¯æˆ¿é—´å·ï¼Œè€Œ<code>FrameTracker</code>æ˜¯ä¸šä¸»ã€‚</p>
<p>å†ä»ä¸¤ä¸ªstructçš„å®ç°æ¥çœ‹ï¼š</p>
<ol type="1">
<li>PhysPageNum æ˜¯ç®€å•çš„åŒ…è£…ç±»å‹ï¼ˆstruct PhysPageNum(pub
usize)ï¼‰ï¼Œå¯å¤åˆ¶ï¼Œå¯æ‹·è´ç­‰ï¼›</li>
<li>FrameTracker ä¸å¯å¤åˆ¶ï¼Œä¸å¯æ‹·è´ï¼›</li>
</ol>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// physical page number</span></span><br><span class="line"><span class="meta">#[derive(Copy, Clone, Ord, PartialOrd, Eq, PartialEq)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">PhysPageNum</span>(<span class="keyword">pub</span> <span class="type">usize</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// tracker for physical page frame allocation and deallocation</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">FrameTracker</span> &#123;</span><br><span class="line">    <span class="comment">/// physical page number</span></span><br><span class="line">    <span class="keyword">pub</span> ppn: PhysPageNum,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å†…å­˜çš„å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´">å†…å­˜çš„å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´</h3>
<blockquote>
<p>åœ¨æˆ‘ä»¬ä½¿ç”¨å†…å­˜çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸¤ä¸ªä¸€ç›´è¢«æåˆ°çš„åè¯ï¼š<code>å†…æ ¸ç©ºé—´</code>
å’Œ
<code>ç”¨æˆ·ç©ºé—´</code>ï¼Œé‚£ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿæ˜¯æ€ä¹ˆåŒºåˆ†å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„å‘¢ï¼Ÿ</p>
</blockquote>
<p><strong>é¦–å…ˆéœ€è¦çŸ¥é“çš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªç©ºé—´éƒ½æ˜¯æ“ä½œç³»ç»Ÿçš„æ¦‚å¿µã€‚</strong>
ç¡¬ä»¶ï¼ˆCPU/MMUï¼‰å¯¹ç‰©ç†å†…å­˜çš„æ‰€æœ‰é¡µå¸§ä¸€è§†åŒä»ã€‚æ‰€è°“
â€œå†…æ ¸ç‰©ç†å†…å­˜â€â€œç”¨æˆ·ç‰©ç†å†…å­˜â€ï¼Œæ˜¯æ“ä½œç³»ç»Ÿä¸ºäº†ç®¡ç†æ–¹ä¾¿ï¼ˆé¿å…å†²çªã€ç»Ÿä¸€å›æ”¶ï¼‰è€Œåšçš„è½¯ä»¶åˆ’åˆ†ï¼ˆæ¯”å¦‚æŠŠç‰©ç†åœ°å€
0x80000000~0xFFFF0000 åˆ’åˆ†ä¸ºå†…æ ¸ä¸“ç”¨ï¼‰ï¼Œç¡¬ä»¶ä¸æ„ŸçŸ¥è¿™ä¸ªåˆ’åˆ†ã€‚</p>
<p>ç¡¬ä»¶åˆ¤æ–­ â€œå½“å‰è®¿é—®çš„æ˜¯å†…æ ¸ç©ºé—´è¿˜æ˜¯ç”¨æˆ·ç©ºé—´â€ï¼Œæ ¸å¿ƒä¾æ®æ˜¯
è™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰ï¼Œè€Œéç‰©ç†åœ°å€ï¼ˆPAï¼‰â€”â€” å…·ä½“æ˜¯ â€œVA é«˜ä½ç‰¹å¾ + é¡µè¡¨é¡¹ U ä½ +
å½“å‰ CPU ç‰¹æƒçº§â€ ä¸‰è€…ååŒï¼š</p>
<ul>
<li>VA é«˜ä½ï¼šåˆæ­¥å½’ç±»ï¼ˆä¾‹å¦‚å¦‚ Sv39 çš„ 0x0000_0000_0000~0x7FFF_FFFF_FFFF
ä¸ºç”¨æˆ· VAï¼Œ0x8000_0000_0000~0xFFFF_FFFF_FFFF ä¸ºå†…æ ¸ VAï¼‰ï¼›</li>
<li>é¡µè¡¨é¡¹ U
ä½ï¼šç²¾å‡†æƒé™ï¼ˆ<code>U=1</code>â†’å…è®¸ç”¨æˆ·æ€è®¿é—®ï¼Œ<code>U=0</code>â†’ä»…å…è®¸å†…æ ¸æ€è®¿é—®ï¼‰ï¼›</li>
<li>CPU ç‰¹æƒçº§ï¼šæœ€ç»ˆæ ¡éªŒï¼ˆç”¨æˆ·æ€ä¸èƒ½è®¿é—® U=0 çš„ VAï¼Œå†…æ ¸æ€å¯è®¿é—®æ‰€æœ‰
VAï¼‰ã€‚</li>
</ul>
<p>æ€»ç»“æ¥è¯´ï¼š</p>
<ul>
<li>ç¡¬ä»¶ï¼šåªè®¤ â€œVA é«˜ä½ + PTE U ä½ +
ç‰¹æƒçº§â€ï¼Œä¸ç®¡ç‰©ç†å†…å­˜çš„è½¯ä»¶åˆ’åˆ†ï¼›</li>
<li>æ“ä½œç³»ç»Ÿï¼šåˆ¶å®š VA åˆ’åˆ†è§„åˆ™ã€è®¾ç½® PTE æƒé™ã€ç®¡ç† PA
åˆ†é…ï¼Œè®©ç¡¬ä»¶çš„åˆ¤æ–­é€»è¾‘æœåŠ¡äº â€œå†…æ ¸ / ç”¨æˆ·éš”ç¦»â€ï¼›</li>
</ul>
<p>è€Œåœ¨ <code>rCore</code> çš„å¼€å‘è¿‡ç¨‹ä¸­ï¼š è¿™ä¸ªç‰¹æƒçº§åˆ‡æ¢è·¯å¾„æ˜¯ï¼šM
æ¨¡å¼ï¼ˆå¼•å¯¼ï¼‰â†’ S æ¨¡å¼ï¼ˆå†…æ ¸è¿è¡Œï¼‰â†’ U æ¨¡å¼ï¼ˆç”¨æˆ·è¿›ç¨‹è¿è¡Œï¼‰</p>
<p>æˆ‘ä»¬é€šå¸¸æ˜¯åœ¨Mæ¨¡å¼ä¸‹ï¼Œå¼€å§‹åŠ è½½ä¸€æ®µå†…æ ¸å¼•å¯¼ä»£ç ï¼š</p>
<ol type="1">
<li>é€šå¸¸æˆ‘ä»¬ä¼šåœ¨é“¾æ¥å™¨é‡Œå£°æ˜ä¸€ä¸ª ekernel
è¡¨ç¤ºå†…æ ¸ä»£ç çš„ç»“æŸåœ°å€ï¼Œå¹¶ä¸”è¿›è¡Œå†…å­˜å¯¹é½ï¼›</li>
<li>å†…æ ¸ä¼šç»´æŠ¤ä¸€ä¸ªmemory allocatorï¼Œè¿™ä¸ªmemory allocator ä¼šä½¿ç”¨ ekernel
ç‰©ç†å†…å­˜ä½œä¸ºåˆ†é…çš„èµ·å§‹ç‚¹ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ€å†…å­˜çš„èµ·å§‹ç‚¹ï¼Œå¹¶åœ¨å†…æ ¸ä»£ç çš„é…ç½®ä¸­å£°æ˜ä¸€ä¸ªå€¼ä½œä¸ºç”¨æˆ·æ€åœ°å€çš„ç»ˆç‚¹ã€‚</li>
</ol>
<p>éšåï¼Œå†…æ ¸åœ¨åˆ†é…å†…å­˜çš„è¿‡ç¨‹ä¸­å°±å›´ç»•è¿™ä¸€ç‰‡è¢«åˆ’åˆ†åˆ°ç”¨æˆ·æ€çš„è™šæ‹Ÿå†…å­˜æ¥åˆ†é…å¯¹åº”çš„ç‰©ç†å†…å­˜ï¼ŒåŒæ—¶ç»´æŠ¤é¡µè¡¨é¡¹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»æ»¡è¶³äº†VAé«˜ä½+PTE
Uä½è¿™ä¸¤ä¸ªæ¡ä»¶ã€‚</p>
<p>è€Œç‰¹æƒçº§è¿™ä¸ªæ¡ä»¶ï¼Œæˆ‘ä»¬æ˜¯åŸºäºtrapæ¥å®ç°çš„ï¼Œåœ¨ç”¨æˆ·æ€ä¸‹ï¼Œå¦‚æœéœ€è¦è®¿é—®å†…æ ¸ç©ºé—´ä»£ç ï¼Œåˆ™éœ€è¦é€šè¿‡trapè·³è½¬åˆ°å¯¹åº”çš„ç‰¹æƒçº§ã€‚</p>
<h3 id="from-å’Œ-into"><code>from</code> å’Œ <code>into</code></h3>
<p>åœ¨ Rust ä¸­ï¼ŒFrom å’Œ Into æ˜¯ä¸€å¯¹ ç±»å‹è½¬æ¢ç›¸å…³çš„ traitï¼Œæ ¸å¿ƒä½œç”¨æ˜¯ å®šä¹‰
â€œå®‰å…¨ã€æ— æ­§ä¹‰çš„ç±»å‹è½¬æ¢è§„åˆ™â€ï¼Œé¿å…æ‰‹åŠ¨å†™é‡å¤çš„è½¬æ¢ä»£ç ï¼ŒåŒæ—¶è®©ä»£ç æ›´ç®€æ´ã€å¯è¯»æ€§æ›´å¼ºã€‚äºŒè€…æœ¬è´¨æ˜¯
â€œåŒä¸€è½¬æ¢çš„æ­£åä¸¤é¢â€ï¼Œéµå¾ª â€œå®ç° <code>From&lt;A&gt;</code> for
Bï¼Œè‡ªåŠ¨è·å¾— <code>Into&lt;B&gt;</code> for Aâ€
çš„è®¾è®¡ï¼ˆæ— éœ€é‡å¤å®ç°ï¼‰ã€‚</p>
<p>ä¸€èˆ¬è€Œè¨€ï¼Œå½“æˆ‘ä»¬ä¸ºç±»å‹ U å®ç°äº† From<T> Trait ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨
U::from(_: T) æ¥ä»ä¸€ä¸ª T ç±»å‹çš„å®ä¾‹æ¥æ„é€ ä¸€ä¸ª U
ç±»å‹çš„å®ä¾‹ï¼›è€Œå½“æˆ‘ä»¬ä¸ºç±»å‹ U å®ç°äº† Into<T> Trait ä¹‹åï¼Œå¯¹äºä¸€ä¸ª U
ç±»å‹çš„å®ä¾‹ u ï¼Œå¯ä»¥ä½¿ç”¨ u.into() æ¥å°†å…¶è½¬åŒ–ä¸ºä¸€ä¸ªç±»å‹ä¸º T çš„å®ä¾‹ã€‚</p>
<h3 id="sv39å¤šçº§é¡µè¡¨çš„ç¡¬ä»¶åŸºå€">SV39å¤šçº§é¡µè¡¨çš„ç¡¬ä»¶åŸºå€</h3>
<ul>
<li><code>SATP</code> Supervisor Address Translation and
Protectionï¼Œç›´æ¥æ§åˆ¶å¤„ç†å™¨æ˜¯å¦å¯ç”¨è™šæ‹Ÿåœ°å€è½¬æ¢ï¼ˆMMU
åŠŸèƒ½ï¼‰ï¼Œå¹¶æŒ‡å®šé¡µè¡¨çš„ç‰©ç†åœ°å€ã€‚</li>
</ul>
<figure>
<img src="/images/20251121/satp.png" alt="satp.png" />
<figcaption aria-hidden="true">satp.png</figcaption>
</figure>
<ul>
<li><p><code>MODE</code> æ§åˆ¶ CPU ä½¿ç”¨å“ªç§é¡µè¡¨å®ç°ï¼›</p></li>
<li><p><code>ASID</code>
è¡¨ç¤ºåœ°å€ç©ºé—´æ ‡è¯†ç¬¦ï¼Œè¿™é‡Œè¿˜æ²¡æœ‰æ¶‰åŠåˆ°è¿›ç¨‹çš„æ¦‚å¿µï¼Œæˆ‘ä»¬ä¸éœ€è¦ç®¡è¿™ä¸ªåœ°æ–¹ï¼›</p></li>
<li><p><code>PPN(Pyhsical Page Number)</code>
å­˜çš„æ˜¯æ ¹é¡µè¡¨æ‰€åœ¨çš„ç‰©ç†é¡µå·ã€‚è¿™æ ·ï¼Œç»™å®šä¸€ä¸ªè™šæ‹Ÿé¡µå·ï¼ŒCPU
å°±å¯ä»¥ä»ä¸‰çº§é¡µè¡¨çš„æ ¹é¡µè¡¨å¼€å§‹ä¸€æ­¥æ­¥çš„å°†å…¶æ˜ å°„åˆ°ä¸€ä¸ªç‰©ç†é¡µå·ã€‚</p></li>
<li><p>å½“ MODE è®¾ç½®ä¸º 0 çš„æ—¶å€™ï¼Œä»£è¡¨æ‰€æœ‰è®¿å­˜éƒ½è¢«è§†ä¸ºç‰©ç†åœ°å€ï¼›</p></li>
<li><p>è€Œè®¾ç½®ä¸º 8 çš„æ—¶å€™ï¼ŒSV39 åˆ†é¡µæœºåˆ¶è¢«å¯ç”¨ï¼Œæ‰€æœ‰ S/U
ç‰¹æƒçº§çš„è®¿å­˜è¢«è§†ä¸ºä¸€ä¸ª 39 ä½çš„è™šæ‹Ÿåœ°å€ï¼Œå®ƒä»¬éœ€è¦å…ˆç»è¿‡ MMU
çš„åœ°å€è½¬æ¢æµç¨‹ï¼Œå¦‚æœé¡ºåˆ©çš„è¯ï¼Œåˆ™ä¼šå˜æˆä¸€ä¸ª 56
ä½çš„ç‰©ç†åœ°å€æ¥è®¿é—®ç‰©ç†å†…å­˜ï¼›å¦åˆ™åˆ™ä¼šè§¦å‘å¼‚å¸¸ï¼Œè¿™ä½“ç°äº†åˆ†é¡µæœºåˆ¶çš„å†…å­˜ä¿æŠ¤èƒ½åŠ›ã€‚</p></li>
</ul>
<h4 id="åœ°å€æ ¼å¼ä¸ç»„æˆ">åœ°å€æ ¼å¼ä¸ç»„æˆ</h4>
<figure>
<img src="/images/20251121/sv39-va-pa.png" alt="sv39-va-pa.png" />
<figcaption aria-hidden="true">sv39-va-pa.png</figcaption>
</figure>
<p>åœ¨ <code>SV39</code> ä¸‹ï¼Œæˆ‘ä»¬çš„ VA æ€»å…±æœ‰ 39
ä½ã€‚å¹¶ä¸”åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li><code>PO(Page Offset)</code>
ç”¨äºè¡¨ç¤ºé¡µå†…åç§»é‡ï¼Œè¿™ä¸ªå’Œæˆ‘ä»¬é¡µçš„å¤§å°æœ‰å…³ï¼Œå‡è®¾æ¯é¡µæ˜¯
<code>4KB</code>ï¼Œé‚£ä¹ˆå°±éœ€è¦ <code>12</code> ä½ï¼›</li>
<li><code>VPN(Virtual Page Number)</code> ç”¨äº
PPNï¼Œåœ¨æ˜ å°„å®Œä¹‹åé€šå¸¸è¢«æ‰©å±•ï¼Œä¾‹å¦‚å¯èƒ½ä» <code>27</code> ä½æ‰©å±•åˆ°
<code>44</code> ä½ã€‚</li>
</ul>
<blockquote>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬çš„PPNçš„èŒƒå›´æ˜¯è¦å¤§äºVPNçš„ï¼Œæ ¸å¿ƒæ˜¯ä¸ºäº†
â€œè§£è€¦è™šæ‹Ÿç©ºé—´éœ€æ±‚å’Œç‰©ç†ç©ºé—´èƒ½åŠ›â€ï¼š 1.
è™šæ‹Ÿç©ºé—´åªéœ€è¦æ»¡è¶³åº”ç”¨çš„â€œè§‚æ„Ÿéœ€æ±‚â€: åº”ç”¨éœ€è¦çš„æ˜¯
â€œè¿ç»­ã€è¶³å¤Ÿå¤§çš„åœ°å€ç©ºé—´â€ï¼Œè€Œé â€œå®é™…çš„ç‰©ç†å†…å­˜â€ï¼Œè€Œ512GB
è™šæ‹Ÿç©ºé—´è¶³å¤Ÿè¦†ç›–ç»å¤§å¤šæ•°åœºæ™¯ 2. ç‰©ç†ç©ºé—´éœ€è¦æ»¡è¶³ç¡¬ä»¶çš„ â€œæ‰©å±•éœ€æ±‚â€ã€‚</p>
<p>è€Œè§£è€¦çš„æ ¸å¿ƒä»·å€¼åœ¨äºï¼š - åº”ç”¨ä¸ä¾èµ–ç‰©ç†å†…å­˜å¤§å°ï¼šå³ä½¿ç‰©ç†å†…å­˜åªæœ‰
8GBï¼Œåº”ç”¨ä¹Ÿèƒ½ä½¿ç”¨ 512GB è™šæ‹Ÿç©ºé—´ï¼ˆé€šè¿‡ â€œæŒ‰éœ€åˆ†é¡µâ€ å’Œ
â€œäº¤æ¢åˆ†åŒºâ€ï¼Œè£¸æœºåœºæ™¯å¯çœç•¥äº¤æ¢åˆ†åŒºï¼‰ï¼› -
ç‰©ç†å†…å­˜å¯çµæ´»åˆ†é…ï¼šå¤šä¸ªåº”ç”¨çš„è™šæ‹Ÿç©ºé—´å¯ä»¥æ˜ å°„åˆ°ç‰©ç†å†…å­˜çš„ä¸åŒåŒºåŸŸï¼Œç‰©ç†å†…å­˜ä¸è¶³æ—¶ï¼Œå†…æ ¸å¯ä»¥å›æ”¶ä¸å¸¸ç”¨çš„ç‰©ç†é¡µï¼ˆæ¢å‡ºåˆ°ç£ç›˜ï¼‰ï¼Œå†åˆ†é…ç»™éœ€è¦çš„åº”ç”¨ï¼›
- ç¡¬ä»¶å‡çº§æ— éœ€ä¿®æ”¹åº”ç”¨ï¼šå½“ç‰©ç†å†…å­˜ä» 8GB å‡çº§åˆ° 64GBï¼Œåº”ç”¨æ— éœ€é‡æ–°ç¼–è¯‘
â€”â€” å†…æ ¸åªéœ€æ›´æ–°é¡µè¡¨æ˜ å°„ï¼Œåº”ç”¨çš„è™šæ‹Ÿåœ°å€ç©ºé—´å®Œå…¨ä¸å˜ã€‚</p>
</blockquote>
<h4
id="é¡µè¡¨é¡¹çš„æ•°æ®ç»“æ„æŠ½è±¡ä¸ç±»å‹å®šä¹‰">é¡µè¡¨é¡¹çš„æ•°æ®ç»“æ„æŠ½è±¡ä¸ç±»å‹å®šä¹‰</h4>
<figure>
<img src="/images/20251121/sv39-pte.png" alt="sv39-pte.png" />
<figcaption aria-hidden="true">sv39-pte.png</figcaption>
</figure>
<ul>
<li>SV39æ˜¯ä¸€ä¸ªä¸‰çº§é¡µè¡¨ï¼Œå…¶ä¸­ <code>[53: 10]</code> è¿™ 44
ä½æ˜¯ç‰©ç†é¡µå·ï¼Œå¹¶ä¸”å¯¹åº”äº†åœ¨TLBä¸­çš„ä¸€çº§ç´¢å¼•ï¼ŒäºŒçº§ç´¢å¼•ä¸€çº§ä¸‰çº§ç´¢å¼•ï¼›</li>
<li>ä½8ä½æ˜¯å¯¹åº”çš„ç‰©ç†é¡µçš„æ ‡å¿—ä½ï¼š
<ul>
<li><code>V</code> å¯¹åº”ç‰©ç†é¡µæ˜¯å¦æœ‰æ•ˆï¼›</li>
<li><code>R</code>, <code>W</code>, <code>X</code>
è¡¨ç¤ºç‰©ç†é¡µçš„è¯»ï¼Œå†™ï¼Œæ‰§è¡Œï¼›</li>
<li><code>U</code> ä»£è¡¨äº†åœ¨ User Mode ä¸‹æ˜¯å¦æœ‰æƒé™æ‰§è¡Œï¼›</li>
<li><code>G</code></li>
<li><code>A</code> ä»£è¡¨äº†é¡µé¢ä»£è¡¨å¯¹åº”çš„è™šæ‹Ÿé¡µé¢æ˜¯å¦è¢«è®¿é—®è¿‡ï¼Œæ˜¯
<strong><a
href="#å…¨å±€ç‰©ç†å†…å­˜çš„é¡µç½®æ¢ç®—æ³•">å…¨å±€ç‰©ç†å†…å­˜çš„é¡µç½®æ¢ç®—æ³•</a></strong>
çš„æ ¸å¿ƒæ•°æ®ï¼›</li>
<li><code>D</code>
ä»£è¡¨äº†é¡µé¢ä»£è¡¨å¯¹åº”çš„ç‰©ç†é¡µé¢æ˜¯å¦è¢«ä¿®æ”¹è¿‡ï¼Œç”¨äºåˆ¤æ–­ç¼“å­˜æ˜¯å¦å¯ç”¨ã€‚æ­¤å¤–ï¼Œå®ƒå¯ä»¥ååŠ©æˆ‘ä»¬åˆ¤æ–­
<a href="#ä¼˜åŒ–é¡µé¢æ¢å‡º">ä¼˜åŒ–é¡µé¢æ¢å‡º</a>ã€‚</li>
</ul></li>
</ul>
<h3 id="å…¨å±€ç‰©ç†å†…å­˜çš„é¡µç½®æ¢ç®—æ³•">å…¨å±€ç‰©ç†å†…å­˜çš„é¡µç½®æ¢ç®—æ³•</h3>
<p>â€œå…¨å±€ç‰©ç†å†…å­˜çš„é¡µç½®æ¢ç®—æ³•ï¼ˆå¦‚clockï¼ŒäºŒæ¬¡æœºä¼šç®—æ³•ï¼‰â€
æ˜¯ç¼“å­˜æ·˜æ±°çš„æ ¸å¿ƒé€»è¾‘ï¼Œå…·ä½“è§„åˆ™å¯èƒ½å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li>å†…æ ¸æ‰«æé¡µè¡¨ï¼Œæ£€æŸ¥ <code>A</code> ä½ï¼›</li>
<li>æ‰€æœ‰ <code>A</code> ä¸º0çš„é¡µé¢æœ€è¿‘æœªè¢«è®¿é—®è¿‡ï¼Œç›´æ¥æ·˜æ±°ï¼›</li>
<li>å¦‚æœ <code>A</code>
ä¸º1ï¼Œåˆ™é¡µé¢æœ€è¿‘è¢«è®¿é—®è¿‡ï¼Œ<strong>æˆ‘ä»¬æ­¤æ—¶å°†å…¶è®¾ç½®ä¸º0</strong>ï¼›</li>
<li>å†å›åˆ° <code>&lt;1&gt;</code>ï¼Œå¦‚æœ <code>A</code>
ä¸º0ï¼Œåˆ™è¿‘æœŸæœªè®¿é—®ï¼Œè¿›è¡Œæ·˜æ±°ï¼›</li>
</ol>
<p>æ ¸å¿ƒé€»è¾‘åœ¨äºï¼Œ<code>A</code> çš„çŠ¶æ€ä¸º <code>1</code>
åªæ˜¯ä»£è¡¨è¿‡å»æœ‰è¢«è®¿é—®è¿‡ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯æ¬¡éƒ½éœ€è¦é‡ç½®ï¼Œè¿™æ ·åœ¨ä¸‹æ¬¡æ‰«æçš„æ—¶å€™æˆ‘ä»¬å°±çŸ¥é“æœ€è¿‘æœ‰æ²¡æœ‰è¢«è®¿é—®è¿‡ã€‚</p>
<h3 id="ä¼˜åŒ–é¡µé¢æ¢å‡º">ä¼˜åŒ–é¡µé¢æ¢å‡º</h3>
<h4 id="ä¼˜åŒ–é¡µé¢ç½®æ¢">ä¼˜åŒ–é¡µé¢ç½®æ¢</h4>
<blockquote>
<p>D ä½çš„æ ¸å¿ƒä»·å€¼æ˜¯ å‡å°‘ç£ç›˜ I/O
å¼€é”€ï¼ˆè¿™æ˜¯æ“ä½œç³»ç»Ÿä¸­æœ€æ˜‚è´µçš„æ“ä½œä¹‹ä¸€ï¼‰ï¼š</p>
</blockquote>
<p>å½“æˆ‘ä»¬åœ¨è¿›è¡Œå†…å­˜æ“ä½œæ—¶ï¼Œå¹¶ä¸ä¼šç«‹å³æ•°æ®å…¨éƒ¨å†™å…¥åˆ°ç¡¬ç›˜ï¼ˆæˆ–å…¶ä»–I/Oï¼‰ï¼Œè€Œæ˜¯å…ˆä¿®æ”¹å†…å­˜ï¼Œå¹¶ä¸”å°†é¡µè¡¨ä¸­çš„
<code>D</code> è®¾ç½®ä¸º1ã€‚</p>
<p>è€Œå½“æˆ‘ä»¬éœ€è¦è¿›è¡Œé¡µé¢ç½®æ¢ï¼Œæˆ–è€… <code>flush</code>
ä¹‹ç±»çš„æ“ä½œå°†æ•°æ®æ›´æ–°æ—¶ï¼Œ<code>D</code>
ä½å¯ä»¥å¸®æˆ‘ä»¬åˆ¤æ–­ï¼Œå½“å‰å†…å­˜é¡µæ˜¯å¯ä»¥ç›´æ¥é‡Šæ”¾è¿˜æ˜¯éœ€è¦åˆ·æ–°åˆ°ç¡¬ç›˜ï¼</p>
<h4 id="å®ç°cow">å®ç°COW</h4>
<p>å‡è®¾çˆ¶è¿›ç¨‹ P åˆ›å»ºå­è¿›ç¨‹ Cï¼Œå…±äº«æŸç‰©ç†é¡µ
PhysPage(<code>0x100</code>)ï¼Œé¡µè¡¨é¡¹åˆå§‹çŠ¶æ€ï¼šV=1, R=1, W=0, U=1, A=0,
D=0ï¼ˆæœ‰æ•ˆã€å¯è¯»ã€ç¦æ­¢å†™ã€ç”¨æˆ·æ€å¯è®¿é—®ã€æœªè®¿é—®ã€æœªä¿®æ”¹ï¼‰ã€‚</p>
<ol type="1">
<li>è¿›ç¨‹åˆ›å»ºé˜¶æ®µï¼šå…±äº«ç‰©ç†é¡µ + æƒé™åˆå§‹åŒ–
<ul>
<li>çˆ¶è¿›ç¨‹ P çš„é¡µè¡¨ï¼šè™šæ‹Ÿé¡µ VPN=0x200 â†’ ç‰©ç†é¡µ PPN=0x100ï¼ˆW=0ï¼‰ï¼›</li>
<li>å­è¿›ç¨‹ C çš„é¡µè¡¨ï¼šç›¸åŒè™šæ‹Ÿé¡µ VPN=0x200 â†’ ç›¸åŒç‰©ç†é¡µ
PPN=0x100ï¼ˆW=0ï¼‰ï¼›</li>
<li>å†…æ ¸ç»´æŠ¤ â€œç‰©ç†é¡µå¼•ç”¨è®¡æ•°â€ï¼šPhysPage(0x100) çš„å¼•ç”¨è®¡æ•° = 2ï¼ˆP å’Œ C
å…±äº«ï¼‰ï¼›</li>
<li>å…³é”®ï¼šçˆ¶å­è¿›ç¨‹çš„é¡µè¡¨é¡¹éƒ½è®¾ä¸º
W=0ï¼ˆç¦æ­¢å†™ï¼‰ã€D=0ï¼ˆåˆå§‹æ— ä¿®æ”¹ï¼‰ï¼Œç¡®ä¿å†™æ“ä½œè§¦å‘å¼‚å¸¸ã€‚</li>
</ul></li>
<li>å†™æ“ä½œè§¦å‘å¼‚å¸¸ï¼šè¿›å…¥ Trap Handler
<ul>
<li>å‡è®¾å­è¿›ç¨‹ C å°è¯•å†™ VPN=0x200 å¯¹åº”çš„è™šæ‹Ÿé¡µï¼›</li>
<li>å¤„ç†å™¨æ£€æŸ¥é¡µè¡¨é¡¹ï¼šV=1ï¼ˆæœ‰æ•ˆï¼‰ä½† W=0ï¼ˆç¦æ­¢å†™ï¼‰â†’ è§¦å‘å†™ä¿æŠ¤å¼‚å¸¸ï¼ˆStore
Page Faultï¼‰ï¼›</li>
<li>RISC-V ä¼šå°†å¼‚å¸¸åŸå› ï¼ˆcause=0x24ï¼ŒStore Page
Faultï¼‰ã€è§¦å‘å†™æ“ä½œçš„è™šæ‹Ÿåœ°å€ï¼ˆstval=VPN=0x200ï¼‰å­˜å…¥ CSR
å¯„å­˜å™¨ï¼Œè·³è½¬åˆ°å†…æ ¸çš„ Trap Handlerã€‚</li>
</ul></li>
<li>Trap Handler å¤„ç†é€»è¾‘ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰ï¼šHandler éœ€å®Œæˆ â€œè¯†åˆ« COW é¡µ â†’
å¤åˆ¶ç‰©ç†é¡µ â†’ æ›´æ–°é¡µè¡¨ â†’ æ¢å¤æ‰§è¡Œâ€ï¼Œå…·ä½“ï¼š
<ol type="1">
<li>è¯†åˆ«å½“å‰é¡µæ˜¯ COW å…±äº«é¡µ
<ul>
<li>ä» stval å–å‡ºè§¦å‘å¼‚å¸¸çš„è™šæ‹Ÿåœ°å€ VAï¼Œæ‰¾åˆ°å­è¿›ç¨‹ C å¯¹åº”é¡µè¡¨é¡¹ï¼›</li>
<li>æ£€æŸ¥é¡µè¡¨é¡¹ç‰¹å¾ï¼šV=1, W=0, D=0 + ç‰©ç†é¡µ PPN=0x100 çš„å¼•ç”¨è®¡æ•° &gt; 1 â†’
ç¡®è®¤æ˜¯ COW å…±äº«é¡µï¼ˆéæ™®é€šå†™ä¿æŠ¤é¡µï¼‰ã€‚</li>
</ul></li>
<li>åˆ†é…æ–°ç‰©ç†é¡µå¹¶å¤åˆ¶æ•°æ®
<ul>
<li>å†…æ ¸ä»ç©ºé—²ç‰©ç†é¡µæ± åˆ†é…æ–°é¡µ PhysPage(0x101)ï¼›</li>
<li>å°†æ—§é¡µ PhysPage(0x100) çš„æ‰€æœ‰æ•°æ®å¤åˆ¶åˆ°æ–°é¡µ
PhysPage(0x101)ï¼ˆä»…å¤åˆ¶ä¸€æ¬¡ï¼Œå®Œæˆåä¸¤é¡µæ•°æ®å®Œå…¨ä¸€è‡´ï¼‰ã€‚</li>
</ul></li>
<li>æ›´æ–°é¡µè¡¨é¡¹æƒé™å’Œæ ‡å¿—ä½ï¼Œ<strong>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç°åœ¨æ˜¯å†…æ ¸åœ¨è¿›è¡Œå†…å­˜é¡µå¤åˆ¶ï¼Œå¤åˆ¶å‰åçš„ä¸¤ä¸ªå†…å­˜é¡µçš„
<code>D = 0</code>ï¼Œå› ä¸ºæ­¤æ—¶ä»…ä»…åªæ˜¯å¤„ç†Storage Page
Faultï¼ŒçœŸæ­£çš„é¡µé¢æ“ä½œä¸åœ¨è¿™ä¸ªå¼‚å¸¸å¤„ç†çš„èŒƒç•´ä¸­ã€‚</strong></li>
<li>åˆ·æ–° TLBï¼ˆé¿å…æ—§æ˜ å°„å¹²æ‰°ï¼‰</li>
</ol></li>
<li>æ¢å¤è¿›ç¨‹æ‰§è¡Œï¼Œæ­¤æ—¶å†™å…¥æ“ä½œå®Œæˆï¼Œå°†é¡µé¢ <code>D = 1</code>ã€‚</li>
</ol>
<h3 id="å¤šçº§é¡µè¡¨">å¤šçº§é¡µè¡¨</h3>
<h4 id="å•çº§é¡µè¡¨çº¿æ€§è¡¨">å•çº§é¡µè¡¨/çº¿æ€§è¡¨</h4>
<figure>
<img src="/images/20251121/linear-table.png" alt="linear-table.png" />
<figcaption aria-hidden="true">linear-table.png</figcaption>
</figure>
<p>æœ€ç®€å•çš„é¡µè¡¨å®ç°ï¼Œå°±æ˜¯å°†å…¨éƒ¨çš„<strong>VPN -&gt;
PPN</strong>çš„æ˜ å°„å…³ç³»å…¨éƒ¨å­˜å‚¨åˆ°å†…å­˜ä¸­ï¼ŒæŒ‰ç…§æˆ‘ä»¬ç›®å‰çš„RV39ä¸­é¡µå¤§å°4KBï¼Œæˆ‘ä»¬æ€»å…±éœ€è¦
<code>2^27 * 8</code> ä¹Ÿå°±æ˜¯
1GBã€‚å¹¶ä¸”ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½å¿…é¡»æœ‰ä¸€ä¸ªã€‚è¿™æ˜¯å®Œå…¨ä¸å¯æ¥å—çš„ã€‚
<strong>ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ä¸€ä¸ªå¤šçº§é¡µè¡¨</strong>ã€‚</p>
<h4 id="å­—å…¸æ ‘">å­—å…¸æ ‘</h4>
<p>å‡è®¾å­˜åœ¨ä¸€ä¸ªè¾“å…¥å­—ç¬¦é›†ä¸º <code>x = {a, b, c}</code>ï¼Œé•¿åº¦ä¸º
<code>n</code> çš„å­—ç¬¦é›†ï¼Œé‚£ä¹ˆå®ƒçš„ç»“æ„å¯èƒ½å¦‚ä¸‹æ‰€ç¤º</p>
<figure>
<img src="/images/20251121/linear-table.png" alt="linear-table.png" />
<figcaption aria-hidden="true">linear-table.png</figcaption>
</figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸Šé¢æ˜¯ä¸€é¢—å®Œæ•´çš„å­—å…¸æ ‘ï¼Œè€Œåœ¨æˆ‘ä»¬æ„é€ è¿™ä¸ªå­—æ®µæ ‘çš„è¿‡ç¨‹ä¸­ï¼Œæœ€å¼€å§‹æ•´æ£µæ ‘æ˜¯ç©ºçš„ã€‚åªæœ‰å½“æˆ‘ä»¬å†™å…¥åˆ°ä¸€ä¸ªç‰¹å®šçš„å­—ç¬¦æ—¶æ‰ä¼šæœ‰æ–°çš„èŠ‚ç‚¹ç”Ÿæˆã€‚</p>
<figure>
<img src="/images/20251121/trie-1.png" alt="trie-1.png" />
<figcaption aria-hidden="true">trie-1.png</figcaption>
</figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ­¤æ—¶åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p>
<blockquote>
<p><strong>äº‹å®ä¸Š SV39
åˆ†é¡µæœºåˆ¶ç­‰ä»·äºä¸€é¢—å­—å…¸æ ‘</strong>ã€‚<code>27</code> ä½çš„ VPN
å¯ä»¥çœ‹ä½œé•¿åº¦ä¸º <code>3</code> çš„ä¸‰ä¸ªå­—ç¬¦ä¸²ï¼Œå­—ç¬¦é›†ä¸º
<code>x = {0, 1, 2, ..., 511}</code></p>
</blockquote>
<h3 id="å¤§è¡¨">å¤§è¡¨</h3>
<blockquote>
<p><code>RV39</code> æ”¯æŒå¤§è¡¨æŸ¥æ‰¾å’Œè®¿é—®ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹</p>
</blockquote>
<ol type="1">
<li>è™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰ç»“æ„ï¼š39 ä½æœ‰æ•ˆä½ï¼Œæ‹†åˆ†ä¸º 4 éƒ¨åˆ†ï¼š
<ul>
<li>é«˜ä½ 2 ä½ï¼šä¿ç•™ï¼ˆå¿…é¡»ä¸º 0ï¼Œå¦åˆ™ä¸ºéæ³•åœ°å€ï¼‰ï¼›</li>
<li>VPN [2]ï¼šä¸€çº§é¡µè¡¨ç´¢å¼•ï¼ˆ9 ä½ï¼Œå¯¹åº”ä¸€çº§é¡µè¡¨é¡¹ä½ç½®ï¼‰ï¼›</li>
<li>VPN [1]ï¼šäºŒçº§é¡µè¡¨ç´¢å¼•ï¼ˆ9 ä½ï¼Œå¯¹åº”äºŒçº§é¡µè¡¨é¡¹ä½ç½®ï¼‰ï¼›</li>
<li>VPN [0]ï¼šä¸‰çº§é¡µè¡¨ç´¢å¼•ï¼ˆ9 ä½ï¼Œå¯¹åº”ä¸‰çº§é¡µè¡¨é¡¹ä½ç½®ï¼‰ï¼›</li>
</ul></li>
<li>é¡µè¡¨é¡¹ï¼ˆPTEï¼‰ç»“æ„ï¼š64 ä½ï¼Œä½ 8 ä½ä¸ºæ ‡å¿—ä½ï¼ˆV/R/W/X/U/A/D/Gï¼‰ï¼Œé«˜ 56
ä½ä¸ºç‰©ç†é¡µå·ï¼ˆPPNï¼‰æˆ–ä¸‹ä¸€çº§é¡µè¡¨çš„ PPNï¼ˆå›  Sv39 ç‰©ç†åœ°å€æœ€å¤§ 56
ä½ï¼‰ã€‚</li>
<li>æ ¸å¿ƒæ ‡å¿—ä½ V çš„è¯­ä¹‰
<ul>
<li>V=1ï¼šé¡µè¡¨é¡¹æœ‰æ•ˆï¼ˆValidï¼‰ï¼Œæ˜¯ â€œåˆæ³•çš„é¡µè¡¨é¡¹â€ï¼ˆå¯èƒ½æ˜¯ â€œæŒ‡å‘ä¸‹çº§é¡µè¡¨â€
çš„é¡µç›®å½•é¡¹ï¼Œä¹Ÿå¯èƒ½æ˜¯ â€œæŒ‡å‘ç‰©ç†é¡µâ€ çš„å¶èŠ‚ç‚¹é¡¹ï¼Œæˆ– â€œå¤§é¡µæ˜ å°„â€ é¡¹ï¼‰ï¼›</li>
<li>V=0ï¼šé¡µè¡¨é¡¹æ— æ•ˆï¼Œè®¿é—®æ—¶è§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼ˆPage Faultï¼‰</li>
</ul></li>
</ol>
<table>
<colgroup>
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 25%" />
<col style="width: 41%" />
<col style="width: 12%" />
</colgroup>
<thead>
<tr class="header">
<th>å¤§é¡µçº§åˆ«</th>
<th>å¶èŠ‚ç‚¹é¡µè¡¨é¡¹</th>
<th>æ˜ å°„ç²’åº¦</th>
<th>VA ä¸­ â€œç”¨äºåç§»â€ çš„ä½æ•°</th>
<th>å¯¹åº”èŒƒå›´</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>4KB é¡µ</td>
<td>ä¸‰çº§é¡µé¡¹</td>
<td>4KB = 2^12</td>
<td>12 ä½ï¼ˆä»… Offsetï¼‰</td>
<td>å•ä¸ª 4KB é¡µ</td>
</tr>
<tr class="even">
<td>2MB å¤§é¡µ</td>
<td>äºŒçº§é¡µè¡¨</td>
<td>2MB = 2^(9+12)</td>
<td>9ï¼ˆVPN [0]ï¼‰+12=21 ä½</td>
<td>2MB</td>
</tr>
<tr class="odd">
<td>1GB å¤§é¡µ</td>
<td>ä¸€çº§é¡µè¡¨</td>
<td>1GB = 2^(9+9+12)</td>
<td>9ï¼ˆVPN [1]ï¼‰+9ï¼ˆVPN [0]ï¼‰+12=30 ä½</td>
<td>1GB</td>
</tr>
</tbody>
</table>
<h3 id="sv39è½¬æ¢è¿‡ç¨‹">SV39è½¬æ¢è¿‡ç¨‹</h3>
<figure>
<img src="/images/20251121/sv39-full.png" alt="sv39-full.png" />
<figcaption aria-hidden="true">sv39-full.png</figcaption>
</figure>
<h3 id="å†…å­˜ç®¡ç†çš„ä¸€äº›ç¤ºä¾‹">å†…å­˜ç®¡ç†çš„ä¸€äº›ç¤ºä¾‹</h3>
<blockquote>
<p>å†…å­˜ç®¡ç†çš„å®Œå…¨æŠ½è±¡</p>
</blockquote>
<figure>
<img src="/images/20251121/address-translation.png"
alt="address translation" />
<figcaption aria-hidden="true">address translation</figcaption>
</figure>
<h4 id="åˆ†æ®µå†…å­˜ç®¡ç†">åˆ†æ®µå†…å­˜ç®¡ç†</h4>
<blockquote>
<p>åˆ†æ®µå†…å­˜ç®¡ç†ä¸€ï¼šä½¿ç”¨å›ºå®šå†…å­˜å¤§å°åŠç‰©ç†SLOTè¿›è¡Œæ˜ å°„</p>
</blockquote>
<figure>
<img src="/images/20251121/simple-base-bound.png"
alt="simple-base-bound" />
<figcaption aria-hidden="true">simple-base-bound</figcaption>
</figure>
<p>æ¯ä¸ªåº”ç”¨çš„åœ°å€ç©ºé—´å¤§å°é™åˆ¶ä¸ºä¸€ä¸ªå›ºå®šçš„å¸¸æ•° bound
ï¼Œä¹Ÿå³æ¯ä¸ªåº”ç”¨çš„å¯ç”¨è™šæ‹Ÿåœ°å€åŒºé—´å‡ä¸º
<code>[0, bound)</code>ã€‚éšåï¼Œå°±å¯ä»¥ä»¥è¿™ä¸ªå¤§å°ä¸ºå•ä½ï¼Œå°†ç‰©ç†å†…å­˜é™¤äº†å†…æ ¸é¢„ç•™ç©ºé—´ä¹‹å¤–çš„éƒ¨åˆ†åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªå¤§å°ç›¸åŒçš„<strong>æ’æ§½
(Slot)</strong>
ï¼Œæ¯ä¸ªåº”ç”¨çš„æ‰€æœ‰æ•°æ®éƒ½è¢«å†…æ ¸æ”¾ç½®åœ¨å…¶ä¸­ä¸€ä¸ªæ’æ§½ä¸­ï¼Œå¯¹åº”äºç‰©ç†å†…å­˜ä¸Šçš„ä¸€æ®µè¿ç»­ç‰©ç†åœ°å€åŒºé—´ï¼Œå‡è®¾å…¶èµ·å§‹ç‰©ç†åœ°å€ä¸º
<code>base</code>ï¼Œåˆ™ç”±äºäºŒè€…å¤§å°ç›¸åŒï¼Œè¿™ä¸ªåŒºé—´å®é™…ä¸º
<code>[base, base + bound)</code>ã€‚</p>
<pre><code class="highlight mermaid">flowchart LR
    %% æ ·å¼å®šä¹‰ï¼ˆåŒºåˆ†å†…å­˜åŒºåŸŸã€ç¢ç‰‡ã€æ˜ å°„å…³ç³»ï¼‰
    classDef app_seg fill:#e8f4f8, stroke:#2563eb, rounded:8px, font-weight:600, font-size:12px;
    classDef phys_seg fill:#f0f8fb, stroke:#0ea5e9, rounded:8px, font-weight:600, font-size:12px;
    classDef fragment fill:#fef2f8, stroke:#f43f5e, rounded:8px, color:#be123c, font-size:11px;
    classDef arrow stroke:#64748b, stroke-width:1.5px, font-size:11px;
    classDef title fill:#1e293b, font-weight:bold, font-size:14px;
    classDef slot fill:#f8fafc, stroke:#94a3b8, rounded:8px, font-weight:600, font-size:12px;


    subgraph åº”ç”¨é€»è¾‘å†…å­˜
        app_text[&quot;.text æ®µ&lt;br/&gt;(ä»£ç åŒº)&quot;]:::app_seg
        app_data[&quot;.data æ®µ&lt;br/&gt;(æ•°æ®åŒº)&quot;]:::app_seg
        app_stack[&quot;stack æ®µ&lt;br/&gt;(æ ˆåŒº)&quot;]:::app_seg
        app_heap[&quot;heap æ®µ&lt;br/&gt;(å †åŒº)&quot;]:::app_seg
    end

    subgraph ç‰©ç†å†…å­˜
        subgraph å·²åˆ†é…
            phys_text[&quot;.text æ®µ&lt;br/&gt;&#123;base ~ base+text_size&#125;&quot;]:::phys_seg
            frag1[&quot;å†…ç¢ç‰‡1&lt;br/&gt;&#123;æœªä½¿ç”¨&#125;&quot;]:::fragment
            phys_data[&quot;.data æ®µ&lt;br/&gt;&#123;base+text_size+frag1_size ~ ...&#125;&quot;]:::phys_seg
            frag2[&quot;å†…ç¢ç‰‡2&lt;br/&gt;(æœªä½¿ç”¨)&quot;]:::fragment
            phys_stack[&quot;stack æ®µ&lt;br/&gt;(... ~ ...)&quot;]:::phys_seg
            frag3[&quot;å†…ç¢ç‰‡3&lt;br/&gt;(æœªä½¿ç”¨)&quot;]:::fragment
            phys_heap[&quot;heap æ®µ&lt;br/&gt;(... ~ base+bound)&quot;]:::phys_seg
        end
        slot1_idle[&quot;æœªåˆ†é…&lt;br/&gt;(å¯å®¹çº³å…¶ä»–åº”ç”¨)&quot;]:::slot
        slot2_idle[&quot;æœªåˆ†é…&lt;br/&gt;(å¯å®¹çº³å…¶ä»–åº”ç”¨)&quot;]:::slot

    end

    app_text --&gt; phys_text
    app_text -.-&gt;|ç›´æ¥æ˜ å°„| phys_text
    app_data -.-&gt;|ç›´æ¥æ˜ å°„| phys_data
    app_stack -.-&gt;|ç›´æ¥æ˜ å°„| phys_stack
    app_heap -.-&gt;|ç›´æ¥æ˜ å°„| phys_heap</code></pre>
<blockquote>
<p>åˆ†æ®µå†…å­˜ç®¡ç†äºŒï¼šä½¿ç”¨åº”ç”¨åœ°å€ç©ºé—´ä¸­çš„ä¸€ä¸ªé€»è¾‘æ®µä½œä¸ºå•ä½æ¥å®‰æ’åº”ç”¨çš„æ•°æ®åœ¨ç‰©ç†å†…å­˜ä¸­çš„å¸ƒå±€</p>
</blockquote>
<figure>
<img src="/images/20251121/segmentation.png" alt="segmentation" />
<figcaption aria-hidden="true">segmentation</figcaption>
</figure>
<p>ç›¸å¯¹äºåˆ†æ®µå†…å­˜ç®¡ç†ä¸€ä¸­çš„å†…å­˜åˆ†é…æ–¹å¼ï¼Œè¿™ç§æ–¹å¼ä¸æ˜¯å°†åº”ç”¨çš„æ•´ä¸ªå†…å­˜ç©ºé—´ç›´æ¥æ˜ å°„åˆ°ç‰©ç†å†…å­˜ã€‚
è€Œæ˜¯å°†åº”ç”¨çš„ç‰©ç†å†…å­˜æŒ‰ç…§ <code>.text</code>, <code>.data</code>,
<code>stack</code>, <code>heap</code>
ç­‰é€»è¾‘æ®µæŒ‰ç…§ä¸€å®šçš„è§„åˆ™æ˜ å°„åˆ°ç‰©ç†å†…å­˜ã€‚</p>
<p>æ³¨æ„åˆ°æ¯ä¸ªæ®µéƒ½åªä¼šåœ¨å†…å­˜ä¸­å æ®ä¸€å—ä¸å®ƒå®é™…æ‰€ç”¨åˆ°çš„å¤§å°ç›¸ç­‰çš„ç©ºé—´ã€‚å †çš„æƒ…å†µå¯èƒ½æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒçš„å¤§å°å¯èƒ½ä¼šåœ¨è¿è¡Œæ—¶å¢é•¿ï¼Œä½†æ˜¯é‚£éœ€è¦åº”ç”¨é€šè¿‡ç³»ç»Ÿè°ƒç”¨å‘å†…æ ¸è¯·æ±‚ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™æ˜¯ä¸€ç§æŒ‰éœ€åˆ†é…ï¼Œè€Œä¸å†æ˜¯å†…æ ¸åœ¨å¼€å§‹æ—¶å°±ç»™æ¯ä¸ªåº”ç”¨åˆ†é…ä¸€å¤§å—å¾ˆå¯èƒ½ç”¨ä¸å®Œçš„å†…å­˜ã€‚ç”±æ­¤ï¼Œä¸å†æœ‰å†…ç¢ç‰‡äº†ã€‚</p>
<p>å°½ç®¡å†…ç¢ç‰‡è¢«æ¶ˆé™¤äº†ï¼Œä½†å†…å­˜æµªè´¹é—®é¢˜å¹¶æ²¡æœ‰å®Œå…¨è§£å†³ã€‚è¿™æ˜¯å› ä¸ºæ¯ä¸ªæ®µçš„å¤§å°éƒ½æ˜¯ä¸åŒçš„ï¼ˆå®ƒä»¬å¯èƒ½æ¥è‡ªä¸åŒçš„åº”ç”¨ï¼ŒåŠŸèƒ½ä¹Ÿä¸åŒï¼‰ï¼Œå†…æ ¸å°±éœ€è¦ä½¿ç”¨æ›´åŠ é€šç”¨ã€ä¹Ÿæ›´åŠ å¤æ‚çš„è¿ç»­å†…å­˜åˆ†é…ç®—æ³•æ¥è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œè€Œä¸èƒ½åƒä¹‹å‰çš„æ’æ§½é‚£æ ·ä»¥ä¸€ä¸ªæ¯”ç‰¹ä¸ºå•ä½ã€‚é¡¾åæ€ä¹‰ï¼Œè¿ç»­å†…å­˜åˆ†é…ç®—æ³•å°±æ˜¯æ¯æ¬¡éœ€è¦åˆ†é…ä¸€å—è¿ç»­å†…å­˜æ¥å­˜æ”¾ä¸€ä¸ªæ®µçš„æ•°æ®ã€‚éšç€ä¸€æ®µæ—¶é—´çš„åˆ†é…å’Œå›æ”¶ï¼Œç‰©ç†å†…å­˜è¿˜å‰©ä¸‹ä¸€äº›ç›¸äº’ä¸è¿ç»­çš„è¾ƒå°çš„å¯ç”¨è¿ç»­å—ï¼Œå…¶ä¸­æœ‰ä¸€äº›åªæ˜¯ä¸¤ä¸ªå·²åˆ†é…å†…å­˜å—ä¹‹é—´çš„å¾ˆå°çš„é—´éš™ï¼Œå®ƒä»¬è‡ªå·±å¯èƒ½ç”±äºç©ºé—´è¾ƒå°ï¼Œå·²ç»æ— æ³•è¢«ç”¨äºåˆ†é…ï¼Œè¿™å°±æ˜¯<code>å¤–ç¢ç‰‡ (External Fragment)</code>
ã€‚</p>
<pre><code class="highlight mermaid">flowchart LR
    %% æ ·å¼å®šä¹‰ï¼ˆåŒºåˆ†åº”ç”¨ã€ç©ºé—²å†…å­˜ã€å¤–ç¢ç‰‡ã€ç®­å¤´ï¼‰
    classDef app fill:#e8f4f8, stroke:#2563eb, rounded:8px, font-weight:600, font-size:12px;
    classDef free fill:#e8f5e8, stroke:#2e7d32, rounded:8px, font-weight:600, font-size:12px;
    classDef frag fill:#fef2f8, stroke:#f43f5e, rounded:8px, color:#be123c, font-size:12px;
    classDef arrow stroke:#64748b, stroke-width:1.5px, font-size:11px;
    classDef note fill:#1e293b, font-weight:bold, font-size:14px;

    %% æ­¥éª¤1ï¼šåˆå§‹çŠ¶æ€ï¼ˆç‰©ç†å†…å­˜è¿ç»­ç©ºé—²ï¼‰
    subgraph Step1[&quot;åˆå§‹çŠ¶æ€&quot;]
        total_free[&quot;ç‰©ç†å†…å­˜&lt;br/&gt;[0 ~ 1024MB] è¿ç»­ç©ºé—²&quot;]:::free
    end
    style Step1 font-weight:bold, font-size:14px, fill:#f8fafc, stroke:#e2e8f0, padding:10px;

    %% æ­¥éª¤2ï¼šåˆ†é…å¤šä¸ªä¸è¿ç»­åº”ç”¨ï¼ˆå ç”¨éƒ¨åˆ†å†…å­˜ï¼‰
    subgraph Step2[&quot;åˆ†é…åº”ç”¨&quot;]
        direction TB
        app1[&quot;App1 (200MB)&lt;br/&gt;&#123;0 ~ 200MB&#125;&quot;]:::app
        app2[&quot;App2 (300MB)&lt;br/&gt;&#123;300 ~ 600MB&#125;&quot;]:::app
        app3[&quot;App3 (150MB)&lt;br/&gt;&#123;700 ~ 850MB&#125;&quot;]:::app
        free1[&quot;ç©ºé—²å—1 (100MB)&lt;br/&gt;&#123;200 ~ 300MB&#125;&quot;]:::free
        free2[&quot;ç©ºé—²å—2 (100MB)&lt;br/&gt;&#123;600 ~ 700MB&#125;&quot;]:::free
        free3[&quot;ç©ºé—²å—3 (174MB)&lt;br/&gt;&#123;850 ~ 1024MB&#125;&quot;]:::free

        app1 --&gt; free1 --&gt; app2 --&gt; free2 --&gt; app3 --&gt; free3
    end
    style Step2 font-weight:bold, font-size:14px, fill:#f8fafc, stroke:#e2e8f0, padding:10px;

    %% æ­¥éª¤3ï¼šé‡Šæ”¾éƒ¨åˆ†åº”ç”¨ï¼ˆäº§ç”Ÿç¦»æ•£ç©ºé—²å—ï¼‰
    subgraph Step3[&quot;Step 3: é‡Šæ”¾åº”ç”¨ - ç©ºé—²å—åˆ†æ•£&quot;]
        direction TB
        app3_1[&quot;App1 (200MB)&lt;br/&gt;&#123;0 ~ 200MB&#125;&quot;]:::app
        free3_1[&quot;ç©ºé—²å—1 (100MB)&lt;br/&gt;&#123;200 ~ 300MB&#125;&quot;]:::free
        free3_2[&quot;ç©ºé—²å—2 (400MB)&lt;br/&gt;&#123;300 ~ 700MB&#125; â†’ é‡Šæ”¾App2&quot;]:::free
        app3_3[&quot;App3 (150MB)&lt;br/&gt;&#123;700 ~ 850MB&#125;&quot;]:::app
        free3_3[&quot;ç©ºé—²å—3 (174MB)&lt;br/&gt;&#123;850 ~ 1024MB&#125;&quot;]:::free
        app3_1 --&gt; free3_1 --&gt; free3_2 --&gt; app3_3 --&gt; free3_3
    end
    style Step3 font-weight:bold, font-size:14px, fill:#f8fafc, stroke:#e2e8f0, padding:10px;

    %% æ­¥éª¤4ï¼šå¤–ç¢ç‰‡äº§ç”Ÿï¼ˆæ€»ç©ºé—²è¶³å¤Ÿä½†ç¦»æ•£ï¼Œæ— æ³•åˆ†é…ï¼‰
    subgraph Step4[&quot;å¤–ç¢ç‰‡å½¢æˆ&quot;]
        direction LR
        app41[&quot;App1 (200MB)&lt;br/&gt;&#123;0 ~ 200MB&#125;&quot;]:::app
        frag41[&quot;å¤–ç¢ç‰‡1 (100MB)&lt;br/&gt;&#123;200 ~ 300MB&#125;&quot;]:::frag
        frag42[&quot;å¤–ç¢ç‰‡2 (400MB)&lt;br/&gt;&#123;300 ~ 700MB&#125;&quot;]:::frag
        app43[&quot;App3 (150MB)&lt;br/&gt;&#123;700 ~ 850MB&#125;&quot;]:::app
        frag43[&quot;å¤–ç¢ç‰‡3 (174MB)&lt;br/&gt;&#123;850 ~ 1024MB&#125;&quot;]:::frag
        new_app[&quot;æ–°åº”ç”¨éœ€æ±‚ï¼š500MB è¿ç»­å†…å­˜&lt;br/&gt;â†’ æ€»ç©ºé—²674MBï¼Œä½†æ— è¿ç»­å— â†’ åˆ†é…å¤±è´¥&quot;]:::app
    end
    style Step4 font-weight:bold, font-size:14px, fill:#f8fafc, stroke:#e2e8f0, padding:10px;

    %% æµç¨‹è¿æ¥ï¼ˆæ—¶é—´çº¿é¡ºåºï¼‰
    Step1 --&gt; Step2:::arrow
    Step2 --&gt; Step3:::arrow
    Step3 --&gt; Step4:::arrow

    %% æ ¸å¿ƒåŸå› æ ‡æ³¨
    Note[&quot;å¤–ç¢ç‰‡æ ¸å¿ƒæˆå› ï¼š&lt;br/&gt;1. å¤šæ¬¡åˆ†é…/é‡Šæ”¾åï¼Œç©ºé—²å†…å­˜è¢«å·²åˆ†é…åº”ç”¨åˆ†å‰²æˆç¦»æ•£å—ï¼›&lt;br/&gt;2. æ€»ç©ºé—²å†…å­˜å¤§å°è¶³å¤Ÿï¼Œä½†æ— å•ä¸ªè¿ç»­å—æ»¡è¶³æ–°åº”ç”¨çš„è¿ç»­å†…å­˜éœ€æ±‚ï¼›&lt;br/&gt;3. ç¢ç‰‡æ— æ³•è¢«ç›´æ¥åˆ©ç”¨ï¼Œå¯¼è‡´å†…å­˜æµªè´¹ã€‚&quot;]:::note
    style Note fill:#f8fafc, stroke:#94a3b8, padding:10px, rounded:8px, font-size:13px;</code></pre>
<h4 id="åˆ†é¡µå†…å­˜ç®¡ç†">åˆ†é¡µå†…å­˜ç®¡ç†</h4>
<p>ä¹‹å‰çš„ä¸¤ç§åˆ†æ®µç®¡ç†çš„æ–¹å¼ï¼š</p>
<ul>
<li>å°†åº”ç”¨å†…å­˜çœ‹åšä¸€ä¸ªæ•´ä½“ï¼šç”±äºåº”ç”¨å†…éƒ¨æ®µçš„ä¸è¿ç»­æ€§ï¼Œå°†äº§ç”Ÿå¤§é‡çš„å†…ç¢ç‰‡ï¼›</li>
<li>å°†åº”ç”¨å†…å­˜åˆ†ä¸ºå¤šä¸ªé€»è¾‘æ®µï¼Œå¹¶æŒ‰æ®µè¿›è¡Œæ˜ å°„ï¼šåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨ç»è¿‡å¤šæ¬¡åˆ†é…å’Œé‡Šæ”¾åç©ºé—²å†…å­˜å°†åˆ†æ•£åœ¨ç‰©ç†å†…å­˜ä¸­æ— æ³•ç»Ÿä¸€çš„ä½¿ç”¨ã€‚ä¾‹å¦‚å‡è®¾æˆ‘ä»¬å­˜åœ¨ä¸€ä¸ªå†…å­˜å—
<code>[0, 1, 2, 3, 4]</code>ï¼š
<ul>
<li>å°†äº”ä¸ªå†…å­˜å—éƒ½åˆ†é…ï¼Œæ­¤æ—¶ä½¿ç”¨çš„å†…å­˜å—ä¸º
<code>[0, 1, 2, 3, 4]</code>ï¼›</li>
<li>é‡Šæ”¾å†…å­˜å—
<code>0</code>ï¼Œ<code>2</code>ï¼Œ<code>4</code>ï¼Œæ­¤æ—¶ä½¿ç”¨çš„å†…å­˜å—ä¸º
<code>[1, 3]</code>ï¼Œè€Œç©ºé—²çš„å†…å­˜å—ä¸º <code>[0, 2, 4]</code>ï¼›</li>
<li>æ­¤æ—¶å¦‚æœåˆ†é…ä¸€ä¸ªéœ€è¦ä¸¤ä¸ªå†…å­˜å—çš„åº”ç”¨ï¼Œæˆ‘ä»¬å†…å­˜å°†åˆ†é…å¤±è´¥ã€‚</li>
</ul></li>
</ul>
<p>è‹¥è¦ç»“åˆäºŒè€…çš„ä¼˜ç‚¹çš„è¯ï¼Œå°±éœ€è¦å†…æ ¸å§‹ç»ˆä»¥ä¸€ä¸ª<strong>åŒæ ·å¤§å°çš„å•ä½æ¥åœ¨ç‰©ç†å†…å­˜</strong>ä¸Šæ”¾ç½®åº”ç”¨åœ°å€ç©ºé—´ä¸­çš„æ•°æ®ï¼š</p>
<ol type="1">
<li>è¿™æ ·å†…æ ¸å°±å¯ä»¥ä½¿ç”¨ç®€å•çš„æ’æ§½å¼å†…å­˜ç®¡ç†ï¼Œä½¿å¾—å†…å­˜åˆ†é…ç®—æ³•æ¯”è¾ƒç®€å•ä¸”ä¸ä¼šäº§ç”Ÿå¤–ç¢ç‰‡ï¼›</li>
<li>åŒæ—¶ï¼Œè¿™ä¸ªå•ä½çš„å¤§å°è¦è¶³å¤Ÿå°ï¼Œä»è€Œå…¶å†…éƒ¨æ²¡æœ‰è¢«ç”¨åˆ°çš„å†…ç¢ç‰‡çš„å¤§å°ä¹Ÿè¶³å¤Ÿå°ï¼Œå°½å¯èƒ½æé«˜å†…å­˜åˆ©ç”¨ç‡ã€‚</li>
</ol>
<p>è¿™ä¾¿æ˜¯æˆ‘ä»¬å°†è¦ä»‹ç»çš„åˆ†é¡µå†…å­˜ç®¡ç†ï¼Œæ€»ä½“çš„æ€æƒ³å°±æ˜¯ï¼š</p>
<ol type="1">
<li>å‡è®¾æˆ‘ä»¬æ¯ä¸ªä»£ç å—çš„å¤§å°æ˜¯ <code>M</code>ï¼Œåº”ç”¨å†…å­˜å¤§å°ä¸º
<code>AM</code>ï¼Œç‰©ç†å†…å­˜å¤§å°ä¸º <code>PM</code>ï¼›</li>
<li>é‚£ä¹ˆåº”ç”¨å¯ä»¥åˆ†ä¸º <code>AM / M</code> ä¸ªä»£ç å—ï¼Œç‰©ç†å†…å­˜å¯ä»¥åˆ†ä¸º
<code>PM / M</code> ä¸ªä»£ç å—ï¼›</li>
<li>æˆ‘ä»¬é€šè¿‡æŸäº›æ–¹å¼ï¼ˆé¡µè¡¨ï¼ŒMMU,TLBç­‰ï¼‰ï¼Œå°†åº”ç”¨çš„ä»£ç å—æ˜ å°„åˆ°ç‰©ç†å†…å­˜çš„ä»£ç å—ï¼›</li>
</ol>
<p>å¸¦æ¥çš„é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥æ›´ä¸ºå¤æ‚çš„ç¡¬ä»¶ç»“æ„è¾…åŠ©æˆ‘ä»¬æ˜ å°„åº”ç”¨å†…å­˜åˆ°ç‰©ç†å†…å­˜ã€‚</p>
<figure>
<img src="/images/20251121/page-table.png" alt="page-table.png" />
<figcaption aria-hidden="true">page-table.png</figcaption>
</figure>
<h3 id="ä»£ç æ¦‚è¿°">ä»£ç æ¦‚è¿°</h3>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~/code/2025a-rcore-0x822a5b87 git:(ch4) cloc --include-ext=rs,s,S,asm os</span><br><span class="line"><span class="code">     152 text files.</span></span><br><span class="line"><span class="code">     121 unique files.                              </span></span><br><span class="line"><span class="code">     126 files ignored.</span></span><br><span class="line"></span><br><span class="line"><span class="section">github.com/AlDanial/cloc v 1.82  T=0.01 s (2328.7 files/s, 184956.7 lines/s)</span></span><br><span class="line"><span class="section">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="section">Language                     files          blank        comment           code</span></span><br><span class="line"><span class="section">-------------------------------------------------------------------------------</span></span><br><span class="line">Rust                            29            193            386           1866</span><br><span class="line"><span class="section">Assembly                         4             10             26            140</span></span><br><span class="line"><span class="section">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="section">SUM:                            33            203            412           2006</span></span><br><span class="line"><span class="section">-------------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>
<h3 id="ä»£ç ä¿®æ”¹">ä»£ç ä¿®æ”¹</h3>
<pre><code class="highlight mermaid">flowchart LR
%% æ ·å¼å®šä¹‰ï¼šåŒºåˆ†ç›®å½•ã€æ–°å¢æ–‡ä»¶ã€ä¿®æ”¹æ–‡ä»¶ã€æ™®é€šæ–‡ä»¶
    classDef dir fill:#e0f7fa, stroke:#00695c, rounded:8px, font-weight:bold, font-size:13px;
    classDef new_file fill:#e8f5e8, stroke:#2e7d32, rounded:6px, font-size:12px, color:#1b5e20;
    classDef modified fill:#fff3e0, stroke:#ef6c00, rounded:6px, font-size:12px, color:#e65100;
    classDef normal_file fill:#f5f5f5, stroke:#78909c, rounded:6px, font-size:12px;

    root[&quot;os/&quot;]:::dir
    os_src[&quot;src/&quot;]:::dir

%% ä¸€çº§æ–‡ä»¶ï¼ˆsrc ç›®å½•ä¸‹ï¼‰
    config[&quot;config.rs&lt;br/&gt;(ä¿®æ”¹ï¼šæ–°å¢å†…å­˜ç®¡ç†é…ç½®)&quot;]:::modified
    linker[&quot;linker.ld&lt;br/&gt;(ä¿®æ”¹ï¼šå¼•å…¥è·³æ¿é¡µ)&quot;]:::modified
    loader[&quot;loader.rs&lt;br/&gt;(ä¿®æ”¹ï¼šä¿ç•™åº”ç”¨æ•°æ®åŠŸèƒ½)&quot;]:::modified
    main[&quot;main.rs&lt;br/&gt;(ä¿®æ”¹)&quot;]:::modified
    src_other[&quot;...&quot;]:::normal_file

%% æ–°å¢ mm å­æ¨¡å—
    mm[&quot;mm/&lt;br/&gt;(æ–°å¢ï¼šå†…å­˜ç®¡ç†å­æ¨¡å—)&quot;]:::dir
    mm_address[&quot;address.rs&lt;br/&gt;(ç‰©ç†/è™šæ‹Ÿåœ°å€æŠ½è±¡)&quot;]:::new_file
    mm_frame[&quot;frame_allocator.rs&lt;br/&gt;(ç‰©ç†é¡µå¸§åˆ†é…å™¨)&quot;]:::new_file
    mm_heap[&quot;heap_allocator.rs&lt;br/&gt;(å†…æ ¸åŠ¨æ€å†…å­˜åˆ†é…å™¨)&quot;]:::new_file
    mm_memory_set[&quot;memory_set.rs&lt;br/&gt;(åœ°å€ç©ºé—´ç›¸å…³)&quot;]:::new_file
    mm_mod[&quot;mod.rs&lt;br/&gt;(mm æ¨¡å—åˆå§‹åŒ–)&quot;]:::new_file
    mm_page_table[&quot;page_table.rs&lt;br/&gt;(å¤šçº§é¡µè¡¨æŠ½è±¡)&quot;]:::new_file

%% syscall å­æ¨¡å—
    syscall[&quot;syscall/&quot;]:::dir
    syscall_fs[&quot;fs.rs&lt;br/&gt;(ä¿®æ”¹ï¼šåŸºäºåœ°å€ç©ºé—´çš„ sys_write)&quot;]:::modified
    syscall_mod[&quot;mod.rs&quot;]:::normal_file
    syscall_process[&quot;process.rs&quot;]:::normal_file

%% task å­æ¨¡å—
    task[&quot;task/&quot;]:::dir
    task_context[&quot;context.rs&lt;br/&gt;(ä¿®æ”¹ï¼šæ„é€ åˆå§‹ä»»åŠ¡ä¸Šä¸‹æ–‡)&quot;]:::modified
    task_mod[&quot;mod.rs&lt;br/&gt;(ä¿®æ”¹ï¼Œè¯¦è§æ–‡æ¡£)&quot;]:::modified
    task_switch[&quot;switch.rs&quot;]:::normal_file
    task_switch_S[&quot;switch.S&quot;]:::normal_file
    task_task[&quot;task.rs&lt;br/&gt;(ä¿®æ”¹ï¼Œè¯¦è§æ–‡æ¡£)&quot;]:::modified

%% trap å­æ¨¡å—
    trap[&quot;trap/&quot;]:::dir
    trap_context[&quot;context.rs&lt;br/&gt;(ä¿®æ”¹ï¼šæ‰©å±• Trap ä¸Šä¸‹æ–‡)&quot;]:::modified
    trap_mod[&quot;mod.rs&lt;br/&gt;(ä¿®æ”¹ï¼šåŸºäºåœ°å€ç©ºé—´çš„ Trap æœºåˆ¶)&quot;]:::modified
    trap_S[&quot;trap.S&lt;br/&gt;(ä¿®æ”¹ï¼šTrap ä¸Šä¸‹æ–‡ä¿å­˜/æ¢å¤)&quot;]:::modified

%% å±‚çº§è¿æ¥
    root --&gt; os_src
    os_src --&gt; config
    os_src --&gt; linker
    os_src --&gt; loader
    os_src --&gt; main
    os_src --&gt; src_other
    os_src --&gt; mm
    os_src --&gt; syscall
    os_src --&gt; task
    os_src --&gt; trap

%% mm å­æ¨¡å—è¿æ¥
    mm --&gt; mm_address
    mm --&gt; mm_frame
    mm --&gt; mm_heap
    mm --&gt; mm_memory_set
    mm --&gt; mm_mod
    mm --&gt; mm_page_table

%% syscall å­æ¨¡å—è¿æ¥
    syscall --&gt; syscall_fs
    syscall --&gt; syscall_mod
    syscall --&gt; syscall_process

%% task å­æ¨¡å—è¿æ¥
    task --&gt; task_context
    task --&gt; task_mod
    task --&gt; task_switch
    task --&gt; task_switch_S
    task --&gt; task_task

%% trap å­æ¨¡å—è¿æ¥
    trap --&gt; trap_context
    trap --&gt; trap_mod
    trap --&gt; trap_S</code></pre>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/rust/" rel="tag"># rust</a>
              <a href="/tags/os/" rel="tag"># os</a>
              <a href="/tags/memory/" rel="tag"># memory</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/11/18/ucore%E5%88%86%E6%97%B6%E4%BB%BB%E5%8A%A1/" rel="prev" title="uCoreåˆ†æ—¶ä»»åŠ¡">
                  <i class="fa fa-angle-left"></i> uCoreåˆ†æ—¶ä»»åŠ¡
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/12/02/ucore%E8%BF%9B%E7%A8%8B%E5%8F%8A%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/" rel="next" title="uCoreè¿›ç¨‹åŠè¿›ç¨‹ç®¡ç†">
                  uCoreè¿›ç¨‹åŠè¿›ç¨‹ç®¡ç† <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">2183814023</span>
  </div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"0x822a5b87/blog-comments","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js" defer></script>

</body>
</html>
